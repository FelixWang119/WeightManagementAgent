# 教练主动提示 - SSE前端实现架构

**文档版本**: 1.0  
**创建日期**: 2026-02-17  
**状态**: 技术架构设计  
**关联文档**: [教练主动提示技术方案](coaching-active-prompt-technical.md), [行为教练技术架构](behavior-coach-architecture.md)

## 一、概述

### 1.1 目标
实现基于SSE（Server-Sent Events）的教练主动提示前端系统，使AI教练能够**主动发起对话**，在前端聊天界面中实时显示教练提示，而不依赖微信推送集成。

### 1.2 核心需求
1. **实时性**: 教练提示需要实时推送到前端
2. **可靠性**: 连接断开后自动重连，消息不丢失
3. **用户体验**: 提示显示自然，就像Agent在主动发起对话
4. **交互性**: 支持快速回复、卡片交互等富媒体消息
5. **离线处理**: 离线时缓存消息，上线后同步

### 1.3 技术选型
- **通信协议**: SSE (Server-Sent Events) - 简单、轻量、支持自动重连
- **前端框架**: 原生JavaScript + 现有聊天界面
- **消息格式**: JSON + EventSource标准格式
- **状态管理**: 本地存储 + 内存缓存
- **错误处理**: 指数退避重连 + 离线队列

## 二、系统架构

### 2.1 整体架构图
```
┌─────────────────────────────────────────────────────────────────┐
│                         前端聊天界面                              │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │  SSE客户端   │  │  消息渲染器   │  │  交互处理器   │            │
│  │ - 连接管理   │  │ - 富媒体渲染 │  │ - 快速回复   │            │
│  │ - 消息接收   │  │ - 动画效果   │  │ - 卡片交互   │            │
│  │ - 重连机制   │  │ - 时间显示   │  │ - 状态更新   │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │  离线管理器   │  │  状态同步器   │  │  用户偏好管理   │        │
│  │ - 消息缓存   │  │ - 已读状态   │  │ - 免打扰设置 │            │
│  │ - 队列管理   │  │ - 响应状态   │  │ - 渠道偏好   │            │
│  │ - 同步策略   │  │ - 同步服务   │  │ - 频率控制   │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                         SSE后端服务                              │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │  SSE路由     │  │  连接管理器   │  │  消息分发器   │            │
│  │ - 认证鉴权   │  │ - 连接池     │  │ - 消息路由   │            │
│  │ - 事件流     │  │ - 心跳检测   │  │ - 广播推送   │            │
│  │ - CORS配置   │  │ - 清理机制   │  │ - 优先级队列 │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 数据流
```
后端教练系统 → SSE服务 → 前端SSE客户端 → 聊天界面渲染
    ↓              ↓              ↓              ↓
生成提示 → 序列化消息 → 建立连接 → 接收消息 → 渲染提示
    ↓              ↓              ↓              ↓
响应处理 ← 用户响应 ← 交互处理 ← 用户交互 ← 显示交互元素
```

## 三、前端组件设计

### 3.1 SSE客户端 (SSEClient)

#### **3.1.1 核心功能**
- 连接管理：建立、维护、重连SSE连接
- 消息接收：处理服务器推送的教练提示
- 状态管理：跟踪连接状态、消息计数
- 错误处理：指数退避重连机制
- 离线队列：网络断开时缓存消息

#### **3.1.2 关键特性**
- **自动重连**: 连接断开后自动尝试重连，使用指数退避算法
- **心跳检测**: 定期发送心跳包，保持连接活跃
- **认证集成**: 支持JWT token认证
- **连接状态通知**: 实时通知前端连接状态变化
- **消息去重**: 避免重复接收相同消息

### 3.2 消息渲染器 (MessageRenderer)

#### **3.2.1 支持的消息类型**
1. **教练提示消息**: 包含标题、内容、快速回复选项
2. **富媒体卡片**: 进度卡片、里程碑卡片、鼓励卡片
3. **快速回复**: 交互式按钮，支持不同动作类型
4. **打字指示器**: 模拟AI思考过程
5. **系统消息**: 响应结果、错误提示等

#### **3.2.2 渲染特性**
- **动画效果**: 消息入场动画，提升用户体验
- **响应式设计**: 适配不同屏幕尺寸
- **富媒体支持**: 图片、卡片、交互元素
- **时间显示**: 智能时间格式化
- **状态标记**: 已读、已响应、过期等状态

### 3.3 交互处理器 (InteractionHandler)

#### **3.3.1 交互类型**
1. **快速回复点击**: 处理用户对教练提示的快速响应
2. **卡片动作**: 处理富媒体卡片中的交互按钮
3. **消息状态更新**: 标记消息为已读、已响应
4. **后续流程处理**: 根据用户响应触发后续对话

#### **3.3.2 处理流程**
1. 接收用户交互事件
2. 验证交互有效性
3. 发送响应到服务器
4. 更新本地状态
5. 触发后续动作
6. 显示处理结果

### 3.4 离线管理器 (OfflineManager)

#### **3.4.1 离线处理策略**
- **消息缓存**: 网络断开时缓存用户响应
- **队列管理**: 先进先出消息队列
- **自动同步**: 网络恢复后自动同步离线消息
- **冲突解决**: 处理可能的重复提交
- **存储限制**: 限制离线队列大小，避免存储溢出

#### **3.4.2 网络状态检测**
- 监听online/offline事件
- 显示网络状态提示
- 自动切换在线/离线模式
- 重连后自动同步

## 四、与现有系统集成

### 4.1 与现有聊天界面集成
```
现有聊天界面 (chat.js)
    ↓
增强为教练聊天界面 (chat-enhanced.js)
    ↓
集成SSE客户端 + 消息渲染器 + 交互处理器
    ↓
支持教练主动提示 + 用户响应处理
```

### 4.2 文件结构
```
static/js/
├── chat.js                    # 现有聊天界面（基础）
├── chat-enhanced.js          # 增强版聊天界面（新增）
├── coaching-sse-client.js    # SSE客户端（新增）
├── coaching-message-renderer.js  # 消息渲染器（新增）
└── coaching-interaction-handler.js  # 交互处理器（新增）
```

### 4.3 集成步骤
1. 在现有聊天页面加载增强脚本
2. 初始化SSE客户端并建立连接
3. 监听教练提示事件
4. 渲染接收到的教练提示
5. 处理用户交互并发送响应
6. 更新聊天界面状态

## 五、消息格式规范

### 5.1 教练提示消息格式
```json
{
  "type": "coaching_prompt",
  "id": "prompt_123456",
  "user_id": 1,
  "timing_type": "daily_checkin",
  "priority": "high",
  "title": "早上好！今天感觉如何？",
  "message": "记得记录今天的饮食和运动哦...",
  "quick_replies": [
    {
      "text": "分享今日计划",
      "value": "share_plan",
      "action_type": "share_plan",
      "next_step": "plan_sharing"
    }
  ],
  "card_data": {
    "type": "tip",
    "title": "今日小贴士",
    "content": "多喝水有助于新陈代谢..."
  },
  "timestamp": "2026-02-17T09:00:00Z"
}
```

### 5.2 用户响应格式
```json
{
  "type": "user_response",
  "prompt_id": "prompt_123456",
  "value": "share_plan",
  "action": "share_plan",
  "timestamp": "2026-02-17T09:01:00Z"
}
```

### 5.3 响应结果格式
```json
{
  "type": "response_result",
  "prompt_id": "prompt_123456",
  "result": {
    "success": true,
    "message": "已记录您的计划",
    "action": "plan_recorded"
  },
  "follow_up": {
    "type": "coaching_prompt",
    "id": "prompt_123457",
    "title": "计划已记录",
    "message": "我会在今晚提醒您回顾完成情况..."
  }
}
```

## 六、错误处理和监控

### 6.1 错误类型
1. **连接错误**: SSE连接失败、断开
2. **消息错误**: 消息解析失败、格式错误
3. **交互错误**: 用户响应发送失败
4. **渲染错误**: 消息渲染失败
5. **网络错误**: 离线、超时

### 6.2 错误处理策略
- **连接重试**: 指数退避重连机制
- **消息重发**: 重要消息失败后重试
- **降级处理**: 错误时显示友好提示
- **日志记录**: 详细错误日志便于排查
- **用户通知**: 适当的错误提示

### 6.3 监控指标
1. **连接状态**: 连接成功率、平均连接时间
2. **消息处理**: 消息接收率、处理延迟
3. **用户交互**: 响应率、平均响应时间
4. **错误统计**: 各类错误发生频率
5. **性能指标**: 内存使用、CPU占用

## 七、部署和测试

### 7.1 部署要求
- **浏览器兼容性**: 支持EventSource的现代浏览器
- **网络要求**: 稳定的HTTP/HTTPS连接
- **安全要求**: HTTPS连接、JWT认证
- **性能要求**: 低延迟消息推送

### 7.2 测试策略
1. **单元测试**: 各组件独立测试
2. **集成测试**: 组件间集成测试
3. **端到端测试**: 完整流程测试
4. **性能测试**: 连接稳定性、消息处理性能
5. **兼容性测试**: 不同浏览器、设备测试

### 7.3 监控和告警
- **连接监控**: 实时监控SSE连接状态
- **性能监控**: 消息处理延迟、成功率
- **错误告警**: 关键错误实时告警
- **用户反馈**: 收集用户使用反馈

## 八、总结

SSE前端实现架构提供了完整的教练主动提示解决方案，具有以下优势：

1. **实时性强**: 基于SSE的实时消息推送
2. **可靠性高**: 自动重连、离线处理机制
3. **用户体验好**: 自然的对话体验、丰富的交互
4. **扩展性强**: 模块化设计，易于扩展新功能
5. **维护性好**: 清晰的架构、完善的错误处理

该架构与现有系统无缝集成，为AI行为教练系统提供了坚实的前端基础。