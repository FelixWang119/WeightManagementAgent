---
name: 体重管理助手-主动推送与打卡督促功能
overview: 为体重管理助手增加主动推送功能：1)定时推送减重科普知识 2)温柔督促用户打卡(运动/饮食/饮水)并支持一键跳转 3)在管理端提供测试按钮便于验证功能
design:
  architecture:
    framework: vue
  styleKeywords:
    - Bootstrap
    - Card UI
    - Gradient
    - Warm
  fontSystem:
    fontFamily: PingFang SC
    heading:
      size: 18px
      weight: 600
    subheading:
      size: 14px
      weight: 500
    body:
      size: 14px
      weight: 400
  colorSystem:
    primary:
      - "#667eea"
      - "#764ba2"
    background:
      - "#f8f9fa"
      - "#ffffff"
    text:
      - "#212529"
      - "#6c757d"
    functional:
      - "#28a745"
      - "#ffc107"
      - "#dc3545"
todos:
  - id: create-push-models
    content: 创建推送相关数据库模型（PushRecord、PushContentTemplate）
    status: pending
  - id: create-content-generator
    content: 实现科普内容生成器（ContentGenerator）
    status: pending
    dependencies:
      - create-push-models
  - id: create-push-service
    content: 实现主动推送核心服务（ProactivePushService）
    status: pending
    dependencies:
      - create-content-generator
  - id: create-scheduler-service
    content: 实现定时任务调度服务（SchedulerService）
    status: pending
    dependencies:
      - create-push-service
  - id: create-push-api
    content: 创建用户端推送接收API（/api/push）
    status: pending
    dependencies:
      - create-push-service
  - id: create-admin-push-api
    content: 创建管理端推送测试API（/api/admin/push）
    status: pending
    dependencies:
      - create-push-api
  - id: update-admin-frontend
    content: 管理后台增加推送测试模块UI
    status: pending
    dependencies:
      - create-admin-push-api
  - id: update-user-frontend
    content: 用户端聊天界面支持卡片消息渲染
    status: pending
    dependencies:
      - create-push-api
  - id: add-checkin-detection
    content: 实现打卡状态检测逻辑
    status: pending
    dependencies:
      - create-push-service
  - id: integrate-scheduler
    content: 集成调度器到main.py启动流程
    status: pending
    dependencies:
      - create-scheduler-service
---

## 产品概述

为体重管理助手增加主动推送功能，包括减重科普知识推送和打卡督促功能，并在管理后台提供测试入口。

## 核心功能

### 1. 减重科普知识推送

- 通过聊天界面主动向用户推送减重相关科普内容
- 内容类型包括：轻松科普、温暖鼓励、生活技巧、冷知识、趣味问答
- 内容需有趣、实用、不重复，支持AI动态生成
- 推送频率可配置（每日/每周/随机）

### 2. 打卡督促功能

- 督促类型：运动打卡、饮食打卡、饮水打卡
- 语言风格：温柔、给足情绪价值，避免说教感
- 智能检测用户当日打卡状态，针对性提醒
- 消息中支持一键跳转相关打卡页面（卡片式交互）

### 3. 管理后台测试功能

- 在管理后台增加"推送测试"模块
- 支持手动触发科普推送和打卡督促
- 可选择测试用户或全体用户
- 查看推送历史和效果统计

## 功能边界

- 推送通过聊天消息形式实现，不依赖外部推送服务
- 定时调度使用APScheduler或外部cron触发
- 科普内容优先使用AI生成，可配置预设内容库
- 打卡检测基于现有记录表（ExerciseRecord/MealRecord/WaterRecord）

## 技术栈选择

- **后端框架**: FastAPI + SQLAlchemy 2.0（与现有架构一致）
- **定时调度**: APScheduler（轻量级，适合低配置机器）
- **AI生成**: 复用现有 ai_service 模块
- **数据库**: SQLite（开发）/ PostgreSQL（生产）
- **前端**: Vue 3（管理后台）+ 原生HTML（用户端卡片消息）

## 实现方案

### 架构设计

采用"服务层 + 调度层 + API层"三层架构：

1. **服务层** (`services/proactive_push_service.py`): 核心推送逻辑，包括内容生成、用户筛选、消息发送
2. **调度层** (`services/scheduler_service.py`): APScheduler封装，管理定时任务
3. **API层** (`api/routes/push.py` + `api/routes/admin/push.py`): 用户端接收推送、管理端测试接口

### 关键设计决策

**1. 内容生成策略**

- 使用AI动态生成科普内容，避免内容重复
- 基于用户画像个性化（如夜猫子用户推送与睡眠相关的知识）
- 使用提示词模板 + 随机主题选择机制

**2. 打卡检测机制**

- 查询当日记录表判断打卡状态
- 支持部分打卡提醒（如只记录了早餐，提醒午餐/晚餐）
- 避免过度提醒：同一类型每日最多提醒2次

**3. 消息卡片格式**

- 使用JSON结构化消息，前端解析渲染
- 支持 `action_type` + `action_target` 实现一键跳转
- 兼容现有聊天消息格式（ChatHistory表）

**4. 调度策略（低配置机器优化）**

- 使用APScheduler的BackgroundScheduler，非阻塞
- 任务执行时间分散，避免并发高峰
- 支持外部cron触发（通过API端点），减少常驻进程开销

### 数据模型扩展

新增表：

- `PushRecord`: 推送记录表，追踪推送历史
- `PushContentTemplate`: 科普内容模板表（可选，用于预设内容）

扩展现有表：

- `SystemConfig`: 增加推送相关配置（频率、开关等）

### 性能考虑

- 用户批量处理：使用分页查询，避免一次性加载大量用户
- AI调用：使用异步批量生成，控制并发数（max 3并发）
- 数据库：使用连接池，推送记录批量写入

### 目录结构

```
project-root/
├── services/
│   ├── proactive_push_service.py    # [NEW] 主动推送核心服务
│   ├── scheduler_service.py         # [NEW] 定时任务调度服务
│   └── content_generator.py         # [NEW] 科普内容生成器
├── api/routes/
│   ├── push.py                      # [NEW] 用户端推送接收API
│   └── admin/
│       └── push.py                  # [NEW] 管理端推送测试API
├── models/
│   └── database.py                  # [MODIFY] 新增PushRecord模型
├── static/admin/index.html          # [MODIFY] 增加推送测试模块
└── config/
    └── assistant_styles.py          # [MODIFY] 增加督促风格提示词
```

## 关键代码结构

### 推送服务接口

```python
class ProactivePushService:
    async def send_knowledge_push(self, user_id: int, push_type: str = "auto") -> PushResult
    async def send_checkin_reminder(self, user_id: int, reminder_type: CheckinType) -> PushResult
    async def batch_push(self, user_filter: UserFilter, push_config: PushConfig) -> BatchPushResult
```

### 消息卡片结构

```python
class PushMessageCard:
    type: Literal["knowledge", "reminder"]
    content: str                    # 文本内容
    style: Literal["gentle", "warm", "encouraging"]
    actions: List[ActionButton]     # 操作按钮
    metadata: Dict[str, Any]        # 扩展数据
```

### 调度配置

```python
SCHEDULE_CONFIG = {
    "knowledge_push": "0 9 * * *",      # 每天9点科普推送
    "checkin_reminder": "0 12,18 * * *", # 每天12点、18点打卡提醒
}
```

## 设计概述

管理后台推送测试模块采用简洁实用的卡片式布局，与现有Bootstrap风格保持一致。

### 页面结构

**推送测试模块（新增标签页）**

1. **统计概览卡片**: 展示今日推送次数、覆盖用户数、点击率
2. **快速测试区**: 

- 用户选择器（下拉选择/全部用户）
- 推送类型选择（科普/运动督促/饮食督促/饮水督促）
- 发送按钮 + 预览功能

3. **推送历史列表**: 展示最近推送记录，支持查看详情和效果
4. **配置区**: 推送开关、频率设置、内容偏好

### 交互设计

- **一键测试**: 选择用户和类型后，即时发送测试推送
- **实时预览**: 发送前可预览消息内容和卡片样式
- **效果追踪**: 推送历史显示发送状态（已发送/已读/已点击）

### 用户端卡片样式

科普推送卡片：

- 渐变背景（蓝紫色系）
- 标题 + 内容 + 趣味emoji
- 底部"知道了"按钮

督促打卡卡片：

- 温暖色调（橙黄色系）
- 温柔文案 + 鼓励语句
- 一键打卡按钮（跳转到对应页面）