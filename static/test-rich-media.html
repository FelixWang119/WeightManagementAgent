<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯Œåª’ä½“æ¶ˆæ¯æµ‹è¯•</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 24px;
            text-align: center;
        }
        
        .test-section {
            margin-bottom: 32px;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 8px;
        }
        
        .test-section h2 {
            color: #007aff;
            margin-bottom: 16px;
            font-size: 18px;
        }
        
        .test-button {
            background: #007aff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 8px;
            transition: background 0.2s;
        }
        
        .test-button:hover {
            background: #0056cc;
        }
        
        .test-button.secondary {
            background: #6c757d;
        }
        
        .test-button.secondary:hover {
            background: #545b62;
        }
        
        .result-area {
            margin-top: 20px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            min-height: 200px;
            border: 1px solid #dee2e6;
        }
        
        .message {
            margin: 12px 0;
            padding: 12px;
            background: #e9ecef;
            border-radius: 8px;
        }
        
        .message.user {
            background: #d1ecf1;
            margin-left: 40px;
        }
        
        .message.assistant {
            background: #d4edda;
            margin-right: 40px;
        }
        
        .message-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin: 8px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #007aff;
        }
        
        .card-title {
            font-weight: bold;
            color: #007aff;
            margin-bottom: 8px;
        }
        
        .card-content {
            color: #666;
        }
        
        .message-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            background: #007aff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .action-btn:hover {
            background: #0056cc;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ¤– Agentå¯Œåª’ä½“æ¶ˆæ¯åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>ğŸ“‹ æµ‹è¯•è¯´æ˜</h2>
            <p>Agentæ”¯æŒä¸‰ç§å¯Œåª’ä½“æ¶ˆæ¯ç±»å‹ï¼š</p>
            <ol>
                <li><strong>å¡ç‰‡æ¶ˆæ¯</strong> - ç”¨äºå±•ç¤ºæ•°æ®ã€å›¾è¡¨ã€ç»“æ„åŒ–ä¿¡æ¯</li>
                <li><strong>å›¾ç‰‡æ¶ˆæ¯</strong> - ç›´æ¥æ˜¾ç¤ºå›¾ç‰‡</li>
                <li><strong>å¿«æ·æ“ä½œ</strong> - äº¤äº’å¼æŒ‰é’®ï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥ç‚¹å‡»</li>
            </ol>
            <p>è¿™äº›åŠŸèƒ½é€šè¿‡æµå¼APIè¿”å›ï¼Œæ ¼å¼ä¸ºï¼š<code>[TYPE:content]</code></p>
        </div>
        
        <div class="test-section">
            <h2>ğŸ¯ æµ‹è¯•å¿«æ·æ“ä½œæŒ‰é’®</h2>
            <p>åœ¨èŠå¤©ä¸­å°è¯•ä»¥ä¸‹é—®é¢˜ï¼ŒAgentå¯èƒ½ä¼šè¿”å›å¿«æ·æ“ä½œæŒ‰é’®ï¼š</p>
            <div>
                <button class="test-button" onclick="sendTestMessage('æˆ‘æƒ³è®°å½•ä»Šå¤©çš„é¥®é£Ÿ')">ğŸ½ï¸ è®°å½•é¥®é£Ÿ</button>
                <button class="test-button" onclick="sendTestMessage('æŸ¥çœ‹æˆ‘çš„è¿åŠ¨æ•°æ®')">ğŸƒ æŸ¥çœ‹è¿åŠ¨</button>
                <button class="test-button" onclick="sendTestMessage('ç»™æˆ‘ä¸€äº›å¥åº·å»ºè®®')">ğŸ’¡ å¥åº·å»ºè®®</button>
                <button class="test-button secondary" onclick="sendTestMessage('æµ‹è¯•å¯Œåª’ä½“æ¶ˆæ¯')">ğŸ¨ æµ‹è¯•å¯Œåª’ä½“</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“Š æµ‹è¯•å¡ç‰‡æ¶ˆæ¯</h2>
            <p>è¯¢é—®æ•°æ®ç›¸å…³çš„é—®é¢˜ï¼ŒAgentå¯èƒ½ä¼šè¿”å›å¡ç‰‡æ ¼å¼çš„æ•°æ®å±•ç¤ºï¼š</p>
            <div>
                <button class="test-button" onclick="sendTestMessage('æ˜¾ç¤ºæˆ‘æœ¬å‘¨çš„çƒ­é‡æ¶ˆè€—')">ğŸ”¥ çƒ­é‡æ•°æ®</button>
                <button class="test-button" onclick="sendTestMessage('å±•ç¤ºæˆ‘çš„ä½“é‡å˜åŒ–è¶‹åŠ¿')">ğŸ“ˆ ä½“é‡è¶‹åŠ¿</button>
                <button class="test-button" onclick="sendTestMessage('ç»™æˆ‘ä¸€ä¸ªé¥®é£Ÿåˆ†ææŠ¥å‘Š')">ğŸ“‹ é¥®é£ŸæŠ¥å‘Š</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ–¼ï¸ æµ‹è¯•å›¾ç‰‡æ¶ˆæ¯</h2>
            <p>ä¸Šä¼ é£Ÿç‰©å›¾ç‰‡è¿›è¡Œåˆ†æï¼ŒAgentå¯èƒ½ä¼šè¿”å›è¯†åˆ«ç»“æœå’Œå›¾ç‰‡ï¼š</p>
            <div>
                <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="uploadImage()">
                <button class="test-button" onclick="document.getElementById('image-upload').click()">ğŸ“· ä¸Šä¼ é£Ÿç‰©å›¾ç‰‡</button>
                <button class="test-button secondary" onclick="sendTestMessage('åˆ†æè¿™å¼ å›¾ç‰‡é‡Œçš„é£Ÿç‰©')">ğŸ” åˆ†æå›¾ç‰‡</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“ è‡ªå®šä¹‰æµ‹è¯•</h2>
            <div style="display: flex; gap: 8px;">
                <input type="text" id="custom-message" placeholder="è¾“å…¥ä½ æƒ³æµ‹è¯•çš„æ¶ˆæ¯..." style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                <button class="test-button" onclick="sendCustomMessage()">å‘é€</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“¤ æµ‹è¯•ç»“æœ</h2>
            <div class="result-area" id="result-area">
                <p>æ¶ˆæ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!Auth.isLoggedIn()) {
            alert('è¯·å…ˆç™»å½•ï¼');
            window.location.href = 'login.html';
        }
        
        // å‘é€æµ‹è¯•æ¶ˆæ¯
        async function sendTestMessage(content) {
            await sendMessage(content);
        }
        
        // å‘é€è‡ªå®šä¹‰æ¶ˆæ¯
        async function sendCustomMessage() {
            const input = document.getElementById('custom-message');
            if (input.value.trim()) {
                await sendMessage(input.value.trim());
                input.value = '';
            }
        }
        
        // ä¸Šä¼ å›¾ç‰‡
        async function uploadImage() {
            const fileInput = document.getElementById('image-upload');
            const file = fileInput.files[0];
            if (!file) return;
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage('user', 'ä¸Šä¼ äº†å›¾ç‰‡: ' + file.name);
            
            try {
                // è¿™é‡Œåº”è¯¥è°ƒç”¨å›¾ç‰‡ä¸Šä¼ API
                // æš‚æ—¶æ¨¡æ‹Ÿ
                addMessage('assistant', '[IMAGE:https://example.com/food-image.jpg] è¯†åˆ«åˆ°é£Ÿç‰©ï¼šç±³é¥­ã€é’èœã€é¸¡è‚‰');
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                addMessage('assistant', 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // å‘é€æ¶ˆæ¯åˆ°Agent
        async function sendMessage(content) {
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage('user', content);
            
            try {
                // ä½¿ç”¨æµå¼APIè·å–å¯Œåª’ä½“æ¶ˆæ¯
                const result = await API.chat.stream({
                    content: content
                }, {
                    onText: (text) => {
                        // å¤„ç†æ–‡æœ¬
                        console.log('æ”¶åˆ°æ–‡æœ¬:', text);
                        addMessage('assistant', text, false);
                    },
                    onImage: (imageUrl) => {
                        // å¤„ç†å›¾ç‰‡
                        console.log('æ”¶åˆ°å›¾ç‰‡:', imageUrl);
                        addImageMessage(imageUrl);
                    },
                    onCard: (cardData) => {
                        // å¤„ç†å¡ç‰‡
                        console.log('æ”¶åˆ°å¡ç‰‡:', cardData);
                        addCardMessage(cardData);
                    },
                    onActions: (actions) => {
                        // å¤„ç†å¿«æ·æ“ä½œ
                        console.log('æ”¶åˆ°å¿«æ·æ“ä½œ:', actions);
                        addActionsMessage(actions);
                    },
                    onError: (error) => {
                        console.error('é”™è¯¯:', error);
                        addMessage('assistant', 'é”™è¯¯: ' + error);
                    },
                    onComplete: () => {
                        console.log('æµå¼å“åº”å®Œæˆ');
                    }
                });
                
                if (!result.success) {
                    addMessage('assistant', 'å‘é€å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('å‘é€å¤±è´¥:', error);
                addMessage('assistant', 'å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°ç»“æœåŒºåŸŸ
        function addMessage(role, content, isFinal = true) {
            const area = document.getElementById('result-area');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            if (role === 'user') {
                messageDiv.innerHTML = `<strong>ğŸ‘¤ ä½ :</strong> ${content}`;
            } else {
                messageDiv.innerHTML = `<strong>ğŸ¤– AI:</strong> ${content}`;
            }
            
            area.appendChild(messageDiv);
            area.scrollTop = area.scrollHeight;
        }
        
        // æ·»åŠ å›¾ç‰‡æ¶ˆæ¯
        function addImageMessage(imageUrl) {
            const area = document.getElementById('result-area');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.innerHTML = `
                <strong>ğŸ¤– AI:</strong> 
                <div style="margin-top: 8px;">
                    <img src="${imageUrl}" style="max-width: 200px; border-radius: 8px;">
                </div>
            `;
            area.appendChild(messageDiv);
            area.scrollTop = area.scrollHeight;
        }
        
        // æ·»åŠ å¡ç‰‡æ¶ˆæ¯
        function addCardMessage(cardData) {
            const area = document.getElementById('result-area');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            
            let cardHtml = `<strong>ğŸ¤– AI:</strong> <div class="message-card">`;
            
            if (cardData.title) {
                cardHtml += `<div class="card-title">${cardData.title}</div>`;
            }
            
            if (cardData.content) {
                cardHtml += `<div class="card-content">${cardData.content}</div>`;
            }
            
            if (cardData.data) {
                cardHtml += `<div style="margin-top: 12px; color: #666; font-size: 14px;">`;
                for (const [key, value] of Object.entries(cardData.data)) {
                    cardHtml += `<div><strong>${key}:</strong> ${value}</div>`;
                }
                cardHtml += `</div>`;
            }
            
            cardHtml += `</div>`;
            messageDiv.innerHTML = cardHtml;
            area.appendChild(messageDiv);
            area.scrollTop = area.scrollHeight;
        }
        
        // æ·»åŠ å¿«æ·æ“ä½œæ¶ˆæ¯
        function addActionsMessage(actions) {
            const area = document.getElementById('result-area');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            
            let actionsHtml = `<strong>ğŸ¤– AI:</strong> <div class="message-actions">`;
            
            actions.forEach(action => {
                if (action.type === 'button') {
                    actionsHtml += `
                        <button class="action-btn" onclick="handleAction('${action.action}', '${action.target}')">
                            ${action.text}
                        </button>
                    `;
                }
            });
            
            actionsHtml += `</div>`;
            messageDiv.innerHTML = actionsHtml;
            area.appendChild(messageDiv);
            area.scrollTop = area.scrollHeight;
        }
        
        // å¤„ç†å¿«æ·æ“ä½œ
        function handleAction(action, target) {
            alert(`æ‰§è¡Œæ“ä½œ: ${action}, ç›®æ ‡: ${target}`);
            // è¿™é‡Œå¯ä»¥æ ¹æ®actionç±»å‹æ‰§è¡Œä¸åŒçš„æ“ä½œ
            switch(action) {
                case 'record_meal':
                    window.location.href = 'meal.html';
                    break;
                case 'record_exercise':
                    window.location.href = 'exercise.html';
                    break;
                case 'view_report':
                    // æŸ¥çœ‹æŠ¥å‘Š
                    break;
                default:
                    console.log('æœªçŸ¥æ“ä½œ:', action);
            }
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            addMessage('assistant', 'æ¬¢è¿æµ‹è¯•å¯Œåª’ä½“æ¶ˆæ¯åŠŸèƒ½ï¼è¯·ç‚¹å‡»ä¸Šé¢çš„æŒ‰é’®å¼€å§‹æµ‹è¯•ã€‚');
        });
    </script>
</body>
</html>