<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¥®é£Ÿè®°å½• - ä½“é‡ç®¡ç†åŠ©æ‰‹</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/layout.css">
    <style>
        .meal-page {
            padding-bottom: 24px;
        }
        
        /* ä»Šæ—¥ç»Ÿè®¡å¡ç‰‡ */
        .today-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card.calories-card .stat-value {
            color: var(--meal-color);
        }
        
        /* ä¸Šä¼ åŒºåŸŸ - æ ¸å¿ƒåŠŸèƒ½ */
        .upload-section {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }
        
        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .upload-zone {
            border: 3px dashed var(--border);
            border-radius: var(--border-radius-lg);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            background: var(--background);
        }
        
        .upload-zone:hover {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.05);
        }
        
        .upload-zone.drag-over {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.1);
            transform: scale(1.02);
        }
        
        .upload-zone.has-image {
            border-style: solid;
            border-color: var(--success-color);
            padding: 0;
            overflow: hidden;
        }
        
        .upload-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.6;
        }
        
        .upload-text {
            font-size: 1.125rem;
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .upload-hint {
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        
        .upload-input {
            display: none;
        }
        
        /* å›¾ç‰‡é¢„è§ˆ */
        .image-preview {
            position: relative;
            width: 100%;
            max-height: 400px;
            overflow: hidden;
        }
        
        .image-preview img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .image-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
        }
        
        .image-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        
        .image-action-btn:hover {
            background: rgba(0,0,0,0.8);
            transform: scale(1.1);
        }
        
        /* AIåˆ†æç»“æœ */
        .analysis-result {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid var(--primary-color);
        }
        
        .analysis-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .food-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--background);
            border-radius: var(--border-radius-sm);
            margin-bottom: 8px;
        }
        
        .food-icon {
            font-size: 1.5rem;
            margin-right: 12px;
        }
        
        .food-info {
            flex: 1;
        }
        
        .food-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .food-detail {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .food-calories {
            font-weight: 600;
            color: var(--meal-color);
        }
        
        /* ç¡®è®¤çŠ¶æ€æ ‡ç­¾ */
        .confirm-status {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            background: var(--warning-color);
            color: white;
            margin-left: auto;
        }
        
        .confirm-status.confirmed {
            background: var(--success-color);
        }
        
        /* è°ƒæ•´æ»‘å— */
        .food-adjustment {
            margin-top: 8px;
            padding: 8px 0;
        }
        
        .adjustment-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        
        .adjustment-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
        }
        
        .adjustment-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }
        
        .adjustment-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
        }
        
        /* è°ƒæ•´æç¤º */
        .adjustment-hint {
            background: rgba(52, 152, 219, 0.1);
            padding: 12px;
            border-radius: var(--border-radius);
            margin: 16px 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        /* é‡æ–°æè¿°åŒºåŸŸ */
        .reanalysis-section {
            margin: 16px 0;
            padding: 16px;
            background: var(--background);
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
        }
        
        .reanalysis-actions {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            justify-content: flex-end;
        }
        
        /* ç¡®è®¤æ“ä½œæŒ‰é’® */
        .confirmation-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        
        .confirmation-actions .btn {
            flex: 1;
        }
        
        /* é£Ÿç‰©é¡¹è°ƒæ•´æ¨¡å¼ */
        .food-item.adjustable {
            background: rgba(52, 152, 219, 0.05);
            border: 1px dashed var(--primary-color);
        }
        
        /* é¤é£Ÿç±»å‹é€‰æ‹© */
        .meal-type-section {
            margin-top: 20px;
        }
        
        .meal-type-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        
        @media (max-width: 480px) {
            .meal-type-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .meal-type-btn {
            padding: 16px 12px;
            border: 2px solid var(--border);
            border-radius: var(--border-radius);
            background: var(--surface);
            cursor: pointer;
            text-align: center;
            transition: all var(--transition-fast);
        }
        
        .meal-type-btn:hover {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.05);
        }
        
        .meal-type-btn.active {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.1);
        }
        
        .meal-type-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            display: block;
        }
        
        .meal-type-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        /* æ‰‹åŠ¨è¾“å…¥è¡¨å• */
        .manual-form {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-light);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        @media (max-width: 480px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        /* ä¿å­˜æŒ‰é’® */
        .save-btn {
            width: 100%;
            margin-top: 20px;
            padding: 16px;
            font-size: 1.125rem;
        }
        
        /* ä»Šæ—¥è®°å½•åˆ—è¡¨ */
        .today-records {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }
        
        .meal-group {
            margin-bottom: 20px;
        }
        
        .meal-group:last-child {
            margin-bottom: 0;
        }
        
        .meal-group-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .meal-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--background);
            border-radius: var(--border-radius-sm);
            margin-bottom: 8px;
        }
        
        .meal-item-image {
            width: 60px;
            height: 60px;
            border-radius: var(--border-radius-sm);
            object-fit: cover;
            margin-right: 12px;
        }
        
        .meal-item-content {
            flex: 1;
        }
        
        .meal-item-name {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .meal-item-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .meal-item-calories {
            font-weight: 600;
            color: var(--meal-color);
            font-size: 1.125rem;
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .analyzing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }
        
        .analyzing-text {
            color: var(--text-secondary);
            font-size: 1.125rem;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="page">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="page-header">
            <div class="header-brand">
                <button class="back-button" onclick="history.back()" style="margin-right: 12px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                <span class="header-brand-icon">ğŸ½ï¸</span>
                <span>é¥®é£Ÿè®°å½•</span>
            </div>
            <div class="header-actions">
                <button class="menu-toggle" id="menu-toggle" title="æ‰“å¼€èœå•">
                    <span></span>
                </button>
            </div>
        </header>

        <!-- é¡µé¢å†…å®¹ -->
        <div class="page-content">
            <div class="sidebar-overlay" id="sidebar-overlay"></div>
            
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="user-avatar">ç”¨</div>
                    <div class="user-info">
                        <div class="user-name">åŠ è½½ä¸­...</div>
                        <div class="user-status">åœ¨çº¿</div>
                    </div>
                </div>
                
                <nav class="sidebar-nav">
                    <div class="nav-section">
                        <div class="nav-section-title">ä¸»è¦åŠŸèƒ½</div>
                        <ul class="nav-list">
                            <li><a href="index.html" class="nav-item"><span class="nav-item-icon">ğŸ¤–</span><span class="nav-item-text">AIåŠ©æ‰‹</span></a></li>
                            <li><a href="weight.html" class="nav-item"><span class="nav-item-icon">âš–ï¸</span><span class="nav-item-text">ä½“é‡è®°å½•</span></a></li>
                            <li><a href="meal.html" class="nav-item active"><span class="nav-item-icon">ğŸ½ï¸</span><span class="nav-item-text">é¥®é£Ÿè®°å½•</span></a></li>
                            <li><a href="exercise.html" class="nav-item"><span class="nav-item-icon">ğŸƒ</span><span class="nav-item-text">è¿åŠ¨è®°å½•</span></a></li>
                        </ul>
                    </div>
                    
                    <div class="nav-section">
                        <div class="nav-section-title">å¥åº·ç®¡ç†</div>
                        <ul class="nav-list">
                            <li><a href="water.html" class="nav-item"><span class="nav-item-icon">ğŸ’§</span><span class="nav-item-text">é¥®æ°´è®°å½•</span></a></li>
                            <li><a href="sleep.html" class="nav-item"><span class="nav-item-icon">ğŸ˜´</span><span class="nav-item-text">ç¡çœ è®°å½•</span></a></li>
                            <li><a href="report.html" class="nav-item"><span class="nav-item-icon">ğŸ“Š</span><span class="nav-item-text">æ•°æ®æŠ¥å‘Š</span></a></li>
                            <li><a href="goals.html" class="nav-item"><span class="nav-item-icon">ğŸ¯</span><span class="nav-item-text">ç›®æ ‡ç®¡ç†</span></a></li>
                            <li><a href="calculator.html" class="nav-item"><span class="nav-item-icon">ğŸ”¥</span><span class="nav-item-text">çƒ­é‡è®¡ç®—</span></a></li>
                            <li><a href="reminders.html" class="nav-item"><span class="nav-item-icon">ğŸ””</span><span class="nav-item-text">æé†’è®¾ç½®</span></a></li>
                        </ul>
                    </div>
                </nav>

                <div class="sidebar-footer">
                    <a href="profile.html" class="nav-item"><span class="nav-item-icon">âš™ï¸</span><span class="nav-item-text">ä¸ªäººè®¾ç½®</span></a>
                    <button class="logout-btn" onclick="Auth.logout()">
                        <span>ğŸšª</span>
                        <span>é€€å‡ºç™»å½•</span>
                    </button>
                </div>
            </aside>

            <!-- ä¸»å†…å®¹åŒº -->
            <main class="page-main">
                <div class="meal-page">
                    <!-- ä»Šæ—¥ç»Ÿè®¡ -->
                    <div class="today-stats">
                        <div class="stat-card calories-card">
                            <div class="stat-value" id="today-calories">0</div>
                            <div class="stat-label">ä»Šæ—¥æ‘„å…¥(åƒå¡)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="remaining-calories">--</div>
                            <div class="stat-label">å‰©ä½™å¯æ‘„å…¥</div>
                        </div>
                    </div>

                    <!-- ç…§ç‰‡ä¸Šä¼ åŒºåŸŸ - æ ¸å¿ƒåŠŸèƒ½ -->
                    <div class="upload-section">
                        <h3 class="section-title">ğŸ“¸ æ‹ç…§è®°å½•é¤é£Ÿ</h3>
                        
                        <div class="upload-zone" id="upload-zone">
                            <div class="upload-placeholder" id="upload-placeholder">
                                <div class="upload-icon">ğŸ“·</div>
                                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ é¤é£Ÿç…§ç‰‡</div>
                                <div class="upload-hint">æ”¯æŒ JPGã€PNG æ ¼å¼ï¼ŒAIå°†è‡ªåŠ¨è¯†åˆ«é£Ÿç‰©</div>
                            </div>
                            <div class="image-preview" id="image-preview" style="display: none;">
                                <img id="preview-img" src="" alt="é¤é£Ÿé¢„è§ˆ">
                                <div class="image-actions">
                                    <button class="image-action-btn" onclick="clearImage()" title="åˆ é™¤">âœ•</button>
                                </div>
                                <div class="analyzing-overlay" id="analyzing-overlay" style="display: none;">
                                    <div class="loading-spinner lg"></div>
                                    <div class="analyzing-text">ğŸ¤– AIæ­£åœ¨åˆ†æé£Ÿç‰©...</div>
                                </div>
                            </div>
                            <input type="file" id="file-input" class="upload-input" accept="image/*" capture="environment">
                        </div>

                        <!-- é¤é£Ÿç±»å‹é€‰æ‹© -->
                        <div class="meal-type-section">
                            <label class="form-label">é€‰æ‹©é¤é£Ÿç±»å‹</label>
                            <div class="meal-type-grid">
                                <button type="button" class="meal-type-btn active" data-type="breakfast">
                                    <span class="meal-type-icon">ğŸŒ…</span>
                                    <span class="meal-type-label">æ—©é¤</span>
                                </button>
                                <button type="button" class="meal-type-btn" data-type="lunch">
                                    <span class="meal-type-icon">â˜€ï¸</span>
                                    <span class="meal-type-label">åˆé¤</span>
                                </button>
                                <button type="button" class="meal-type-btn" data-type="dinner">
                                    <span class="meal-type-icon">ğŸŒ™</span>
                                    <span class="meal-type-label">æ™šé¤</span>
                                </button>
                                <button type="button" class="meal-type-btn" data-type="snack">
                                    <span class="meal-type-icon">ğŸ¿</span>
                                    <span class="meal-type-label">åŠ é¤</span>
                                </button>
                            </div>
                        </div>

                        <!-- AIåˆ†æç»“æœ -->
                        <!-- AIè¯†åˆ«ç¡®è®¤å¡ç‰‡ -->
                        <div class="analysis-result" id="analysis-result" style="display: none;">
                            <div class="analysis-header">
                                <span>ğŸ¤–</span>
                                <span>AIè¯†åˆ«ç»“æœ</span>
                                <span class="confirm-status" id="confirm-status">å¾…ç¡®è®¤</span>
                            </div>
                            
                            <!-- é£Ÿç‰©åˆ—è¡¨ï¼ˆå¯è°ƒæ•´ï¼‰ -->
                            <div id="food-list">
                                <!-- åŠ¨æ€ç”Ÿæˆ -->
                            </div>
                            
                            <!-- è°ƒæ•´æç¤º -->
                            <div class="adjustment-hint" id="adjustment-hint" style="display: none;">
                                <span>ğŸ’¡</span> æ‹–åŠ¨æ»‘å—è°ƒæ•´åˆ†é‡ï¼Œæˆ–ç‚¹å‡»"é‡æ–°æè¿°"è®©AIé‡æ–°åˆ†æ
                            </div>
                            
                            <!-- é‡æ–°æè¿°è¾“å…¥æ¡† -->
                            <div class="reanalysis-section" id="reanalysis-section" style="display: none;">
                                <textarea id="reanalysis-input" class="form-textarea" rows="2" placeholder="é‡æ–°æè¿°é£Ÿç‰©ï¼Œä¾‹å¦‚ï¼šä¸€ç¢—ç±³é¥­ã€ä¸¤ä»½é’èœã€ä¸€å—é¸¡èƒ¸è‚‰"></textarea>
                                <div class="reanalysis-actions">
                                    <button class="btn btn-secondary btn-sm" onclick="cancelReanalysis()">å–æ¶ˆ</button>
                                    <button class="btn btn-primary btn-sm" onclick="submitReanalysis()">é‡æ–°åˆ†æ</button>
                                </div>
                            </div>
                            
                            <!-- æ“ä½œæŒ‰é’® -->
                            <div class="confirmation-actions" id="confirmation-actions">
                                <button class="btn btn-secondary" onclick="showReanalysis()">ğŸ“ é‡æ–°æè¿°</button>
                                <button class="btn btn-outline" onclick="cancelConfirmation()">âŒ ä¸å¯¹</button>
                                <button class="btn btn-primary" id="confirm-btn" onclick="confirmMeal()">âœ“ ç¡®è®¤</button>
                            </div>
                        </div>

                        <!-- æ‰‹åŠ¨è¡¥å……è¡¨å• -->
                        <div class="manual-form">
                            <div class="form-group">
                                <label class="form-label">é£Ÿç‰©æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                                <textarea id="meal-note" class="form-textarea" rows="2" placeholder="è¡¥å……è¯´æ˜ï¼Œä¾‹å¦‚ï¼šå°‘æ²¹ã€å»çš®çš„..."></textarea>
                            </div>
                        </div>

                        <!-- ä¿å­˜æŒ‰é’® -->
                        <button class="btn btn-primary btn-lg save-btn" id="save-btn" onclick="saveMeal()">
                            ğŸ’¾ ä¿å­˜è®°å½•
                        </button>
                    </div>

                    <!-- ä»Šæ—¥è®°å½• -->
                    <div class="today-records">
                        <h3 class="section-title">ğŸ“‹ ä»Šæ—¥è®°å½•</h3>
                        <div id="today-meals">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- è„šæœ¬ -->
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/components.js"></script>
    <script>
        // å…¨å±€çŠ¶æ€
        let selectedImage = null;
        let analyzedFoods = [];
        let selectedMealType = 'breakfast';
        
        // é¤é£Ÿç±»å‹åç§°æ˜ å°„
        const mealTypeNames = {
            breakfast: 'æ—©é¤',
            lunch: 'åˆé¤',
            dinner: 'æ™šé¤',
            snack: 'åŠ é¤'
        };
        
        const mealTypeIcons = {
            breakfast: 'ğŸŒ…',
            lunch: 'â˜€ï¸',
            dinner: 'ğŸŒ™',
            snack: 'ğŸ¿'
        };

        document.addEventListener('DOMContentLoaded', () => {
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!Auth.check()) {
            window.location.href = 'login.html';
            return;
        }
        
        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        const user = Auth.getUser();
        if (user) {
            const userNameEl = document.querySelector('.user-name');
            const userAvatarEl = document.querySelector('.user-avatar');
            if (userNameEl) userNameEl.textContent = user.nickname || user.name || 'ç”¨æˆ·';
            if (userAvatarEl) userAvatarEl.textContent = (user.nickname || user.name || 'U')[0].toUpperCase();
        }

            initUploadZone();
            initMealTypeButtons();
            loadTodayMeals();
        });
        
        // åˆå§‹åŒ–ä¸Šä¼ åŒºåŸŸ
        function initUploadZone() {
            const zone = document.getElementById('upload-zone');
            const input = document.getElementById('file-input');
            
            // ç‚¹å‡»ä¸Šä¼ 
            zone.addEventListener('click', (e) => {
                if (e.target.closest('.image-action-btn')) return;
                input.click();
            });
            
            // æ–‡ä»¶é€‰æ‹©
            input.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleImageSelect(e.target.files[0]);
                }
            });
            
            // æ‹–æ‹½ä¸Šä¼ 
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });
            
            zone.addEventListener('dragleave', () => {
                zone.classList.remove('drag-over');
            });
            
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    handleImageSelect(files[0]);
                }
            });
        }
        
        // å¤„ç†å›¾ç‰‡é€‰æ‹©
        function handleImageSelect(file) {
            selectedImage = file;
            
            // æ˜¾ç¤ºé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('upload-placeholder').style.display = 'none';
                document.getElementById('image-preview').style.display = 'block';
                document.getElementById('upload-zone').classList.add('has-image');
            };
            reader.readAsDataURL(file);
            
            // AIåˆ†æ
            analyzeImage(file);
        }
        
        // ç¡®è®¤IDï¼ˆç”¨äºç¡®è®¤æµç¨‹ï¼‰
        let currentConfirmId = null;
        
        // AIåˆ†æå›¾ç‰‡ - ä½¿ç”¨ç¡®è®¤æµç¨‹
        async function analyzeImage(file) {
            const overlay = document.getElementById('analyzing-overlay');
            overlay.style.display = 'flex';
            
            try {
                // æ„å»ºFormData
                const formData = new FormData();
                formData.append('file', file);
                formData.append('meal_type', selectedMealType);
                
                // è°ƒç”¨æ–°çš„ç¡®è®¤æµç¨‹API
                const response = await fetch(`${API.base}/api/meal/analyze-with-confirm`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${Auth.getToken()}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'AIåˆ†æå¤±è´¥');
                }
                
                // è·å–AIåˆ†æç»“æœå’Œç¡®è®¤ID
                const aiAnalysis = result.data.ai_analysis;
                currentConfirmId = result.data.confirm_id;
                
                if (aiAnalysis && aiAnalysis.foods && aiAnalysis.foods.length > 0) {
                    // è½¬æ¢ä¸ºå‰ç«¯éœ€è¦çš„æ ¼å¼ï¼Œå¹¶ä¿å­˜åŸå§‹çƒ­é‡ç”¨äºè°ƒæ•´
                    analyzedFoods = aiAnalysis.foods.map(food => ({
                        name: food.name,
                        amount: food.amount,
                        calories: food.calories,
                        original_calories: food.calories,
                        icon: food.icon || 'ğŸ½ï¸',
                        adjustment: 1.0  // è°ƒæ•´ç³»æ•°
                    }));
                    
                    displayAnalysisResult(analyzedFoods, aiAnalysis.suggestions, true);
                    Utils.toast(`AIè¯†åˆ«æˆåŠŸï¼šå…±${analyzedFoods.length}ç§é£Ÿç‰©ï¼Œè¯·ç¡®è®¤æˆ–è°ƒæ•´`, 'success');
                } else {
                    throw new Error('AIæœªèƒ½è¯†åˆ«å‡ºé£Ÿç‰©');
                }
                
            } catch (error) {
                console.error('AIåˆ†æå¤±è´¥:', error);
                Utils.toast(error.message || 'AIåˆ†æå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥', 'error');
                document.getElementById('analysis-result').style.display = 'none';
            } finally {
                overlay.style.display = 'none';
            }
        }
        
        // æ˜¾ç¤ºåˆ†æç»“æœ
        function displayAnalysisResult(foods, suggestions, editable = false) {
            const container = document.getElementById('food-list');
            const resultSection = document.getElementById('analysis-result');
            const adjustmentHint = document.getElementById('adjustment-hint');
            const confirmActions = document.getElementById('confirmation-actions');
            const confirmStatus = document.getElementById('confirm-status');
            
            const totalCalories = foods.reduce((sum, f) => sum + f.calories, 0);
            
            let html = foods.map((food, index) => {
                const adjustmentSlider = editable ? `
                    <div class="food-adjustment">
                        <div class="adjustment-label">
                            <span>0.5x</span>
                            <span id="adj-value-${index}">1.0x</span>
                            <span>1.5x</span>
                        </div>
                        <input type="range" 
                               class="adjustment-slider" 
                               min="0.5" max="1.5" step="0.1" value="1.0"
                               oninput="adjustFoodCalories(${index}, this.value)"
                               id="slider-${index}">
                    </div>
                ` : '';
                
                return `
                <div class="food-item ${editable ? 'adjustable' : ''}" id="food-item-${index}">
                    <span class="food-icon">${food.icon}</span>
                    <div class="food-info">
                        <div class="food-name">${food.name}</div>
                        <div class="food-detail">${food.amount}</div>
                    </div>
                    <div class="food-calories" id="calories-${index}">${food.calories} kcal</div>
                    ${adjustmentSlider}
                </div>
            `}).join('');
            
            // æ·»åŠ æ€»è®¡
            html += `
                <div class="food-item" style="background: rgba(243, 156, 18, 0.1); margin-top: 12px;">
                    <span class="food-icon">ğŸ”¥</span>
                    <div class="food-info">
                        <div class="food-name" style="font-weight: 600;">é¢„ä¼°æ€»çƒ­é‡</div>
                    </div>
                    <div class="food-calories" style="font-size: 1.25rem;" id="total-calories">${totalCalories} kcal</div>
                </div>
            `;
            
            // æ·»åŠ AIå»ºè®®
            if (suggestions) {
                html += `
                    <div class="food-item" style="background: rgba(52, 152, 219, 0.08); margin-top: 8px;">
                        <span class="food-icon">ğŸ’¡</span>
                        <div class="food-info">
                            <div class="food-name" style="font-size: 0.875rem; color: var(--text-secondary);">${suggestions}</div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            resultSection.style.display = 'block';
            
            // æ˜¾ç¤º/éšè—è°ƒæ•´ç›¸å…³çš„UI
            if (editable) {
                adjustmentHint.style.display = 'block';
                confirmActions.style.display = 'flex';
                confirmStatus.textContent = 'å¾…ç¡®è®¤';
                confirmStatus.className = 'confirm-status';
            } else {
                adjustmentHint.style.display = 'none';
                confirmActions.style.display = 'none';
                confirmStatus.textContent = 'å·²ç¡®è®¤';
                confirmStatus.className = 'confirm-status confirmed';
            }
        }
        
        // è°ƒæ•´é£Ÿç‰©çƒ­é‡
        function adjustFoodCalories(index, adjustment) {
            if (index < 0 || index >= analyzedFoods.length) return;
            
            const food = analyzedFoods[index];
            const newCalories = Math.round(food.original_calories * parseFloat(adjustment));
            
            // æ›´æ–°æ•°æ®
            food.calories = newCalories;
            food.adjustment = parseFloat(adjustment);
            
            // æ›´æ–°UI
            document.getElementById(`calories-${index}`).textContent = `${newCalories} kcal`;
            document.getElementById(`adj-value-${index}`).textContent = `${parseFloat(adjustment).toFixed(1)}x`;
            
            // æ›´æ–°æ€»çƒ­é‡
            updateTotalCalories();
        }
        
        // æ›´æ–°æ€»çƒ­é‡æ˜¾ç¤º
        function updateTotalCalories() {
            const totalCalories = analyzedFoods.reduce((sum, f) => sum + f.calories, 0);
            const totalEl = document.getElementById('total-calories');
            if (totalEl) {
                totalEl.textContent = `${totalCalories} kcal`;
            }
        }
        
        // æ˜¾ç¤ºé‡æ–°æè¿°è¾“å…¥æ¡†
        function showReanalysis() {
            document.getElementById('reanalysis-section').style.display = 'block';
            document.getElementById('reanalysis-input').focus();
        }
        
        // å–æ¶ˆé‡æ–°æè¿°
        function cancelReanalysis() {
            document.getElementById('reanalysis-section').style.display = 'none';
            document.getElementById('reanalysis-input').value = '';
        }
        
        // æäº¤é‡æ–°æè¿°
        async function submitReanalysis() {
            const description = document.getElementById('reanalysis-input').value.trim();
            if (!description) {
                Utils.toast('è¯·è¾“å…¥é£Ÿç‰©æè¿°', 'warning');
                return;
            }
            
            if (!currentConfirmId) {
                Utils.toast('ç¡®è®¤IDæ— æ•ˆï¼Œè¯·é‡æ–°ä¸Šä¼ ç…§ç‰‡', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API.base}/api/meal/reanalyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': `Bearer ${Auth.getToken()}`
                    },
                    body: `confirm_id=${encodeURIComponent(currentConfirmId)}&description=${encodeURIComponent(description)}`
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'é‡æ–°åˆ†æå¤±è´¥');
                }
                
                // æ›´æ–°åˆ†æç»“æœ
                const newFoods = result.data.foods.map(food => ({
                    name: food.name,
                    amount: food.amount,
                    calories: food.calories,
                    original_calories: food.calories,
                    icon: food.icon || 'ğŸ½ï¸',
                    adjustment: 1.0
                }));
                
                analyzedFoods = newFoods;
                displayAnalysisResult(analyzedFoods, result.data.suggestions, true);
                
                // éšè—é‡æ–°æè¿°åŒºåŸŸ
                document.getElementById('reanalysis-section').style.display = 'none';
                document.getElementById('reanalysis-input').value = '';
                
                Utils.toast('é‡æ–°åˆ†æå®Œæˆ', 'success');
                
            } catch (error) {
                console.error('é‡æ–°åˆ†æå¤±è´¥:', error);
                Utils.toast(error.message || 'é‡æ–°åˆ†æå¤±è´¥', 'error');
            }
        }
        
        // ç¡®è®¤é¤é£Ÿè®°å½•
        async function confirmMeal() {
            if (!currentConfirmId) {
                Utils.toast('ç¡®è®¤IDæ— æ•ˆ', 'error');
                return;
            }
            
            try {
                // æ„å»ºè°ƒæ•´æ•°æ®
                const adjustments = {
                    foods: analyzedFoods.map(f => ({
                        name: f.name,
                        amount: f.amount,
                        calories: f.calories,
                        icon: f.icon
                    })),
                    total_calories: analyzedFoods.reduce((sum, f) => sum + f.calories, 0)
                };
                
                const response = await fetch(`${API.base}/api/meal/confirm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': `Bearer ${Auth.getToken()}`
                    },
                    body: `confirm_id=${encodeURIComponent(currentConfirmId)}&adjustments=${encodeURIComponent(JSON.stringify(adjustments))}`
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'ç¡®è®¤å¤±è´¥');
                }
                
                // æ›´æ–°UIä¸ºå·²ç¡®è®¤çŠ¶æ€
                displayAnalysisResult(analyzedFoods, null, false);
                
                // éšè—æ“ä½œæŒ‰é’®
                document.getElementById('confirmation-actions').style.display = 'none';
                document.getElementById('adjustment-hint').style.display = 'none';
                
                // éšè—æ»‘å—
                document.querySelectorAll('.food-adjustment').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.food-item').forEach(el => el.classList.remove('adjustable'));
                
                Utils.toast('é¤é£Ÿè®°å½•å·²ä¿å­˜', 'success');
                
                // åˆ·æ–°ä»Šæ—¥è®°å½•
                await loadTodayMeals();
                
                // æ¸…ç©ºçŠ¶æ€
                currentConfirmId = null;
                
            } catch (error) {
                console.error('ç¡®è®¤å¤±è´¥:', error);
                Utils.toast(error.message || 'ç¡®è®¤å¤±è´¥', 'error');
            }
        }
        
        // å–æ¶ˆç¡®è®¤ï¼ˆè¯†åˆ«ä¸å¯¹ï¼‰
        async function cancelConfirmation() {
            if (!currentConfirmId) {
                clearImage();
                return;
            }
            
            try {
                await fetch(`${API.base}/api/meal/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': `Bearer ${Auth.getToken()}`
                    },
                    body: `confirm_id=${encodeURIComponent(currentConfirmId)}`
                });
            } catch (e) {
                console.error('å–æ¶ˆè¯·æ±‚å¤±è´¥:', e);
            }
            
            // æ¸…ç©ºçŠ¶æ€
            currentConfirmId = null;
            clearImage();
            Utils.toast('å·²å–æ¶ˆï¼Œè¯·é‡æ–°ä¸Šä¼ æˆ–æ‰‹åŠ¨è¾“å…¥', 'info');
        }
        
        // æ¸…é™¤å›¾ç‰‡
        function clearImage() {
            selectedImage = null;
            analyzedFoods = [];
            
            document.getElementById('file-input').value = '';
            document.getElementById('upload-placeholder').style.display = 'block';
            document.getElementById('image-preview').style.display = 'none';
            document.getElementById('analysis-result').style.display = 'none';
            document.getElementById('upload-zone').classList.remove('has-image');
        }
        
        // åˆå§‹åŒ–é¤é£Ÿç±»å‹æŒ‰é’®
        function initMealTypeButtons() {
            document.querySelectorAll('.meal-type-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.meal-type-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedMealType = btn.dataset.type;
                });
            });
        }
        
        // ä¿å­˜è®°å½• - è°ƒç”¨çœŸå®API
        async function saveMeal() {
            if (!selectedImage && analyzedFoods.length === 0) {
                Utils.toast('è¯·å…ˆä¸Šä¼ é¤é£Ÿç…§ç‰‡', 'warning');
                return;
            }
            
            // å¦‚æœæœ‰å¾…ç¡®è®¤çš„è¯†åˆ«ç»“æœï¼Œæç¤ºç”¨æˆ·å…ˆç¡®è®¤
            if (currentConfirmId) {
                Utils.toast('è¯·å…ˆç¡®è®¤AIè¯†åˆ«ç»“æœ', 'warning');
                return;
            }
            
            // è°ƒè¯•ï¼šæ˜¾ç¤ºå½“å‰é€‰æ‹©çš„é¤é£Ÿç±»å‹
            console.log('å½“å‰é€‰æ‹©çš„é¤é£Ÿç±»å‹:', selectedMealType);
            console.log('é¤é£Ÿç±»å‹åç§°:', mealTypeNames[selectedMealType]);
            
            // ç¡®è®¤é¤é£Ÿç±»å‹
            const confirmMessage = `ç¡®è®¤ä¿å­˜ä¸ºã€${mealTypeNames[selectedMealType]}ã€‘å—ï¼Ÿ\n\nå¦‚æœç±»å‹ä¸å¯¹ï¼Œè¯·å…ˆç‚¹å‡»ä¸Šæ–¹çš„é¤é£Ÿç±»å‹æŒ‰é’®åˆ‡æ¢ã€‚`;
            if (!confirm(confirmMessage)) {
                return;
            }
            
            const btn = document.getElementById('save-btn');
            const note = document.getElementById('meal-note').value;
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner" style="width: 16px; height: 16px; border-color: rgba(255,255,255,0.3); border-top-color: white;"></span> ä¿å­˜ä¸­...';
            
            try {
                // æ„é€ é£Ÿç‰©æè¿°
                const content = analyzedFoods.length > 0 
                    ? analyzedFoods.map(f => `${f.name}(${f.amount})`).join('ã€')
                    : note || 'é¤é£Ÿè®°å½•';
                
                const calories = analyzedFoods.reduce((sum, f) => sum + f.calories, 0);
                
                console.log('å‘é€è¯·æ±‚:', { mealType: selectedMealType, content, calories });
                
                // è°ƒç”¨çœŸå®APIä¿å­˜
                const response = await API.meal.record({
                    mealType: selectedMealType,
                    foodName: content,
                    calories: calories,
                    note: note
                });
                
                console.log('ä¿å­˜å“åº”:', response);
                
                if (!response.success) {
                    throw new Error(response.message || 'ä¿å­˜å¤±è´¥');
                }
                
                Utils.toast('é¤é£Ÿè®°å½•æˆåŠŸï¼', 'success');
                
                // æ¸…ç©ºè¡¨å•
                clearImage();
                document.getElementById('meal-note').value = '';
                analyzedFoods = [];
                
                // åˆ·æ–°ä»Šæ—¥è®°å½•
                console.log('å‡†å¤‡è°ƒç”¨ loadTodayMeals()...');
                // ç¨ç­‰ä¸€ä¸‹ï¼Œç¡®ä¿æ•°æ®åº“äº‹åŠ¡å·²æäº¤
                setTimeout(async () => {
                    try {
                        await loadTodayMeals();
                        console.log('loadTodayMeals() å®Œæˆ');
                    } catch (err) {
                        console.error('loadTodayMeals() å¤±è´¥:', err);
                    }
                }, 300);
                
                // åˆ·æ–°é¦–é¡µçƒ­é‡å¹³è¡¡æ•°æ®ï¼ˆå¦‚æœé¦–é¡µå·²æ‰“å¼€ï¼‰
                if (window.opener && typeof window.opener.loadCalorieBalance === 'function') {
                    window.opener.loadCalorieBalance();
                }
                
                // ä½¿ç”¨ localStorage äº‹ä»¶é€šçŸ¥å…¶ä»–é¡µé¢æ›´æ–°æ•°æ®
                localStorage.setItem('mealUpdated', Date.now().toString());
                
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                Utils.toast(error.message || 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ’¾ ä¿å­˜è®°å½•';
            }
        }
        
        // åŠ è½½ä»Šæ—¥è®°å½•
        async function loadTodayMeals() {
            const container = document.getElementById('today-meals');
            
            try {
                // è°ƒç”¨çœŸå®APIè·å–ä»Šæ—¥è®°å½•
                const response = await API.meal.getToday();

                console.log('=== loadTodayMeals å“åº” ===');
                console.log('å®Œæ•´å“åº”:', response);
                console.log('total_calories:', response.total_calories);
                console.log('records æ•°é‡:', (response.records || []).length);
                
                if (!response.success) {
                    throw new Error(response.message || 'åŠ è½½å¤±è´¥');
                }
                
                const meals = response.records || [];
                
                if (meals.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ½ï¸</div>
                            <div class="empty-state-title">ä»Šæ—¥æš‚æ— è®°å½•</div>
                            <div class="empty-state-desc">ä¸Šä¼ ç¬¬ä¸€å¼ ç…§ç‰‡å¼€å§‹è®°å½•å§</div>
                        </div>
                    `;
                    return;
                }
                
                // æŒ‰é¤é£Ÿç±»å‹åˆ†ç»„
                const grouped = {};
                meals.forEach(meal => {
                    if (!grouped[meal.meal_type]) {
                        grouped[meal.meal_type] = [];
                    }
                    grouped[meal.meal_type].push(meal);
                });
                
                // æ¸²æŸ“
                let totalCalories = 0;
                container.innerHTML = Object.entries(grouped).map(([type, items]) => {
                    const groupCalories = items.reduce((sum, m) => sum + (m.total_calories || m.calories || 0), 0);
                    totalCalories += groupCalories;
                    
                    return `
                        <div class="meal-group">
                            <div class="meal-group-title">
                                <span>${mealTypeIcons[type]}</span>
                                <span>${mealTypeNames[type]}</span>
                                <span style="margin-left: auto; color: var(--meal-color);">${groupCalories} kcal</span>
                            </div>
                                ${items.map(meal => {
                                    const recordTime = new Date(meal.record_time || meal.created_at);
                                    const timeStr = recordTime.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
                                    return `
                                <div class="meal-item">
                                    ${meal.photo_url ? `<img src="${meal.photo_url}" class="meal-item-image" alt="é¤é£Ÿ">` : '<div style="width: 60px; height: 60px; background: var(--background); border-radius: var(--border-radius-sm); margin-right: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">ğŸ½ï¸</div>'}
                                    <div class="meal-item-content">
                                        <div class="meal-item-name">${meal.food_items && meal.food_items[0] ? meal.food_items[0].name : meal.content}</div>
                                        <div class="meal-item-time">${timeStr}</div>
                                    </div>
                                    <div class="meal-item-calories">${meal.total_calories || meal.calories}</div>
                                </div>
                            `}).join('')}
                        </div>
                    `;
                }).join('');
                
                // æ›´æ–°ç»Ÿè®¡ - ä½¿ç”¨APIè¿”å›çš„æ€»çƒ­é‡
                const apiTotalCalories = response.total_calories || totalCalories;
                console.log('æ›´æ–°ç»Ÿè®¡:', {
                    apiTotalCalories,
                    responseTotal: response.total_calories,
                    calculatedTotal: totalCalories
                });

                document.getElementById('today-calories').textContent = apiTotalCalories;
                const target = 2000; // ç›®æ ‡çƒ­é‡
                const remaining = target - apiTotalCalories;
                document.getElementById('remaining-calories').textContent = remaining > 0 ? remaining : 0;
                document.getElementById('remaining-calories').style.color = remaining < 0 ? 'var(--error-color)' : 'var(--success-color)';
                
            } catch (error) {
                console.error('åŠ è½½ä»Šæ—¥è®°å½•å¤±è´¥:', error);
            }
        }
    </script>
</body>
</html>
