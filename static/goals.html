<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <title>ç›®æ ‡ç®¡ç† - ä½“é‡ç®¡ç†åŠ©æ‰‹</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/layout.css">
    <style>
        .goals-page {
            padding-bottom: 24px;
        }

        /* è¿›åº¦åœ†ç¯ */
        .progress-ring-container {
            display: flex;
            justify-content: center;
            margin: 24px 0;
        }

        .progress-ring {
            position: relative;
            width: 180px;
            height: 180px;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
            width: 180px;
            height: 180px;
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 12;
        }

        .progress-ring .bg {
            stroke: var(--border);
        }

        .progress-ring .progress {
            stroke: var(--primary-color);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .progress-ring .center-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-percent {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .progress-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* è¿›åº¦ä¿¡æ¯å¡ç‰‡ */
        .progress-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .progress-info-item {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 16px;
            text-align: center;
        }

        .progress-info-item .value {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        .progress-info-item .label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .progress-info-item.highlight .value {
            color: var(--primary-color);
        }

        /* çŠ¶æ€æ ‡ç­¾ */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-badge.ahead {
            background: rgba(46, 204, 113, 0.1);
            color: #2ecc71;
        }

        .status-badge.on-track {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
        }

        .status-badge.behind {
            background: rgba(241, 196, 15, 0.1);
            color: #f39c12;
        }

        .status-badge.just-started {
            background: rgba(155, 89, 182, 0.1);
            color: #9b59b6;
        }

        .status-badge.completed {
            background: rgba(46, 204, 113, 0.1);
            color: #2ecc71;
        }

        /* ç›®æ ‡å¡ç‰‡ */
        .goal-card {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .goal-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* è®¾ç½®è¡¨å• */
        .goal-form-section {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }

        .form-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-section-title .icon {
            font-size: 1.25rem;
        }

        /* å‘¨è®¡åˆ’é€‰æ‹© */
        .plan-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .plan-option {
            background: var(--bg-secondary);
            border: 2px solid transparent;
            border-radius: var(--border-radius);
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .plan-option:hover {
            border-color: var(--primary-color);
        }

        .plan-option.selected {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.1);
        }

        .plan-option .plan-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .plan-option .plan-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .plan-option .plan-desc {
            font-size: 0.625rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* é¢„è®¡è¾¾æˆ */
        .expected-date {
            background: linear-gradient(135deg, var(--primary-color), #3498db);
            color: white;
            border-radius: var(--border-radius);
            padding: 16px;
            text-align: center;
            margin-bottom: 20px;
        }

        .expected-date .label {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .expected-date .date {
            font-size: 1.25rem;
            font-weight: bold;
            margin-top: 4px;
        }

        /* è­¦å‘Šæç¤º */
        .warning-box {
            background: rgba(241, 196, 15, 0.1);
            border: 1px solid rgba(241, 196, 15, 0.3);
            border-radius: var(--border-radius);
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .warning-box .icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .warning-box .text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* å†å²è®°å½• */
        .history-section {
            margin-top: 32px;
        }

        .history-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .history-item {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item-info .goal-dates {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .history-item .status {
            font-size: 0.75rem;
            padding: 4px 12px;
            border-radius: 20px;
        }

        .history-item .status.completed {
            background: rgba(46, 204, 113, 0.1);
            color: #2ecc71;
        }

        .history-item .status.abandoned {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-muted);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state .text {
            font-size: 0.875rem;
            margin-bottom: 20px;
        }

        /* æ“ä½œæŒ‰é’® */
        .goal-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .goal-actions .btn {
            flex: 1;
        }

        .btn-abandon {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        /* è¥å…»åˆ†é… */
        .nutrition-distribution {
            margin-top: 16px;
        }

        .distribution-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .distribution-item .label {
            width: 60px;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .distribution-item .bar-container {
            flex: 1;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin: 0 12px;
        }

        .distribution-item .bar {
            height: 100%;
            background: var(--primary-color);
            border-radius: 4px;
        }

        .distribution-item .value {
            width: 50px;
            text-align: right;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        @media (max-width: 480px) {
            .progress-info {
                grid-template-columns: repeat(2, 1fr);
            }

            .plan-options {
                grid-template-columns: repeat(3, 1fr);
            }

            .goal-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="page">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="page-header">
            <div class="header-brand">
                <a href="index.html" class="menu-toggle" style="margin-right: 12px; text-decoration: none; display: flex; align-items: center;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </a>
                <span class="header-brand-icon">ğŸ¯</span>
                <span>ç›®æ ‡ç®¡ç†</span>
            </div>
        </header>

        <!-- é¡µé¢å†…å®¹ -->
        <div class="page-content">
            <div class="sidebar-overlay" id="sidebar-overlay"></div>

            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="user-avatar">ç”¨</div>
                    <div class="user-info">
                        <div class="user-name">åŠ è½½ä¸­...</div>
                        <div class="user-status">åœ¨çº¿</div>
                    </div>
                </div>

                <nav class="sidebar-nav">
                    <div class="nav-section">
                        <div class="nav-section-title">ä¸»è¦åŠŸèƒ½</div>
                        <ul class="nav-list">
                            <li><a href="index.html" class="nav-item"><span class="nav-item-icon">ğŸ¤–</span><span class="nav-item-text">AIåŠ©æ‰‹</span></a></li>
                            <li><a href="weight.html" class="nav-item"><span class="nav-item-icon">âš–ï¸</span><span class="nav-item-text">ä½“é‡è®°å½•</span></a></li>
                            <li><a href="meal.html" class="nav-item"><span class="nav-item-icon">ğŸ½ï¸</span><span class="nav-item-text">é¥®é£Ÿè®°å½•</span></a></li>
                            <li><a href="exercise.html" class="nav-item"><span class="nav-item-icon">ğŸƒ</span><span class="nav-item-text">è¿åŠ¨è®°å½•</span></a></li>
                        </ul>
                    </div>

                    <div class="nav-section">
                        <div class="nav-section-title">å¥åº·ç®¡ç†</div>
                        <ul class="nav-list">
                            <li><a href="water.html" class="nav-item"><span class="nav-item-icon">ğŸ’§</span><span class="nav-item-text">é¥®æ°´è®°å½•</span></a></li>
                            <li><a href="sleep.html" class="nav-item"><span class="nav-item-icon">ğŸ˜´</span><span class="nav-item-text">ç¡çœ è®°å½•</span></a></li>
                            <li><a href="report.html" class="nav-item"><span class="nav-item-icon">ğŸ“Š</span><span class="nav-item-text">æ•°æ®æŠ¥å‘Š</span></a></li>
                            <li><a href="goals.html" class="nav-item active"><span class="nav-item-icon">ğŸ¯</span><span class="nav-item-text">ç›®æ ‡ç®¡ç†</span></a></li>
                        </ul>
                    </div>
                </nav>

                <div class="sidebar-footer">
                    <a href="profile.html" class="nav-item"><span class="nav-item-icon">âš™ï¸</span><span class="nav-item-text">ä¸ªäººè®¾ç½®</span></a>
                    <button class="logout-btn" onclick="Auth.logout()">
                        <span>ğŸšª</span>
                        <span>é€€å‡ºç™»å½•</span>
                    </button>
                </div>
            </aside>

            <!-- ä¸»å†…å®¹åŒº -->
            <main class="page-main">
                <div class="goals-page">
                    <!-- å½“å‰ç›®æ ‡ -->
                    <div id="current-goal-section">
                        <div class="goal-card" id="current-goal-card">
                            <!-- è¿›åº¦åœ†ç¯ -->
                            <div class="progress-ring-container">
                                <div class="progress-ring">
                                    <svg>
                                        <circle class="bg" cx="90" cy="90" r="78"></circle>
                                        <circle class="progress" id="progress-circle" cx="90" cy="90" r="78"
                                            stroke-dasharray="490" stroke-dashoffset="490"></circle>
                                    </svg>
                                    <div class="center-content">
                                        <div class="progress-percent" id="progress-percent">0%</div>
                                        <div class="progress-label">å·²å®Œæˆ</div>
                                    </div>
                                </div>
                            </div>

                            <!-- è¿›åº¦ä¿¡æ¯ -->
                            <div class="progress-info">
                                <div class="progress-info-item highlight">
                                    <div class="value" id="current-weight">--</div>
                                    <div class="label">å½“å‰ä½“é‡</div>
                                </div>
                                <div class="progress-info-item">
                                    <div class="value" id="target-weight">--</div>
                                    <div class="label">ç›®æ ‡ä½“é‡</div>
                                </div>
                                <div class="progress-info-item">
                                    <div class="value" id="weight-lost">--</div>
                                    <div class="label">å·²å‡é‡</div>
                                </div>
                                <div class="progress-info-item">
                                    <div class="value" id="days-remaining">--</div>
                                    <div class="label">å‰©ä½™å¤©æ•°</div>
                                </div>
                            </div>

                            <!-- çŠ¶æ€å’Œé¢„è®¡è¾¾æˆ -->
                            <div style="text-align: center; margin-bottom: 16px;">
                                <span class="status-badge" id="progress-status">--</span>
                            </div>

                            <div class="expected-date" id="expected-date-box" style="display: none;">
                                <div class="label">é¢„è®¡è¾¾æˆæ—¥æœŸ</div>
                                <div class="date" id="expected-date">--</div>
                            </div>

                            <!-- æ“ä½œæŒ‰é’® -->
                            <div class="goal-actions">
                                <button class="btn btn-outline" onclick="showGoalForm()">è°ƒæ•´ç›®æ ‡</button>
                                <button class="btn btn-danger btn-abandon" onclick="abandonGoal()">æ”¾å¼ƒç›®æ ‡</button>
                            </div>
                        </div>
                    </div>

                    <!-- ç©ºçŠ¶æ€ - è®¾ç½®æ–°ç›®æ ‡ -->
                    <div id="no-goal-section" style="display: none;">
                        <div class="empty-state">
                            <div class="icon">ğŸ¯</div>
                            <div class="text">è¿˜æ²¡æœ‰è®¾ç½®å‡é‡ç›®æ ‡</div>
                            <button class="btn btn-primary" onclick="showGoalForm()">
                                <span style="margin-right: 8px;">+</span>
                                è®¾ç½®ç›®æ ‡
                            </button>
                        </div>
                    </div>

                    <!-- ç›®æ ‡è®¾ç½®è¡¨å• -->
                    <div id="goal-form-section" style="display: none;">
                        <div class="goal-form-section">
                            <div class="form-section-title">
                                <span class="icon">ğŸ¯</span>
                                <span id="form-title">è®¾ç½®æ–°ç›®æ ‡</span>
                            </div>

                            <form id="goal-form">
                                <div class="form-group">
                                    <label class="form-label">ç›®æ ‡ä½“é‡ (kg)</label>
                                    <input type="number" class="form-input" id="target-weight-input"
                                        placeholder="ä¾‹å¦‚ï¼š65" min="30" max="200" step="0.1" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">ç›®æ ‡æ—¥æœŸ</label>
                                    <input type="date" class="form-input" id="target-date-input"
                                        min="" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">æ¯å‘¨å‡é‡è®¡åˆ’</label>
                                    <div class="plan-options" id="plan-options">
                                        <div class="plan-option" data-value="0.25">
                                            <div class="plan-value">0.25kg</div>
                                            <div class="plan-label">è½»æ¾</div>
                                            <div class="plan-desc">æ¸è¿›å¼</div>
                                        </div>
                                        <div class="plan-option selected" data-value="0.5">
                                            <div class="plan-value">0.5kg</div>
                                            <div class="plan-label">é€‚ä¸­</div>
                                            <div class="plan-desc">æ¨è</div>
                                        </div>
                                        <div class="plan-option" data-value="0.75">
                                            <div class="plan-value">0.75kg</div>
                                            <div class="plan-label">è¾ƒå¿«</div>
                                            <div class="plan-desc">æœ‰æŒ‘æˆ˜</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- é¢„è®¡è¾¾æˆæ—¥æœŸ -->
                                <div class="expected-date" id="expected-calc-box">
                                    <div class="label">é¢„è®¡è¾¾æˆæ—¥æœŸ</div>
                                    <div class="date" id="expected-calc-date">--</div>
                                </div>

                                <div class="warning-box" id="safety-warning" style="display: none;">
                                    <span class="icon">âš ï¸</span>
                                    <span class="text" id="safety-warning-text"></span>
                                </div>

                                <div class="form-actions" style="margin-top: 20px;">
                                    <button type="button" class="btn btn-secondary" onclick="hideGoalForm()">å–æ¶ˆ</button>
                                    <button type="submit" class="btn btn-primary" id="submit-btn">ä¿å­˜ç›®æ ‡</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- å†å²è®°å½• -->
                    <div class="history-section" id="history-section" style="display: none;">
                        <div class="history-title">å†å²ç›®æ ‡</div>
                        <div id="history-list"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toastæç¤º -->
    <div id="toast-container" class="toast-container"></div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/utils.js"></script>
    <script>
        // å…¨å±€çŠ¶æ€
        let currentGoal = null;
        let selectedPlan = 0.5;
        let currentWeight = null;

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            if (!Auth.check()) {
                window.location.href = 'login.html';
                return;
            }

            // æ›´æ–°ä¾§è¾¹æ ç”¨æˆ·ä¿¡æ¯
            await Utils.updateSidebarUser();

            // åˆå§‹åŒ–è®¡åˆ’é€‰æ‹©
            initPlanOptions();

            // åˆå§‹åŒ–è¡¨å•
            initForm();

            // åŠ è½½æ•°æ®
            await loadGoalData();
        });

        // åˆå§‹åŒ–è®¡åˆ’é€‰æ‹©
        function initPlanOptions() {
            document.querySelectorAll('.plan-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.plan-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedPlan = parseFloat(option.dataset.value);
                    updateExpectedDate();
                });
            });
        }

        // åˆå§‹åŒ–è¡¨å•
        function initForm() {
            const form = document.getElementById('goal-form');
            form.addEventListener('submit', handleSubmit);

            const dateInput = document.getElementById('target-date-input');
            const today = new Date();
            const maxDate = new Date();
            maxDate.setFullYear(today.getFullYear() + 2);
            dateInput.min = today.toISOString().split('T')[0];
            dateInput.max = maxDate.toISOString().split('T')[0];

            dateInput.addEventListener('change', updateExpectedDate);
            document.getElementById('target-weight-input').addEventListener('input', updateExpectedDate);
        }

        // æ›´æ–°é¢„è®¡è¾¾æˆæ—¥æœŸ
        function updateExpectedDate() {
            const targetWeight = parseFloat(document.getElementById('target-weight-input').value);
            const targetDate = document.getElementById('target-date-input').value;

            if (targetWeight && targetDate && currentWeight) {
                const weightToLose = currentWeight - targetWeight;
                const weeks = weightToLose / selectedPlan;
                const days = Math.ceil(weeks * 7);

                const expectedDate = new Date();
                expectedDate.setDate(expectedDate.getDate() + days);

                document.getElementById('expected-calc-date').textContent =
                    `${expectedDate.getMonth() + 1}æœˆ${expectedDate.getDate()}æ—¥`;

                // å®‰å…¨è­¦å‘Š
                const warningBox = document.getElementById('safety-warning');
                const warningText = document.getElementById('safety-warning-text');

                if (selectedPlan > 0.75) {
                    warningBox.style.display = 'flex';
                    warningText.textContent = 'æé†’ï¼šè¾ƒå¿«çš„å‡é‡é€Ÿåº¦å¯èƒ½ä¸å¥åº·ï¼Œå»ºè®®æ¯å‘¨å‡é‡ä¸è¶…è¿‡0.75kg';
                } else if (selectedPlan < 0.25) {
                    warningBox.style.display = 'flex';
                    warningText.textContent = 'æé†’ï¼šå‡é‡é€Ÿåº¦è¾ƒæ…¢ï¼Œå¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´æ‰èƒ½è¾¾åˆ°ç›®æ ‡';
                } else {
                    warningBox.style.display = 'none';
                }
            }
        }

        // åŠ è½½ç›®æ ‡æ•°æ®
        async function loadGoalData() {
            try {
                const response = await API.goals.getCurrent();
                if (response.success && response.has_goal) {
                    currentGoal = response.goal;
                    renderCurrentGoal(response.goal);
                    document.getElementById('current-goal-section').style.display = 'block';
                    document.getElementById('no-goal-section').style.display = 'none';
                } else {
                    document.getElementById('current-goal-section').style.display = 'none';
                    document.getElementById('no-goal-section').style.display = 'block';
                }

                // åŠ è½½å†å²è®°å½•
                await loadHistory();
            } catch (error) {
                console.error('åŠ è½½ç›®æ ‡æ•°æ®å¤±è´¥:', error);
                Utils.toast('åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        // æ¸²æŸ“å½“å‰ç›®æ ‡
        function renderCurrentGoal(goal) {
            const progress = goal.progress;

            // æ›´æ–°è¿›åº¦åœ†ç¯
            const percent = progress.progress_percent || 0;
            const circumference = 2 * Math.PI * 78;
            const offset = circumference - (percent / 100) * circumference;

            document.getElementById('progress-circle').style.strokeDashoffset = offset;
            document.getElementById('progress-percent').textContent = `${Math.round(percent)}%`;

            // æ›´æ–°è¿›åº¦ä¿¡æ¯
            document.getElementById('current-weight').textContent =
                progress.current_weight ? `${progress.current_weight}kg` : '--';
            document.getElementById('target-weight').textContent = `${goal.target_weight}kg`;
            document.getElementById('weight-lost').textContent =
                progress.weight_lost ? `${progress.weight_lost}kg` : '0kg';
            document.getElementById('days-remaining').textContent =
                progress.days_remaining || '0';

            // æ›´æ–°çŠ¶æ€
            const statusEl = document.getElementById('progress-status');
            statusEl.textContent = progress.message || '--';
            statusEl.className = `status-badge ${progress.status || ''}`;

            // æ›´æ–°é¢„è®¡è¾¾æˆæ—¥æœŸ
            const expectedDateBox = document.getElementById('expected-date-box');
            if (progress.expected_completion && progress.status !== 'completed') {
                expectedDateBox.style.display = 'block';
                const date = new Date(progress.expected_completion);
                document.getElementById('expected-date').textContent =
                    `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
            } else {
                expectedDateBox.style.display = 'none';
            }

            // ä¿å­˜å½“å‰ä½“é‡ä¾›è®¡ç®—ç”¨
            currentWeight = progress.current_weight;
        }

        // æ˜¾ç¤ºç›®æ ‡è®¾ç½®è¡¨å•
        function showGoalForm() {
            document.getElementById('goal-form-section').style.display = 'block';
            document.getElementById('current-goal-section').style.display = 'none';
            document.getElementById('no-goal-section').style.display = 'none';

            // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œå¡«å……ç°æœ‰æ•°æ®
            if (currentGoal) {
                document.getElementById('form-title').textContent = 'è°ƒæ•´ç›®æ ‡';
                document.getElementById('target-weight-input').value = currentGoal.target_weight;
                document.getElementById('target-date-input').value = currentGoal.target_date;
                selectedPlan = currentGoal.weekly_plan;

                document.querySelectorAll('.plan-option').forEach(o => {
                    o.classList.toggle('selected', parseFloat(o.dataset.value) === selectedPlan);
                });

                document.getElementById('submit-btn').textContent = 'æ›´æ–°ç›®æ ‡';
            } else {
                document.getElementById('form-title').textContent = 'è®¾ç½®æ–°ç›®æ ‡';
                document.getElementById('goal-form').reset();
                document.querySelectorAll('.plan-option').forEach(o => {
                    o.classList.toggle('selected', parseFloat(o.dataset.value) === 0.5);
                });
                selectedPlan = 0.5;
                document.getElementById('submit-btn').textContent = 'ä¿å­˜ç›®æ ‡';
            }

            updateExpectedDate();
        }

        // éšè—ç›®æ ‡è®¾ç½®è¡¨å•
        function hideGoalForm() {
            document.getElementById('goal-form-section').style.display = 'none';
            if (currentGoal) {
                document.getElementById('current-goal-section').style.display = 'block';
            } else {
                document.getElementById('no-goal-section').style.display = 'block';
            }
        }

        // æäº¤è¡¨å•
        async function handleSubmit(e) {
            e.preventDefault();

            const targetWeight = parseFloat(document.getElementById('target-weight-input').value);
            const targetDate = document.getElementById('target-date-input').value;

            if (!targetWeight || !targetDate) {
                Utils.toast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'warning');
                return;
            }

            if (targetWeight >= currentWeight) {
                Utils.toast('ç›®æ ‡ä½“é‡åº”å°äºå½“å‰ä½“é‡', 'warning');
                return;
            }

            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner" style="width: 16px; height: 16px; border-color: rgba(255,255,255,0.3); border-top-color: white;"></span> ä¿å­˜ä¸­...';

            try {
                let response;
                if (currentGoal) {
                    response = await API.goals.update(currentGoal.id, {
                        target_weight: targetWeight,
                        target_date: targetDate,
                        weekly_plan: selectedPlan
                    });
                } else {
                    response = await API.goals.create({
                        target_weight: targetWeight,
                        target_date: targetDate,
                        weekly_plan: selectedPlan
                    });
                }

                if (response.success) {
                    Utils.toast(currentGoal ? 'ç›®æ ‡æ›´æ–°æˆåŠŸï¼' : 'ç›®æ ‡è®¾ç½®æˆåŠŸï¼', 'success');
                    currentGoal = response.goal;
                    await loadGoalData();
                    hideGoalForm();
                } else {
                    Utils.toast(response.message || 'ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜ç›®æ ‡å¤±è´¥:', error);
                Utils.toast(error.message || 'ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ä¿å­˜ç›®æ ‡';
            }
        }

        // æ”¾å¼ƒç›®æ ‡
        async function abandonGoal() {
            if (!confirm('ç¡®å®šè¦æ”¾å¼ƒå½“å‰ç›®æ ‡å—ï¼Ÿæ”¾å¼ƒåå¯ä»¥è®¾ç½®æ–°ç›®æ ‡ã€‚')) {
                return;
            }

            try {
                const response = await API.goals.abandon(currentGoal.id);
                if (response.success) {
                    Utils.toast('ç›®æ ‡å·²æ”¾å¼ƒ', 'success');
                    currentGoal = null;
                    await loadGoalData();
                } else {
                    Utils.toast(response.message || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ”¾å¼ƒç›®æ ‡å¤±è´¥:', error);
                Utils.toast('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        // åŠ è½½å†å²è®°å½•
        async function loadHistory() {
            try {
                const response = await API.goals.getHistory();
                if (response.success && response.history && response.history.length > 0) {
                    renderHistory(response.history);
                    document.getElementById('history-section').style.display = 'block';
                } else {
                    document.getElementById('history-section').style.display = 'none';
                }
            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“å†å²è®°å½•
        function renderHistory(history) {
            const container = document.getElementById('history-list');
            container.innerHTML = history.map(item => `
                <div class="history-item">
                    <div class="history-item-info">
                        <div style="font-weight: 500;">ç›®æ ‡ä½“é‡: ${item.target_weight}kg</div>
                        <div class="goal-dates">${item.created_at.split('T')[0]} - ${item.target_date}</div>
                    </div>
                    <span class="status ${item.status}">${item.status === 'completed' ? 'å·²å®Œæˆ' : 'å·²æ”¾å¼ƒ'}</span>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
