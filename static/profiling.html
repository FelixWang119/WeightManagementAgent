<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ç”»åƒæ”¶é›† - å¥åº·åŠ©æ‰‹</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/profiling.css">
    <style>
        /* ä¸“é—¨ä¸ºç”»åƒé¡µé¢å®šåˆ¶çš„æ ·å¼ */
        .profiling-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .profiling-header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            padding: 20px;
        }

        .profiling-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .profiling-header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 30px;
        }

        .profiling-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .progress-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .progress-circle {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            position: relative;
        }

        .progress-bg {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: #f0f0f0;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(#4CAF50 var(--progress, 0%), #f0f0f0 0%);
            transition: --progress 0.5s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .progress-info {
            font-size: 1.1rem;
            color: #666;
            margin-top: 10px;
        }

        .question-section {
            text-align: center;
        }

        .question-title {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .question-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .option-btn {
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .option-btn:hover {
            border-color: #4CAF50;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }

        .option-btn.selected {
            border-color: #4CAF50;
            background: #4CAF50;
            color: white;
        }

        .option-emoji {
            font-size: 1.2rem;
        }

        .form-section {
            display: none;
        }

        .form-field {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-field label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-field input,
        .form-field select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-field input:focus,
        .form-field select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .feedback-section {
            display: none;
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 20px;
        }

        .feedback-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .feedback-text {
            font-size: 1.1rem;
            color: #333;
            line-height: 1.6;
        }

        .completed-section {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .completed-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #4CAF50;
        }

        .completed-text {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 20px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .profiling-container {
                padding: 10px;
            }

            .profiling-content {
                padding: 20px;
            }

            .question-options {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="profiling-container">
        <div class="profiling-header">
            <h1>ğŸ¤– ç”¨æˆ·ç”»åƒæ”¶é›†</h1>
            <p>é€šè¿‡å‡ ä¸ªç®€å•é—®é¢˜ï¼Œè®©æˆ‘æ›´å¥½åœ°äº†è§£ä½ çš„å¥åº·éœ€æ±‚å’Œä¹ æƒ¯</p>
        </div>

        <div class="profiling-content">
            <!-- è¿›åº¦æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="progress-section" id="progress-section">
                <div class="progress-circle">
                    <div class="progress-bg">
                        <div class="progress-fill"></div>
                        <div class="progress-text">0%</div>
                    </div>
                </div>
                <div class="progress-info">
                    <span id="progress-text">æ­£åœ¨åŠ è½½è¿›åº¦...</span>
                </div>
            </div>

            <!-- é—®é¢˜æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="question-section" id="question-section" style="display: none;">
                <div class="question-title" id="question-text"></div>
                
                <!-- é€‰æ‹©é¢˜é€‰é¡¹ -->
                <div class="question-options" id="options-container"></div>
                
                <!-- è¡¨å•è¾“å…¥åŒºåŸŸ -->
                <div class="form-section" id="form-section"></div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="submit-btn" onclick="submitAnswer()">æäº¤</button>
                    <button class="btn btn-secondary" onclick="skipQuestion()">è·³è¿‡</button>
                </div>
            </div>

            <!-- AIåé¦ˆåŒºåŸŸ -->
            <div class="feedback-section" id="feedback-section">
                <div class="feedback-icon">ğŸ¤–</div>
                <div class="feedback-text" id="feedback-text"></div>
            </div>

            <!-- å®ŒæˆåŒºåŸŸ -->
            <div class="completed-section" id="completed-section">
                <div class="completed-icon">ğŸ‰</div>
                <div class="completed-text">å¤ªæ£’äº†ï¼æˆ‘å·²ç»è¶³å¤Ÿäº†è§£ä½ äº†~</div>
                <button class="btn btn-primary" onclick="window.location.href='/static/index.html'">è¿”å›é¦–é¡µ</button>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„JSåº“ -->
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/profiling.js"></script>
    
    <script>
        // å½“å‰é—®é¢˜æ•°æ®
        let currentQuestion = null;

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadProgress();
            loadNextQuestion();
        });

        // åŠ è½½è¿›åº¦
        async function loadProgress() {
            try {
                const response = await fetch(`${API.base}/api/profiling/progress`, {
                    headers: {
                        'Authorization': `Bearer ${Auth.getToken()}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const progress = result.progress.percentage || 0;
                    const progressFill = document.querySelector('.progress-fill');
                    const progressText = document.querySelector('.progress-text');
                    const progressInfo = document.getElementById('progress-text');
                    
                    // æ›´æ–°è¿›åº¦åœ†ç¯
                    progressFill.style.setProperty('--progress', `${progress}%`);
                    progressText.textContent = `${progress}%`;
                    progressInfo.textContent = `å·²å®Œæˆ ${result.progress.answered || 0}/${result.progress.total || 0} ä¸ªé—®é¢˜`;
                }
            } catch (error) {
                console.error('åŠ è½½è¿›åº¦å¤±è´¥:', error);
            }
        }

        // åŠ è½½ä¸‹ä¸€ä¸ªé—®é¢˜
        async function loadNextQuestion() {
            try {
                const response = await fetch(`${API.base}/api/profiling/next-question?force_new=true`, {
                    headers: {
                        'Authorization': `Bearer ${Auth.getToken()}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.has_question) {
                        showQuestion(result.question);
                    } else {
                        showCompleted();
                    }
                }
            } catch (error) {
                console.error('åŠ è½½é—®é¢˜å¤±è´¥:', error);
                Utils.toast('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // æ˜¾ç¤ºé—®é¢˜
        function showQuestion(question) {
            currentQuestion = question;
            
            // æ˜¾ç¤ºé—®é¢˜åŒºåŸŸï¼Œéšè—è¿›åº¦åŒºåŸŸ
            document.getElementById('progress-section').style.display = 'none';
            document.getElementById('question-section').style.display = 'block';
            document.getElementById('feedback-section').style.display = 'none';
            document.getElementById('completed-section').style.display = 'none';
            
            // è®¾ç½®é—®é¢˜æ–‡æœ¬
            document.getElementById('question-text').textContent = question.question_text;
            
            // æ ¹æ®é—®é¢˜ç±»å‹æ˜¾ç¤ºä¸åŒçš„ç•Œé¢
            if (question.type === 'form' && question.fields) {
                showFormQuestion(question);
            } else {
                showChoiceQuestion(question);
            }
        }

        // æ˜¾ç¤ºé€‰æ‹©é¢˜
        function showChoiceQuestion(question) {
            const optionsContainer = document.getElementById('options-container');
            const formSection = document.getElementById('form-section');
            
            // éšè—è¡¨å•ï¼Œæ˜¾ç¤ºé€‰é¡¹
            formSection.style.display = 'none';
            optionsContainer.style.display = 'grid';
            
            // ç”Ÿæˆé€‰é¡¹æŒ‰é’®
            optionsContainer.innerHTML = question.options.map((opt, index) => `
                <button class="option-btn" onclick="selectOption(this, '${opt.value}')" 
                        style="animation-delay: ${index * 0.1}s">
                    <span class="option-emoji">${opt.emoji || ''}</span>
                    <span class="option-text">${opt.text}</span>
                </button>
            `).join('');
        }

        // æ˜¾ç¤ºè¡¨å•é¢˜
        function showFormQuestion(question) {
            const optionsContainer = document.getElementById('options-container');
            const formSection = document.getElementById('form-section');
            
            // éšè—é€‰é¡¹ï¼Œæ˜¾ç¤ºè¡¨å•
            optionsContainer.style.display = 'none';
            formSection.style.display = 'block';
            
            // ç”Ÿæˆè¡¨å•å­—æ®µ
            formSection.innerHTML = question.fields.map(field => `
                <div class="form-field">
                    <label>${field.label || field.name}</label>
                    ${renderFieldInput(field)}
                </div>
            `).join('');
        }

        // æ¸²æŸ“è¡¨å•è¾“å…¥å­—æ®µ
        function renderFieldInput(field) {
            const placeholder = field.placeholder || '';
            const min = field.min || '';
            const max = field.max || '';

            if (field.input_type === 'select' && field.options) {
                return `
                    <select name="${field.name}" required>
                        <option value="">è¯·é€‰æ‹©${field.label}</option>
                        ${field.options.map(opt => `
                            <option value="${opt.value}">${opt.text}</option>
                        `).join('')}
                    </select>
                `;
            } else {
                return `
                    <input type="${field.input_type || 'text'}"
                           name="${field.name}"
                           placeholder="${placeholder}"
                           ${min ? `min="${min}"` : ''}
                           ${max ? `max="${max}"` : ''}
                           ${field.required ? 'required' : ''}
                           ${field.unit ? `data-unit="${field.unit}"` : ''}>
                `;
            }
        }

        // é€‰æ‹©é€‰é¡¹
        function selectOption(button, value) {
            // ç§»é™¤å…¶ä»–æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // è®¾ç½®å½“å‰æŒ‰é’®ä¸ºé€‰ä¸­çŠ¶æ€
            button.classList.add('selected');
            
            // ä¿å­˜é€‰ä¸­çš„å€¼
            currentQuestion.selectedValue = value;
        }

        // æäº¤ç­”æ¡ˆ
        async function submitAnswer() {
            if (!currentQuestion) return;

            try {
                let response;
                
                if (currentQuestion.type === 'form') {
                    // è¡¨å•é¢˜æäº¤
                    const formData = new FormData(document.getElementById('form-section'));
                    const answers = {};
                    
                    for (let [key, value] of formData.entries()) {
                        if (!value) {
                            Utils.toast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
                            return;
                        }
                        answers[key] = value;
                    }
                    
                    response = await fetch(`${API.base}/api/profiling/submit-form`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${Auth.getToken()}`
                        },
                        body: JSON.stringify({
                            question_id: currentQuestion.id,
                            answer_value: JSON.stringify(answers)
                        })
                    });
                } else {
                    // é€‰æ‹©é¢˜æäº¤
                    if (!currentQuestion.selectedValue) {
                        Utils.toast('è¯·é€‰æ‹©ä¸€ä¸ªé€‰é¡¹', 'error');
                        return;
                    }
                    
                    response = await fetch(`${API.base}/api/profiling/answer`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${Auth.getToken()}`
                        },
                        body: JSON.stringify({
                            question_id: currentQuestion.id,
                            answer_value: currentQuestion.selectedValue,
                            answer_text: currentQuestion.options.find(opt => opt.value === currentQuestion.selectedValue)?.text || ''
                        })
                    });
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showFeedback(result.ai_feedback);
                    setTimeout(() => {
                        loadProgress();
                        loadNextQuestion();
                    }, 2000);
                } else {
                    throw new Error(result.detail || result.message || 'æäº¤å¤±è´¥');
                }
            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                Utils.toast('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // æ˜¾ç¤ºAIåé¦ˆ
        function showFeedback(feedback) {
            document.getElementById('question-section').style.display = 'none';
            document.getElementById('feedback-section').style.display = 'block';
            document.getElementById('feedback-text').textContent = feedback;
        }

        // è·³è¿‡é—®é¢˜
        async function skipQuestion() {
            try {
                const response = await fetch(`${API.base}/api/profiling/skip`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${Auth.getToken()}`
                    },
                    body: JSON.stringify({
                        question_id: currentQuestion.id
                    })
                });
                
                loadNextQuestion();
                Utils.toast('å·²è·³è¿‡è¯¥é—®é¢˜', 'info');
            } catch (error) {
                console.error('è·³è¿‡é—®é¢˜å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºå®Œæˆé¡µé¢
        function showCompleted() {
            document.getElementById('progress-section').style.display = 'none';
            document.getElementById('question-section').style.display = 'none';
            document.getElementById('feedback-section').style.display = 'none';
            document.getElementById('completed-section').style.display = 'block';
        }
    </script>
</body>
</html>