<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <title>çƒ­é‡è®¡ç®—å™¨ - ä½“é‡ç®¡ç†åŠ©æ‰‹</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/layout.css">
    <style>
        .calculator-page { padding-bottom: 24px; }
        .result-card { background: var(--surface); border-radius: var(--border-radius); padding: 24px; margin-bottom: 24px; box-shadow: var(--shadow-sm); }
        .result-title { font-size: 1rem; font-weight: 600; margin-bottom: 20px; text-align: center; }
        .result-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px; }
        .result-item { background: var(--bg-secondary); border-radius: var(--border-radius); padding: 16px; text-align: center; }
        .result-item.highlight { background: linear-gradient(135deg, var(--primary-color), #3498db); color: white; }
        .result-value { font-size: 1.75rem; font-weight: bold; color: var(--primary-color); }
        .result-item.highlight .result-value { color: white; }
        .result-label { font-size: 0.75rem; margin-top: 4px; color: var(--text-muted); }
        .result-item.highlight .result-label { color: rgba(255,255,255,0.9); }
        .form-section { background: var(--surface); border-radius: var(--border-radius); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow-sm); }
        .form-section-title { font-size: 1rem; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .gender-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px; }
        .gender-option { background: var(--bg-secondary); border: 2px solid transparent; border-radius: var(--border-radius); padding: 16px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .gender-option.selected { border-color: var(--primary-color); background: rgba(52, 152, 219, 0.1); }
        .gender-option .icon { font-size: 1.5rem; margin-bottom: 8px; }
        .gender-option .text { font-size: 0.875rem; color: var(--text-secondary); }
        .gender-option.selected .text { color: var(--primary-color); font-weight: 600; }
        .activity-info { background: var(--bg-secondary); border-radius: var(--border-radius); padding: 16px; margin-top: 16px; }
        .activity-title { font-size: 0.875rem; font-weight: 600; margin-bottom: 12px; }
        .activity-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .activity-tag { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; background: var(--surface); color: var(--text-secondary); cursor: pointer; border: 2px solid transparent; }
        .activity-tag:hover { border-color: var(--primary-color); }
        .activity-tag.selected { background: rgba(52, 152, 219, 0.2); color: var(--primary-color); border-color: var(--primary-color); }
        .loss-target-card { background: linear-gradient(135deg, #2ecc71, #27ae60); border-radius: var(--border-radius); padding: 20px; color: white; margin-bottom: 20px; }
        .loss-target-title { font-size: 0.875rem; opacity: 0.9; margin-bottom: 8px; }
        .loss-target-value { font-size: 2rem; font-weight: bold; margin-bottom: 4px; }
        .loss-target-desc { font-size: 0.75rem; opacity: 0.8; }
        .safety-assessment { background: var(--bg-secondary); border-radius: var(--border-radius); padding: 16px; margin-top: 16px; }
        .safety-item { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; }
        .safety-item:last-child { margin-bottom: 0; }
        .safety-icon { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; flex-shrink: 0; }
        .safety-icon.success { background: rgba(46, 204, 113, 0.1); color: #2ecc71; }
        .safety-icon.warning { background: rgba(241, 196, 15, 0.1); color: #f39c12; }
        .safety-icon.error { background: rgba(231, 76, 60, 0.1); color: #e74c3c; }
        .safety-text { font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5; }
        .nutrition-distribution { margin-top: 20px; }
        .nutrition-item { display: flex; align-items: center; margin-bottom: 12px; }
        .nutrition-item .label { width: 60px; font-size: 0.875rem; color: var(--text-secondary); }
        .nutrition-item .bar-container { flex: 1; height: 12px; background: var(--bg-secondary); border-radius: 6px; overflow: hidden; margin: 0 12px; }
        .nutrition-item .bar { height: 100%; border-radius: 6px; transition: width 0.3s ease; }
        .nutrition-item .bar.protein { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        .nutrition-item .bar.carbs { background: linear-gradient(90deg, #f39c12, #d68910); }
        .nutrition-item .bar.fat { background: linear-gradient(90deg, #3498db, #2980b9); }
        .nutrition-item .value { width: 80px; text-align: right; font-size: 0.875rem; font-weight: 600; }
        @media (max-width: 480px) { .result-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <div class="page">
        <header class="page-header">
            <div class="header-brand">
                <a href="index.html" class="menu-toggle" style="margin-right: 12px; text-decoration: none; display: flex; align-items: center;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </a>
                <span class="header-brand-icon">ğŸ”¥</span>
                <span>çƒ­é‡è®¡ç®—å™¨</span>
            </div>
        </header>

        <div class="page-content">
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="user-avatar">ç”¨</div>
                    <div class="user-info"><div class="user-name">åŠ è½½ä¸­...</div><div class="user-status">åœ¨çº¿</div></div>
                </div>
                <nav class="sidebar-nav">
                    <div class="nav-section"><div class="nav-section-title">ä¸»è¦åŠŸèƒ½</div>
                        <ul class="nav-list">
                            <li><a href="index.html" class="nav-item"><span class="nav-item-icon">ğŸ¤–</span><span class="nav-item-text">AIåŠ©æ‰‹</span></a></li>
                            <li><a href="weight.html" class="nav-item"><span class="nav-item-icon">âš–ï¸</span><span class="nav-item-text">ä½“é‡è®°å½•</span></a></li>
                            <li><a href="meal.html" class="nav-item"><span class="nav-item-icon">ğŸ½ï¸</span><span class="nav-item-text">é¥®é£Ÿè®°å½•</span></a></li>
                            <li><a href="exercise.html" class="nav-item"><span class="nav-item-icon">ğŸƒ</span><span class="nav-item-text">è¿åŠ¨è®°å½•</span></a></li>
                        </ul>
                    </div>
                    <div class="nav-section"><div class="nav-section-title">å¥åº·ç®¡ç†</div>
                        <ul class="nav-list">
                            <li><a href="water.html" class="nav-item"><span class="nav-item-icon">ğŸ’§</span><span class="nav-item-text">é¥®æ°´è®°å½•</span></a></li>
                            <li><a href="sleep.html" class="nav-item"><span class="nav-item-icon">ğŸ˜´</span><span class="nav-item-text">ç¡çœ è®°å½•</span></a></li>
                            <li><a href="report.html" class="nav-item"><span class="nav-item-icon">ğŸ“Š</span><span class="nav-item-text">æ•°æ®æŠ¥å‘Š</span></a></li>
                            <li><a href="goals.html" class="nav-item"><span class="nav-item-icon">ğŸ¯</span><span class="nav-item-text">ç›®æ ‡ç®¡ç†</span></a></li>
                            <li><a href="calculator.html" class="nav-item active"><span class="nav-item-icon">ğŸ”¥</span><span class="nav-item-text">çƒ­é‡è®¡ç®—</span></a></li>
                            <li><a href="recipes.html" class="nav-item"><span class="nav-item-icon">ğŸ“–</span><span class="nav-item-text">å¥åº·é£Ÿè°±</span></a></li>
                            <li><a href="reminders.html" class="nav-item"><span class="nav-item-icon">ğŸ””</span><span class="nav-item-text">æé†’è®¾ç½®</span></a></li>
                        </ul>
                    </div>
                </nav>
                <div class="sidebar-footer">
                    <a href="profile.html" class="nav-item"><span class="nav-item-icon">âš™ï¸</span><span class="nav-item-text">ä¸ªäººè®¾ç½®</span></a>
                    <button class="logout-btn" onclick="Auth.logout()"><span>ğŸšª</span><span>é€€å‡ºç™»å½•</span></button>
                </div>
            </aside>

            <main class="page-main">
                <div class="calculator-page">
                    <div class="form-section">
                        <div class="form-section-title"><span>ğŸ“Š</span><span>åŸºç¡€ä¿¡æ¯</span></div>
                        <div class="gender-options" id="gender-options">
                            <div class="gender-option selected" data-gender="male" onclick="selectGender('male')">
                                <div class="icon">ğŸ‘¨</div>
                                <div class="text">ç”·æ€§</div>
                            </div>
                            <div class="gender-option" data-gender="female" onclick="selectGender('female')">
                                <div class="icon">ğŸ‘©</div>
                                <div class="text">å¥³æ€§</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å¹´é¾„ (å²)</label>
                            <input type="number" class="form-input" id="age-input" placeholder="è¯·è¾“å…¥å¹´é¾„" min="15" max="100">
                        </div>
                        <div class="form-group">
                            <label class="form-label">èº«é«˜ (cm)</label>
                            <input type="number" class="form-input" id="height-input" placeholder="è¯·è¾“å…¥èº«é«˜" min="100" max="250">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å½“å‰ä½“é‡ (kg)</label>
                            <input type="number" class="form-input" id="weight-input" placeholder="è¯·è¾“å…¥ä½“é‡" min="30" max="300" step="0.1">
                        </div>
                        <div class="activity-info">
                            <div class="activity-title">æ´»åŠ¨æ°´å¹³</div>
                            <div class="activity-list">
                                <div class="activity-tag" onclick="selectActivity('sedentary')">ä¹…å</div>
                                <div class="activity-tag selected" onclick="selectActivity('light')">è½»åº¦</div>
                                <div class="activity-tag" onclick="selectActivity('moderate')">ä¸­åº¦</div>
                                <div class="activity-tag" onclick="selectActivity('active')">é«˜åº¦</div>
                                <div class="activity-tag" onclick="selectActivity('very-active')">æé«˜åº¦</div>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="calculate-btn" style="margin-top: 20px; width: 100%;" onclick="calculateCalories()">
                            <span style="margin-right: 8px;">ğŸ”¥</span>è®¡ç®—BMR & TDEE
                        </button>
                    </div>

                    <div id="result-section" style="display: none;">
                        <div class="result-card">
                            <div class="result-title">è®¡ç®—ç»“æœ</div>
                            <div class="result-grid">
                                <div class="result-item">
                                    <div class="result-value" id="bmr-value">--</div>
                                    <div class="result-label">åŸºç¡€ä»£è°¢ (BMR)</div>
                                </div>
                                <div class="result-item highlight">
                                    <div class="result-value" id="tdee-value">--</div>
                                    <div class="result-label">æ¯æ—¥æ¶ˆè€— (TDEE)</div>
                                </div>
                            </div>
                        </div>

                        <div class="loss-target-card" id="loss-target-card" style="display: none;">
                            <div class="loss-target-title">æ¯æ—¥å»ºè®®çƒ­é‡æ‘„å…¥</div>
                            <div class="loss-target-value" id="calorie-target">--</div>
                            <div class="loss-target-desc" id="calorie-target-desc">åŸºäºæ‚¨çš„ç›®æ ‡ä½“é‡è®¡ç®—</div>
                        </div>

                        <div class="result-card" id="safety-card" style="display: none;">
                            <div class="result-title">å®‰å…¨è¯„ä¼°</div>
                            <div class="safety-assessment" id="safety-list"></div>
                        </div>

                        <div class="result-card" id="nutrition-card" style="display: none;">
                            <div class="result-title">è¥å…»åˆ†é…å»ºè®®</div>
                            <div class="nutrition-distribution">
                                <div class="nutrition-item">
                                    <span class="label">è›‹ç™½è´¨</span>
                                    <div class="bar-container"><div class="bar protein" id="protein-bar" style="width: 30%;"></div></div>
                                    <span class="value" id="protein-value">--</span>
                                </div>
                                <div class="nutrition-item">
                                    <span class="label">ç¢³æ°´</span>
                                    <div class="bar-container"><div class="bar carbs" id="carbs-bar" style="width: 40%;"></div></div>
                                    <span class="value" id="carbs-value">--</span>
                                </div>
                                <div class="nutrition-item">
                                    <span class="label">è„‚è‚ª</span>
                                    <div class="bar-container"><div class="bar fat" id="fat-bar" style="width: 30%;"></div></div>
                                    <span class="value" id="fat-value">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="save-section" style="display: none;">
                        <button class="btn btn-primary" id="save-btn" style="width: 100%;" onclick="saveCalorieTarget()">
                            <span style="margin-right: 8px;">ğŸ’¾</span>ä¿å­˜ä¸ºæˆ‘çš„çƒ­é‡ç›®æ ‡
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/utils.js"></script>
    <script>
        let selectedGender = 'male';
        let selectedActivity = 'light';
        let currentResult = null;

        function selectGender(gender) {
            selectedGender = gender;
            document.querySelectorAll('.gender-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.gender === gender);
            });
        }

        function selectActivity(activity) {
            selectedActivity = activity;
            document.querySelectorAll('.activity-tag').forEach(el => {
                el.classList.toggle('selected', el.textContent.includes(
                    activity === 'sedentary' ? 'ä¹…å' :
                    activity === 'light' ? 'è½»åº¦' :
                    activity === 'moderate' ? 'ä¸­åº¦' :
                    activity === 'active' ? 'é«˜åº¦' : 'æé«˜åº¦'
                ));
            });
            // ç®€åŒ–é€‰æ‹©é€»è¾‘
            const tags = document.querySelectorAll('.activity-tag');
            tags.forEach((el, i) => {
                const levels = ['sedentary', 'light', 'moderate', 'active', 'very-active'];
                el.classList.toggle('selected', levels[i] === activity);
            });
        }

        async function calculateCalories() {
            const age = parseInt(document.getElementById('age-input').value);
            const height = parseFloat(document.getElementById('height-input').value);
            const weight = parseFloat(document.getElementById('weight-input').value);

            console.log('Calculate clicked', age, height, weight);

            if (!age || !height || !weight) {
                console.log('Validation failed - empty values');
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }

            const btn = document.getElementById('calculate-btn');
            btn.disabled = true;
            btn.innerHTML = '<span>è®¡ç®—ä¸­...</span>';

            console.log('Calling API...');
            try {
                const response = await API.calories.calculate({
                    age: age,
                    gender: selectedGender,
                    height: height,
                    weight: weight,
                    activity_level: selectedActivity
                });

                console.log('API Response:', response);

                if (response && response.success) {
                    currentResult = response;
                    console.log('Showing results...');

                    // æ›´æ–°ç”¨æˆ·ç”»åƒæ•°æ®
                    try {
                        const updateData = {
                            age: age,
                            gender: selectedGender,
                            height: height
                        };

                        // æ›´æ–°æ´»åŠ¨æ°´å¹³åˆ° exercise_habits
                        try {
                            const profileResponse = await API.user.getProfile();
                            if (profileResponse && profileResponse.success && profileResponse.profile) {
                                const existingHabits = profileResponse.profile.exercise_habits || {};
                                updateData.exercise_habits = {
                                    ...existingHabits,
                                    activity_level: selectedActivity
                                };
                            }
                        } catch (e) {
                            console.log('è·å–ç°æœ‰æ´»åŠ¨ä¹ æƒ¯å¤±è´¥ï¼Œä½¿ç”¨æ–°æ•°æ®');
                            updateData.exercise_habits = {
                                activity_level: selectedActivity
                            };
                        }

                        // æ·»åŠ  BMR
                        updateData.bmr = response.bmr;

                        await API.user.updateProfile(updateData);
                        console.log('Profile updated successfully');
                    } catch (updateError) {
                        console.log('Failed to update profile:', updateError);
                        // ä¸å½±å“è®¡ç®—ç»“æœæ˜¾ç¤º
                    }

                    const bmrEl = document.getElementById('bmr-value');
                    const tdeeEl = document.getElementById('tdee-value');
                    const resultSection = document.getElementById('result-section');
                    const saveSection = document.getElementById('save-section');

                    console.log('Elements:', bmrEl, tdeeEl, resultSection, saveSection);

                    if (bmrEl) bmrEl.textContent = response.bmr;
                    if (tdeeEl) tdeeEl.textContent = response.tdee;
                    if (resultSection) resultSection.style.cssText = 'display: block !important;';
                    if (saveSection) saveSection.style.cssText = 'display: block !important;';

                    console.log('Result section style after:', resultSection ? resultSection.style.cssText : 'null');

                    // è®¡ç®—å‡é‡ç›®æ ‡
                    console.log('Calling target API...');
                    const targetResponse = await API.calories.calculateWeightLossTarget({
                        tdee: response.tdee,
                        target_weekly_loss_kg: 0.5
                    });

                    console.log('Target Response:', targetResponse);

                    if (targetResponse && targetResponse.success) {
                        const target = targetResponse.target;

                        const lossCard = document.getElementById('loss-target-card');
                        const calorieTarget = document.getElementById('calorie-target');
                        const descEl = document.getElementById('calorie-target-desc');

                        if (lossCard) lossCard.style.cssText = 'display: block !important; background: linear-gradient(135deg, #2ecc71, #27ae60) !important; border-radius: var(--border-radius) !important; padding: 20px !important; color: white !important; margin-bottom: 20px !important;';
                        if (calorieTarget) calorieTarget.textContent = (target.calorie_target || target.daily_calorie_intake || '--') + ' kcal';
                        if (descEl) descEl.textContent = 'æ¯å‘¨å‡é‡ ' + target.target_weekly_loss_kg + 'kg | çƒ­é‡ç¼ºå£ ' + (target.daily_deficit || target.daily_calorie_deficit || '--') + ' kcal';

                        // å®‰å…¨è¯„ä¼°
                        const list = document.getElementById('safety-list');
                        if (list) {
                            const assessments = [];
                            const intake = target.calorie_target || target.daily_calorie_intake || 0;
                            if (intake < response.bmr) {
                                assessments.push({type: 'warning', text: 'æ¯æ—¥æ‘„å…¥ä½äºåŸºç¡€ä»£è°¢ï¼Œé•¿æœŸå¯èƒ½å½±å“å¥åº·'});
                            } else {
                                assessments.push({type: 'success', text: 'çƒ­é‡æ‘„å…¥å……è¶³ï¼Œè¥å…»å‡è¡¡'});
                            }
                            assessments.push({type: 'success', text: 'å‡é‡é€Ÿåº¦é€‚ä¸­ï¼Œç§‘å­¦å¥åº·'});
                            list.innerHTML = assessments.map(a => '<div class="safety-item"><div class="safety-icon ' + a.type + '">' + (a.type === 'success' ? 'âœ“' : '!') + '</div><div class="safety-text">' + a.text + '</div></div>').join('');
                        }

                        const safetyCard = document.getElementById('safety-card');
                        if (safetyCard) safetyCard.style.cssText = 'display: block !important;';

                        // è¥å…»åˆ†é…
                        const calorieIntake = target.calorie_target || target.daily_calorie_intake || 0;
                        const protein = Math.round(calorieIntake * 0.25 / 4);
                        const carbs = Math.round(calorieIntake * 0.45 / 4);
                        const fat = Math.round(calorieIntake * 0.30 / 9);

                        // è·å–DOMå…ƒç´ 
                        const proteinBar = document.getElementById('protein-bar');
                        const carbsBar = document.getElementById('carbs-bar');
                        const fatBar = document.getElementById('fat-bar');
                        const proteinVal = document.getElementById('protein-value');
                        const carbsVal = document.getElementById('carbs-value');
                        const fatVal = document.getElementById('fat-value');
                        const nutritionCard = document.getElementById('nutrition-card');
                        
                        // æ›´æ–°è¥å…»åˆ†é…æ˜¾ç¤ºï¼ˆå¸¦å•ä½ï¼‰
                        if (proteinVal) proteinVal.textContent = protein + ' g';
                        if (carbsVal) carbsVal.textContent = carbs + ' g';
                        if (fatVal) fatVal.textContent = fat + ' g';
                        
                        if (nutritionCard) nutritionCard.style.cssText = 'display: block !important;';
                    }
                } else {
                    alert(response.detail || 'è®¡ç®—å¤±è´¥');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('è®¡ç®—å¤±è´¥: ' + error.message);
            } finally {
                const btn = document.getElementById('calculate-btn');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<span style="margin-right: 8px;">ğŸ”¥</span>è®¡ç®—BMR & TDEE';
                }
            }
        }

        async function saveCalorieTarget() {
            if (!currentResult) return;
            try {
                const calorieTargetEl = document.getElementById('calorie-target');
                if (!calorieTargetEl) {
                    alert('æ‰¾ä¸åˆ°çƒ­é‡ç›®æ ‡å…ƒç´ ');
                    return;
                }
                
                const targetText = calorieTargetEl.textContent;
                // æå–æ•°å­—éƒ¨åˆ†ï¼ˆç§»é™¤ " kcal" å•ä½ï¼‰
                const calorieMatch = targetText.match(/(\d+)/);
                if (!calorieMatch) {
                    alert('çƒ­é‡ç›®æ ‡æ ¼å¼é”™è¯¯');
                    return;
                }
                
                const calorieTarget = parseInt(calorieMatch[1]);
                if (isNaN(calorieTarget) || calorieTarget <= 0) {
                    alert('çƒ­é‡ç›®æ ‡å€¼æ— æ•ˆ');
                    return;
                }
                
                // é¦–å…ˆä¿å­˜BMRåˆ°ç”¨æˆ·profileï¼ˆç¡®ä¿é¦–é¡µèƒ½æ˜¾ç¤ºBMRæ•°æ®ï¼‰
                console.log('ä¿å­˜BMRåˆ°ç”¨æˆ·profile...');
                try {
                    const age = parseInt(document.getElementById('age-input').value);
                    const height = parseFloat(document.getElementById('height-input').value);
                    const weight = parseFloat(document.getElementById('weight-input').value);
                    
                    if (age && height && weight) {
                        const updateData = {
                            age: age,
                            gender: selectedGender,
                            height: height,
                            bmr: currentResult.bmr
                        };
                        
                        // æ›´æ–°æ´»åŠ¨æ°´å¹³
                        try {
                            const profileResponse = await API.user.getProfile();
                            if (profileResponse && profileResponse.success && profileResponse.profile) {
                                const existingHabits = profileResponse.profile.exercise_habits || {};
                                updateData.exercise_habits = {
                                    ...existingHabits,
                                    activity_level: selectedActivity
                                };
                            }
                        } catch (e) {
                            console.log('è·å–ç°æœ‰æ´»åŠ¨ä¹ æƒ¯å¤±è´¥ï¼Œä½¿ç”¨æ–°æ•°æ®');
                            updateData.exercise_habits = {
                                activity_level: selectedActivity
                            };
                        }
                        
                        await API.user.updateProfile(updateData);
                        console.log('BMRä¿å­˜æˆåŠŸ');
                    } else {
                        console.log('ç¼ºå°‘å¿…è¦ä¿¡æ¯ï¼Œè·³è¿‡BMRä¿å­˜');
                    }
                } catch (updateError) {
                    console.error('ä¿å­˜BMRå¤±è´¥:', updateError);
                    // ç»§ç»­ä¿å­˜ç›®æ ‡ï¼Œä½†æç¤ºç”¨æˆ·
                    alert('BMRä¿å­˜å¤±è´¥ï¼Œä½†çƒ­é‡ç›®æ ‡ä»ä¼šä¿å­˜ã€‚é¦–é¡µå¯èƒ½æ— æ³•æ˜¾ç¤ºBMRæ•°æ®ã€‚');
                }
                
                // è·å–ç”¨æˆ·å½“å‰ä½“é‡
                let currentWeight = null;
                try {
                    const weightResponse = await fetch(`${API.base}/api/weight/history?days=7`, {
                        headers: { 'Authorization': `Bearer ${Auth.getToken()}` }
                    });
                    if (weightResponse.ok) {
                        const weightData = await weightResponse.json();
                        if (weightData.success && weightData.data && weightData.data.length > 0) {
                            currentWeight = weightData.data[0].weight;
                        }
                    }
                } catch (error) {
                    console.log('è·å–ä½“é‡è®°å½•å¤±è´¥:', error);
                }
                
                if (!currentWeight) {
                    alert('è¯·å…ˆè®°å½•æ‚¨çš„å½“å‰ä½“é‡');
                    return;
                }
                
                // é¦–å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰å½“å‰ç›®æ ‡
                let goalResponse;
                try {
                    goalResponse = await fetch(`${API.base}/api/goals/current`, {
                        headers: { 'Authorization': `Bearer ${Auth.getToken()}` }
                    });
                } catch (e) {
                    console.log('æ£€æŸ¥ç›®æ ‡å¤±è´¥ï¼Œå°è¯•åˆ›å»ºæ–°ç›®æ ‡:', e);
                    goalResponse = { ok: false };
                }
                
                if (goalResponse.ok) {
                    const goalData = await goalResponse.json();
                    if (goalData.success && goalData.has_goal && goalData.goal) {
                        // æ›´æ–°ç°æœ‰ç›®æ ‡
                        const updateResponse = await fetch(`${API.base}/api/goals/${goalData.goal.id}`, {
                            method: 'PUT',
                            headers: { 
                                'Authorization': `Bearer ${Auth.getToken()}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                daily_calorie_target: calorieTarget
                            })
                        });
                        
                         if (updateResponse.ok) {
                            alert('çƒ­é‡ç›®æ ‡å·²æ›´æ–°ï¼BMRæ•°æ®ä¹Ÿå·²ä¿å­˜ï¼Œé¦–é¡µçƒ­é‡å¹³è¡¡æ¨¡å—å°†æ­£å¸¸æ˜¾ç¤ºã€‚');
                        } else {
                            throw new Error('æ›´æ–°ç›®æ ‡å¤±è´¥');
                        }
                    } else {
                        // åˆ›å»ºæ–°ç›®æ ‡ï¼ˆä½¿ç”¨å½“å‰ä½“é‡è®¡ç®—åˆç†çš„ç›®æ ‡ä½“é‡ï¼‰
                        const targetWeight = Math.max(50, currentWeight - 5); // è‡³å°‘å‡5kgï¼Œæœ€ä½50kg
                        const createResponse = await fetch(`${API.base}/api/goals`, {
                            method: 'POST',
                            headers: { 
                                'Authorization': `Bearer ${Auth.getToken()}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                target_weight: targetWeight, // åŸºäºå½“å‰ä½“é‡è®¡ç®—
                                target_date: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 90å¤©å
                                weekly_plan: 0.5, // æ¯å‘¨å‡é‡0.5kg
                                daily_calorie_target: calorieTarget
                            })
                        });
                        
                         if (createResponse.ok) {
                            alert('çƒ­é‡ç›®æ ‡å·²ä¿å­˜ä¸ºæ–°ç›®æ ‡ï¼BMRæ•°æ®ä¹Ÿå·²ä¿å­˜ï¼Œé¦–é¡µçƒ­é‡å¹³è¡¡æ¨¡å—å°†æ­£å¸¸æ˜¾ç¤ºã€‚');
                        } else {
                            throw new Error('åˆ›å»ºç›®æ ‡å¤±è´¥');
                        }
                    }
                } else {
                    // ç›´æ¥å°è¯•åˆ›å»ºæ–°ç›®æ ‡
                    const targetWeight = Math.max(50, currentWeight - 5); // è‡³å°‘å‡5kgï¼Œæœ€ä½50kg
                    const createResponse = await fetch(`${API.base}/api/goals`, {
                        method: 'POST',
                        headers: { 
                            'Authorization': `Bearer ${Auth.getToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            target_weight: targetWeight, // åŸºäºå½“å‰ä½“é‡è®¡ç®—
                            target_date: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                            weekly_plan: 0.5,
                            daily_calorie_target: calorieTarget
                        })
                    });
                    
                     if (createResponse.ok) {
                        alert('çƒ­é‡ç›®æ ‡å·²ä¿å­˜ï¼BMRæ•°æ®ä¹Ÿå·²ä¿å­˜ï¼Œé¦–é¡µçƒ­é‡å¹³è¡¡æ¨¡å—å°†æ­£å¸¸æ˜¾ç¤ºã€‚');
                    } else {
                        throw new Error('ä¿å­˜å¤±è´¥');
                    }
                }
            } catch (error) {
                console.error('ä¿å­˜çƒ­é‡ç›®æ ‡å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            }
        }

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position:fixed;top:80px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 20px;border-radius:5px;z-index:9999;';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        async function init() {
            if (!Auth.check()) {
                window.location.href = 'login.html';
                return;
            }

            const user = Auth.getUser();
            if (user) {
                document.querySelector('.user-name').textContent = user.nickname || user.name || 'ç”¨æˆ·';
                document.querySelector('.user-avatar').textContent = (user.nickname || user.name || 'U')[0].toUpperCase();
            }

            // ä»ç”¨æˆ·ç”»åƒåŠ è½½æ•°æ®ä½œä¸ºé»˜è®¤å€¼
            try {
                const profileResponse = await API.user.getProfile();
                if (profileResponse && profileResponse.success) {
                    const profile = profileResponse.profile;

                    // å¡«å……è¡¨å•
                    if (profile && profile.age) document.getElementById('age-input').value = profile.age;
                    if (profile && profile.height) document.getElementById('height-input').value = profile.height;

                    // è®¾ç½®æ€§åˆ«
                    if (profile && profile.gender) {
                        selectGender(profile.gender);
                    }

                    // ä» exercise_habits ä¸­è·å–æ´»åŠ¨æ°´å¹³
                    if (profile && profile.exercise_habits && profile.exercise_habits.activity_level) {
                        selectActivity(profile.exercise_habits.activity_level);
                    }
                }

                // è·å–æœ€æ–°ä½“é‡è®°å½•
                try {
                    const weightResponse = await fetch(`${API.base}/api/weight/history?days=7`, {
                        headers: { 'Authorization': `Bearer ${Auth.getToken()}` }
                    });
                    if (weightResponse.ok) {
                        const weightData = await weightResponse.json();
                        console.log('Weight response:', weightData);
                        if (weightData.success && weightData.data && weightData.data.length > 0) {
                            // data æ•°ç»„å·²ç»æŒ‰ record_date é™åºæ’åˆ—ï¼Œç¬¬ä¸€æ¡å°±æ˜¯æœ€æ–°è®°å½•
                            const latestWeight = weightData.data[0].weight;
                            console.log('Setting weight input:', latestWeight);
                            document.getElementById('weight-input').value = latestWeight;
                        }
                    }
                } catch (error) {
                    console.log('è·å–ä½“é‡è®°å½•å¤±è´¥:', error);
                }
            } catch (error) {
                console.log('åŠ è½½ç”¨æˆ·ç”»åƒæ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼');
            }
        }

        init();
    </script>
</body>
</html>