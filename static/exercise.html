<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿åŠ¨æ‰“å¡ - ä½“é‡ç®¡ç†åŠ©æ‰‹</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        .exercise-page {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .exercise-section {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }
        
        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        
        /* æ‰“å¡é¢æ¿ */
        .checkin-panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .form-col {
            flex: 1;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            color: var(--text-primary);
            background: white;
            transition: border-color var(--transition-fast);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .form-control.select {
            cursor: pointer;
        }
        
        /* å¿«é€Ÿé€‰é¡¹ */
        .quick-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .quick-option {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            background: white;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 0.875rem;
        }
        
        .quick-option:hover {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.05);
        }
        
        .quick-option.active {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
        }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        /* æ‰“å¡å†å² */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .history-table th {
            text-align: left;
            padding: 12px 16px;
            border-bottom: 2px solid var(--border);
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .history-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-primary);
        }
        
        .history-table tr:last-child td {
            border-bottom: none;
        }
        
        .history-table tr:hover {
            background: var(--background);
        }
        
        /* æ—¥å†è§†å›¾ */
        .calendar-container {
            margin-top: 24px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        
        .calendar-day {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .calendar-day.weekday {
            color: var(--text-secondary);
            font-weight: 600;
            cursor: default;
        }
        
        .calendar-day.empty {
            background: transparent;
            cursor: default;
        }
        
        .calendar-day.checkin {
            background: rgba(46, 204, 113, 0.2);
            color: var(--success-color);
            font-weight: 600;
        }
        
        .calendar-day.today {
            border: 2px solid var(--primary-color);
        }
        
        /* å¼ºåº¦æ ‡ç­¾ */
        .intensity-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .intensity-low {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success-color);
        }
        
        .intensity-medium {
            background: rgba(241, 196, 15, 0.1);
            color: var(--warning-color);
        }
        
        .intensity-high {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(52, 152, 219, 0.3);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 12px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .history-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="page">
        <header class="page-header">
            <div class="header-brand">
                <button class="menu-toggle" onclick="history.back()" style="margin-right: 12px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </button>
                <span class="header-brand-icon">ğŸƒ</span>
                <span>è¿åŠ¨æ‰“å¡</span>
            </div>
            <div class="header-actions">
                <button class="menu-toggle" id="menu-toggle" title="æ‰“å¼€èœå•"><span></span></button>
            </div>
        </header>

        <div class="page-content">
            <div class="sidebar-overlay" id="sidebar-overlay"></div>
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="user-avatar">ç”¨</div>
                    <div class="user-info"><div class="user-name">åŠ è½½ä¸­...</div><div class="user-status">åœ¨çº¿</div></div>
                </div>
                <nav class="sidebar-nav">
                    <div class="nav-section"><div class="nav-section-title">ä¸»è¦åŠŸèƒ½</div>
                        <ul class="nav-list">
                            <li><a href="index.html" class="nav-item"><span class="nav-item-icon">ğŸ¤–</span><span class="nav-item-text">AIåŠ©æ‰‹</span></a></li>
                            <li><a href="weight.html" class="nav-item"><span class="nav-item-icon">âš–ï¸</span><span class="nav-item-text">ä½“é‡è®°å½•</span></a></li>
                            <li><a href="meal.html" class="nav-item"><span class="nav-item-icon">ğŸ½ï¸</span><span class="nav-item-text">é¥®é£Ÿè®°å½•</span></a></li>
                            <li><a href="exercise.html" class="nav-item active"><span class="nav-item-icon">ğŸƒ</span><span class="nav-item-text">è¿åŠ¨è®°å½•</span></a></li>
                        </ul>
                    </div>
                                        <div class="nav-section"><div class="nav-section-title">å¥åº·ç®¡ç†</div>
                        <ul class="nav-list">
                            <li><a href="water.html" class="nav-item"><span class="nav-item-icon">ğŸ’§</span><span class="nav-item-text">é¥®æ°´è®°å½•</span></a></li>
                            <li><a href="sleep.html" class="nav-item"><span class="nav-item-icon">ğŸ˜´</span><span class="nav-item-text">ç¡çœ è®°å½•</span></a></li>
                            <li><a href="report.html" class="nav-item"><span class="nav-item-icon">ğŸ“Š</span><span class="nav-item-text">æ•°æ®æŠ¥å‘Š</span></a></li>
                            <li><a href="goals.html" class="nav-item"><span class="nav-item-icon">ğŸ¯</span><span class="nav-item-text">ç›®æ ‡ç®¡ç†</span></a></li>
                            <li><a href="calculator.html" class="nav-item"><span class="nav-item-icon">ğŸ”¥</span><span class="nav-item-text">çƒ­é‡è®¡ç®—</span></a></li>
                            <li><a href="reminders.html" class="nav-item"><span class="nav-item-icon">ğŸ””</span><span class="nav-item-text">æé†’è®¾ç½®</span></a></li>
                        </ul>
                    </div>
                </nav>
                <div class="sidebar-footer">
                    <a href="profile.html" class="nav-item"><span class="nav-item-icon">âš™ï¸</span><span class="nav-item-text">ä¸ªäººè®¾ç½®</span></a>
                    <button class="logout-btn" onclick="Auth.logout()"><span>ğŸšª</span><span>é€€å‡ºç™»å½•</span></button>
                </div>
            </aside>

            <main class="page-main">
                <div class="exercise-page">
                    <!-- æ‰“å¡ç»Ÿè®¡ -->
                    <div class="exercise-section">
                        <h2 class="section-title">ğŸ“Š æ‰“å¡ç»Ÿè®¡</h2>
                        <div class="stats-grid" id="stats-grid">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <span>åŠ è½½ä¸­...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å¿«é€Ÿæ‰“å¡ -->
                    <div class="exercise-section">
                        <h2 class="section-title">ğŸƒ å¿«é€Ÿæ‰“å¡</h2>
                        <div class="checkin-panel">
                            <div class="form-group">
                                <label class="form-label">è¿åŠ¨ç±»å‹</label>
                                <div class="quick-options" id="exercise-types">
                                    <!-- åŠ¨æ€åŠ è½½ -->
                                    <div class="loading">
                                        <div class="loading-spinner"></div>
                                        <span>åŠ è½½è¿åŠ¨ç±»å‹...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <label class="form-label">æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
                                    <div class="quick-options" id="duration-options">
                                        <button class="quick-option active" onclick="setDuration(30)">30åˆ†é’Ÿ</button>
                                        <button class="quick-option" onclick="setDuration(45)">45åˆ†é’Ÿ</button>
                                        <button class="quick-option" onclick="setDuration(60)">60åˆ†é’Ÿ</button>
                                        <div class="input-with-button" style="display: flex; gap: 8px;">
                                            <input type="number" id="custom-duration" class="form-control" placeholder="è‡ªå®šä¹‰" min="5" max="300" style="flex: 1;">
                                            <button class="btn btn-secondary" onclick="setCustomDuration()">ç¡®å®š</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-col">
                                    <label class="form-label">è¿åŠ¨å¼ºåº¦</label>
                                    <div class="quick-options" id="intensity-options">
                                        <button class="quick-option" onclick="setIntensity('low')">ä½å¼ºåº¦</button>
                                        <button class="quick-option active" onclick="setIntensity('medium')">ä¸­ç­‰å¼ºåº¦</button>
                                        <button class="quick-option" onclick="setIntensity('high')">é«˜å¼ºåº¦</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">æ¶ˆè€—çƒ­é‡ä¼°ç®—</label>
                                <div id="calorie-estimate" style="font-size: 1.125rem; color: var(--text-primary);">
                                    çº¦ 0 åƒå¡
                                </div>
                            </div>
                            
                            <button class="btn btn-primary btn-lg" onclick="submitCheckin()" id="checkin-btn" style="width: 100%;">
                                âœ… å®Œæˆæ‰“å¡
                            </button>
                        </div>
                    </div>
                    
                    <!-- æ‰“å¡å†å² -->
                    <div class="exercise-section">
                        <h2 class="section-title">ğŸ“… æ‰“å¡å†å²</h2>
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <button class="btn btn-secondary" onclick="prevMonth()">â€¹ ä¸Šä¸ªæœˆ</button>
                                <h3 id="current-month" style="font-weight: 600; color: var(--text-primary);"></h3>
                                <button class="btn btn-secondary" onclick="nextMonth()">ä¸‹ä¸ªæœˆ â€º</button>
                            </div>
                            <div class="calendar-grid" id="calendar-grid">
                                <!-- åŠ¨æ€ç”Ÿæˆæ—¥å† -->
                            </div>
                        </div>
                        
                        <div style="margin-top: 32px;">
                            <h3 class="section-title">ğŸ“ æœ€è¿‘æ‰“å¡è®°å½•</h3>
                            <div class="history-table-container">
                                <table class="history-table" id="history-table">
                                    <thead>
                                        <tr>
                                            <th>æ—¥æœŸ</th>
                                            <th>è¿åŠ¨ç±»å‹</th>
                                            <th>æ—¶é•¿</th>
                                            <th>å¼ºåº¦</th>
                                            <th>æ¶ˆè€—çƒ­é‡</th>
                                        </tr>
                                    </thead>
                                    <tbody id="history-tbody">
                                        <tr>
                                            <td colspan="5" style="text-align: center; padding: 40px;">
                                                <div class="loading">
                                                    <div class="loading-spinner"></div>
                                                    <span>åŠ è½½å†å²è®°å½•...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/components.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentMonth = new Date();
        let exerciseTypes = [];
        let selectedExercise = null;
        let selectedDuration = 30;
        let selectedIntensity = 'medium';
        let checkinHistory = [];
        let currentStats = null;
        
        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', () => {
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!Auth.check()) {
            window.location.href = 'login.html';
            return;
        }
        
        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        const user = Auth.getUser();
        if (user) {
            const userNameEl = document.querySelector('.user-name');
            const userAvatarEl = document.querySelector('.user-avatar');
            if (userNameEl) userNameEl.textContent = user.nickname || user.name || 'ç”¨æˆ·';
            if (userAvatarEl) userAvatarEl.textContent = (user.nickname || user.name || 'U')[0].toUpperCase();
        }

            loadExerciseTypes();
            loadCheckinStats();
            loadCheckinHistory();
            renderCalendar(currentMonth);
        });
        
        // åŠ è½½è¿åŠ¨ç±»å‹
        async function loadExerciseTypes() {
            try {
                const response = await fetch(`${API.base}/api/exercise/types`, {
                    headers: {
                        'Authorization': `Bearer ${Auth.getToken()}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    exerciseTypes = result.data;
                    renderExerciseTypes();
                }
            } catch (error) {
                console.error('åŠ è½½è¿åŠ¨ç±»å‹å¤±è´¥:', error);
                document.getElementById('exercise-types').innerHTML = 
                    '<div class="alert alert-error">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
            }
        }
        
        // æ¸²æŸ“è¿åŠ¨ç±»å‹é€‰é¡¹
        function renderExerciseTypes() {
            const container = document.getElementById('exercise-types');
            
            if (!exerciseTypes.length) {
                container.innerHTML = '<div class="alert alert-info">æš‚æ— è¿åŠ¨ç±»å‹æ•°æ®</div>';
                return;
            }
            
            container.innerHTML = exerciseTypes.map((type, index) => `
                <button class="quick-option ${index === 0 ? 'active' : ''}" 
                        onclick="selectExercise('${type.type}')"
                        data-type="${type.type}">
                    ${type.type}
                </button>
            `).join('');
            
            if (exerciseTypes.length > 0) {
                selectedExercise = exerciseTypes[0].type;
                updateCalorieEstimate();
            }
        }
        
        // é€‰æ‹©è¿åŠ¨ç±»å‹
        function selectExercise(type) {
            selectedExercise = type;
            
            // æ›´æ–°UI
            document.querySelectorAll('#exercise-types .quick-option').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
            
            updateCalorieEstimate();
        }
        
        // è®¾ç½®æ—¶é•¿
        function setDuration(minutes) {
            selectedDuration = minutes;
            
            // æ›´æ–°UI
            document.querySelectorAll('#duration-options .quick-option').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.querySelectorAll('#duration-options .quick-option').forEach(btn => {
                if (btn.textContent.includes(`${minutes}åˆ†é’Ÿ`)) {
                    btn.classList.add('active');
                }
            });
            
            updateCalorieEstimate();
        }
        
        // è®¾ç½®è‡ªå®šä¹‰æ—¶é•¿
        function setCustomDuration() {
            const input = document.getElementById('custom-duration');
            const minutes = parseInt(input.value);
            
            if (minutes && minutes >= 5 && minutes <= 300) {
                selectedDuration = minutes;
                updateCalorieEstimate();
                input.value = '';
            } else {
                Utils.toast('è¯·è¾“å…¥5-300åˆ†é’Ÿä¹‹é—´çš„æœ‰æ•ˆæ—¶é•¿', 'error');
            }
        }
        
        // è®¾ç½®å¼ºåº¦
        function setIntensity(intensity) {
            selectedIntensity = intensity;
            
            // æ›´æ–°UI
            document.querySelectorAll('#intensity-options .quick-option').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.querySelectorAll('#intensity-options .quick-option').forEach(btn => {
                if (btn.textContent.includes({
                    'low': 'ä½å¼ºåº¦',
                    'medium': 'ä¸­ç­‰å¼ºåº¦', 
                    'high': 'é«˜å¼ºåº¦'
                }[intensity])) {
                    btn.classList.add('active');
                }
            });
            
            updateCalorieEstimate();
        }
        
        // æ›´æ–°çƒ­é‡ä¼°ç®—
        function updateCalorieEstimate() {
            if (!selectedExercise) return;
            
            const type = exerciseTypes.find(t => t.type === selectedExercise);
            if (!type) return;
            
            // åŸºç¡€çƒ­é‡ï¼ˆæ¯å°æ—¶ï¼‰
            const baseCalories = type.calories_per_hour || 200;
            
            // å¼ºåº¦ç³»æ•°
            const intensityFactor = {
                'low': 0.8,
                'medium': 1.0,
                'high': 1.2
            }[selectedIntensity] || 1.0;
            
            // è®¡ç®—æ€»çƒ­é‡
            const calories = Math.round(baseCalories * selectedDuration / 60 * intensityFactor);
            
            document.getElementById('calorie-estimate').innerHTML = 
                `çº¦ <strong>${calories}</strong> åƒå¡`;
        }
        
        // æäº¤æ‰“å¡
        async function submitCheckin() {
            if (!selectedExercise) {
                Utils.toast('è¯·é€‰æ‹©è¿åŠ¨ç±»å‹', 'error');
                return;
            }
            
            const btn = document.getElementById('checkin-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner" style="width: 20px; height: 20px; margin-right: 8px;"></span> æ‰“å¡ä¸­...';
            
            try {
                const response = await fetch(`${API.base}/api/exercise/checkin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${Auth.getToken()}`
                    },
                    body: JSON.stringify({
                        exercise_type: selectedExercise,
                        duration_minutes: selectedDuration,
                        intensity: selectedIntensity
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    Utils.toast('æ‰“å¡æˆåŠŸï¼ç»§ç»­åšæŒå“¦~', 'success');
                    
                    // åˆ·æ–°æ•°æ®
                    loadCheckinStats();
                    loadCheckinHistory();
                    renderCalendar(currentMonth);
                    
                    // é‡ç½®è¡¨å•ï¼ˆä¿ç•™é€‰æ‹©ï¼‰
                    selectedDuration = 30;
                    setDuration(30);
                    selectedIntensity = 'medium';
                    setIntensity('medium');
                    
                    // æ›´æ–°UI
                    document.querySelectorAll('#duration-options .quick-option').forEach(btn => {
                        btn.classList.toggle('active', btn.textContent.includes('30åˆ†é’Ÿ'));
                    });
                    document.querySelectorAll('#intensity-options .quick-option').forEach(btn => {
                        btn.classList.toggle('active', btn.textContent.includes('ä¸­ç­‰å¼ºåº¦'));
                    });
                    
                } else {
                    throw new Error(result.message || 'æ‰“å¡å¤±è´¥');
                }
            } catch (error) {
                console.error('æ‰“å¡å¤±è´¥:', error);
                Utils.toast('æ‰“å¡å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        // åŠ è½½æ‰“å¡ç»Ÿè®¡
        async function loadCheckinStats() {
            try {
                const response = await fetch(`${API.base}/api/exercise/checkins?limit=1`, {
                    headers: {
                        'Authorization': `Bearer ${Auth.getToken()}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentStats = result.stats;
                    renderStats();
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }
        
        // æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡
        function renderStats() {
            const container = document.getElementById('stats-grid');
            
            if (!currentStats) {
                container.innerHTML = '<div class="alert alert-error">åŠ è½½ç»Ÿè®¡å¤±è´¥</div>';
                return;
            }
            
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${currentStats.current_streak || 0}</div>
                    <div class="stat-label">è¿ç»­æ‰“å¡å¤©æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${currentStats.total_checkins || 0}</div>
                    <div class="stat-label">æ€»æ‰“å¡æ¬¡æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${currentStats.last_checkin ? 'âœ“' : '--'}</div>
                    <div class="stat-label">${currentStats.last_checkin ? 'ä»Šæ—¥å·²æ‰“å¡' : 'ä»Šæ—¥æœªæ‰“å¡'}</div>
                </div>
            `;
        }
        
        // åŠ è½½æ‰“å¡å†å²
        async function loadCheckinHistory() {
            try {
                const response = await fetch(`${API.base}/api/exercise/checkins?limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${Auth.getToken()}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    checkinHistory = result.data;
                    renderHistory();
                }
            } catch (error) {
                console.error('åŠ è½½å†å²å¤±è´¥:', error);
            }
        }
        
        // æ¸²æŸ“å†å²è®°å½•
        function renderHistory() {
            const tbody = document.getElementById('history-tbody');
            
            if (!checkinHistory.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            ğŸƒ è¿˜æ²¡æœ‰æ‰“å¡è®°å½•ï¼Œå¿«æ¥å®Œæˆç¬¬ä¸€æ¬¡æ‰“å¡å§ï¼
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = checkinHistory.map(record => {
                const date = new Date(record.checkin_date || record.created_at);
                const dateStr = date.toLocaleDateString('zh-CN');
                
                const intensityClass = {
                    'low': 'intensity-low',
                    'medium': 'intensity-medium',
                    'high': 'intensity-high'
                }[record.intensity] || 'intensity-medium';
                
                const intensityText = {
                    'low': 'ä½å¼ºåº¦',
                    'medium': 'ä¸­ç­‰å¼ºåº¦',
                    'high': 'é«˜å¼ºåº¦'
                }[record.intensity] || 'ä¸­ç­‰å¼ºåº¦';
                
                return `
                    <tr>
                        <td>${dateStr}</td>
                        <td>${record.exercise_type}</td>
                        <td>${record.duration_minutes}åˆ†é’Ÿ</td>
                        <td><span class="intensity-badge ${intensityClass}">${intensityText}</span></td>
                        <td>${record.calories_burned}åƒå¡</td>
                    </tr>
                `;
            }).join('');
        }
        
        // æ—¥å†åŠŸèƒ½
        function renderCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            
            // æ›´æ–°æœˆä»½æ˜¾ç¤º
            document.getElementById('current-month').textContent = 
                `${year}å¹´${month + 1}æœˆ`;
            
            // è·å–å½“æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // è·å–ç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡ ï¼ˆ0=å‘¨æ—¥, 1=å‘¨ä¸€, ...ï¼‰
            const firstDayOfWeek = firstDay.getDay();
            
            // ç”Ÿæˆæ—¥å†ç½‘æ ¼
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            // æ·»åŠ æ˜ŸæœŸæ ‡é¢˜
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            weekdays.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day weekday';
                dayEl.textContent = day;
                grid.appendChild(dayEl);
            });
            
            // æ·»åŠ ç©ºç™½æ ¼å­ï¼ˆä¸Šä¸ªæœˆï¼‰
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyEl = document.createElement('div');
                emptyEl.className = 'calendar-day empty';
                grid.appendChild(emptyEl);
            }
            
            // æ·»åŠ å½“æœˆæ—¥æœŸ
            const today = new Date();
            const todayStr = today.toDateString();
            
            // è·å–å½“æœˆçš„æ‰“å¡æ—¥æœŸ
            const checkinDates = checkinHistory
                .filter(record => record.checkin_date)
                .map(record => {
                    const d = new Date(record.checkin_date);
                    return d.toDateString();
                });
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = day;
                
                const currentDate = new Date(year, month, day);
                const currentDateStr = currentDate.toDateString();
                
                // æ ‡è®°ä»Šå¤©
                if (currentDateStr === todayStr) {
                    dayEl.classList.add('today');
                }
                
                // æ ‡è®°æ‰“å¡æ—¥
                if (checkinDates.includes(currentDateStr)) {
                    dayEl.classList.add('checkin');
                    dayEl.title = 'å·²æ‰“å¡';
                }
                
                grid.appendChild(dayEl);
            }
        }
        
        // ä¸Šä¸ªæœˆ
        function prevMonth() {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
            renderCalendar(currentMonth);
        }
        
        // ä¸‹ä¸ªæœˆ
        function nextMonth() {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
            renderCalendar(currentMonth);
        }
    </script>
</body>
</html>