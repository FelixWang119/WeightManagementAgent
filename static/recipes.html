<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥åº·é£Ÿè°± - ä½“é‡ç®¡ç†åŠ©æ‰‹</title>
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/layout.css">
    <style>
        .recipes-page {
            padding-bottom: 24px;
        }
        
        /* é¡µé¢æ ‡é¢˜ */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .page-subtitle {
            font-size: 1rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        /* æœç´¢å’Œè¿‡æ»¤ */
        .recipes-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 8px;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            background: var(--surface);
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 0.875rem;
        }
        
        .filter-btn:hover {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.05);
        }
        
        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* é£Ÿè°±ç½‘æ ¼ */
        .recipes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .recipe-card {
            background: var(--surface);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
            cursor: pointer;
        }
        
        .recipe-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }
        
        .recipe-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: var(--background-secondary);
        }
        
        .recipe-content {
            padding: 20px;
        }
        
        .recipe-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .recipe-description {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 12px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .recipe-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border-light);
        }
        
        .recipe-calories {
            font-size: 0.875rem;
            color: var(--meal-color);
            font-weight: 500;
        }
        
        .recipe-difficulty {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 12px;
            background: var(--background-secondary);
            color: var(--text-muted);
        }
        
        .recipe-difficulty.easy {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success-color);
        }
        
        .recipe-difficulty.medium {
            background: rgba(241, 196, 15, 0.1);
            color: var(--warning-color);
        }
        
        .recipe-difficulty.hard {
            background: rgba(231, 76, 60, 0.1);
            color: var(--error-color);
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .recipes-grid {
                grid-template-columns: 1fr;
            }
            
            .recipes-controls {
                flex-direction: column;
            }
            
            .search-box {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="top-nav">
            <div class="nav-left">
                <button class="menu-btn" onclick="toggleSidebar()">
                    <span>â˜°</span>
                </button>
                <div class="logo">
                    <span class="logo-icon">âš–ï¸</span>
                    <span class="logo-text">ä½“é‡ç®¡ç†åŠ©æ‰‹</span>
                </div>
            </div>
            
            <div class="nav-center">
                <div class="date-display" id="current-date"></div>
            </div>
            
            <div class="nav-right">
                <div class="user-menu">
                    <div class="user-avatar-small" id="user-avatar">ç”¨</div>
                </div>
            </div>
        </header>

        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="user-avatar">ç”¨</div>
                <div class="user-info">
                    <div class="user-name">åŠ è½½ä¸­...</div>
                    <div class="user-status">åœ¨çº¿</div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">ä¸»è¦åŠŸèƒ½</div>
                    <ul class="nav-list">
                        <li><a href="index.html" class="nav-item"><span class="nav-item-icon">ğŸ¤–</span><span class="nav-item-text">AIåŠ©æ‰‹</span></a></li>
                        <li><a href="weight.html" class="nav-item"><span class="nav-item-icon">âš–ï¸</span><span class="nav-item-text">ä½“é‡è®°å½•</span></a></li>
                        <li><a href="meal.html" class="nav-item"><span class="nav-item-icon">ğŸ½ï¸</span><span class="nav-item-text">é¥®é£Ÿè®°å½•</span></a></li>
                        <li><a href="exercise.html" class="nav-item"><span class="nav-item-icon">ğŸƒ</span><span class="nav-item-text">è¿åŠ¨è®°å½•</span></a></li>
                    </ul>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">å¥åº·ç®¡ç†</div>
                    <ul class="nav-list">
                        <li><a href="water.html" class="nav-item"><span class="nav-item-icon">ğŸ’§</span><span class="nav-item-text">é¥®æ°´è®°å½•</span></a></li>
                        <li><a href="sleep.html" class="nav-item"><span class="nav-item-icon">ğŸ˜´</span><span class="nav-item-text">ç¡çœ è®°å½•</span></a></li>
                        <li><a href="report.html" class="nav-item"><span class="nav-item-icon">ğŸ“Š</span><span class="nav-item-text">æ•°æ®æŠ¥å‘Š</span></a></li>
                        <li><a href="goals.html" class="nav-item"><span class="nav-item-icon">ğŸ¯</span><span class="nav-item-text">ç›®æ ‡ç®¡ç†</span></a></li>
                        <li><a href="calculator.html" class="nav-item"><span class="nav-item-icon">ğŸ”¥</span><span class="nav-item-text">çƒ­é‡è®¡ç®—</span></a></li>
                        <li><a href="reminders.html" class="nav-item"><span class="nav-item-icon">ğŸ””</span><span class="nav-item-text">æé†’è®¾ç½®</span></a></li>
                        <li><a href="recipes.html" class="nav-item active"><span class="nav-item-icon">ğŸ“–</span><span class="nav-item-text">å¥åº·é£Ÿè°±</span></a></li>
                    </ul>
                </div>
            </nav>

            <div class="sidebar-footer">
                <a href="profile.html" class="nav-item"><span class="nav-item-icon">âš™ï¸</span><span class="nav-item-text">ä¸ªäººè®¾ç½®</span></a>
                <button class="logout-btn" onclick="Auth.logout()">
                    <span>ğŸšª</span>
                    <span>é€€å‡ºç™»å½•</span>
                </button>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="page-main">
            <div class="recipes-page">
                <!-- é¡µé¢æ ‡é¢˜ -->
                <div class="page-header">
                    <div>
                        <h1 class="page-title">å¥åº·é£Ÿè°±</h1>
                        <p class="page-subtitle">å‘ç°é€‚åˆå‡é‡æœŸçš„ç¾å‘³å¥åº·é£Ÿè°±</p>
                    </div>
                </div>

                <!-- æœç´¢å’Œè¿‡æ»¤ -->
                <div class="recipes-controls">
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="æœç´¢é£Ÿè°±åç§°æˆ–é£Ÿæ..." class="input-field">
                    </div>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
                        <button class="filter-btn" data-filter="breakfast">æ—©é¤</button>
                        <button class="filter-btn" data-filter="lunch">åˆé¤</button>
                        <button class="filter-btn" data-filter="dinner">æ™šé¤</button>
                        <button class="filter-btn" data-filter="snack">åŠ é¤</button>
                    </div>
                </div>

                <!-- é£Ÿè°±åˆ—è¡¨ -->
                <div id="recipes-container">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>æ­£åœ¨åŠ è½½é£Ÿè°±...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- é£Ÿè°±è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal" id="recipe-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-recipe-title">é£Ÿè°±è¯¦æƒ…</h3>
                <button class="modal-close" onclick="closeRecipeModal()">Ã—</button>
            </div>
            <div class="modal-body" id="modal-recipe-content">
                <!-- åŠ¨æ€åŠ è½½é£Ÿè°±è¯¦æƒ… -->
            </div>
        </div>
    </div>

    <script src="/static/js/auth.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/utils.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let allRecipes = [];
        let currentFilter = 'all';
        let currentSearch = '';

        // DOM åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded: å¼€å§‹åˆå§‹åŒ–é£Ÿè°±é¡µé¢');
            
            try {
                // åˆå§‹åŒ–ä¾§è¾¹æ å’Œç”¨æˆ·ä¿¡æ¯
                console.log('åˆå§‹åŒ–ä¾§è¾¹æ ...');
                initSidebar();
                console.log('åŠ è½½ç”¨æˆ·ä¿¡æ¯...');
                loadUserInfo();
                
                // è®¾ç½®å½“å‰æ—¥æœŸ
                const now = new Date();
                const dateStr = now.toLocaleDateString('zh-CN', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'long'
                });
                document.getElementById('current-date').textContent = dateStr;
                console.log('å½“å‰æ—¥æœŸè®¾ç½®å®Œæˆ:', dateStr);
                
                // æ£€æŸ¥APIå¯¹è±¡æ˜¯å¦å¯ç”¨
                if (typeof API === 'undefined') {
                    console.error('APIå¯¹è±¡æœªå®šä¹‰ï¼');
                    showError('APIåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
                    return;
                }
                
                if (typeof API.recipes === 'undefined') {
                    console.error('API.recipesæœªå®šä¹‰ï¼');
                    showError('é£Ÿè°±APIæœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢');
                    return;
                }
                
                console.log('APIå¯¹è±¡æ£€æŸ¥é€šè¿‡ï¼Œå¼€å§‹åŠ è½½é£Ÿè°±æ•°æ®...');
                
                // åŠ è½½é£Ÿè°±æ•°æ®
                loadRecipes();
                
                // ç»‘å®šæœç´¢äº‹ä»¶
                document.getElementById('search-input').addEventListener('input', function(e) {
                    currentSearch = e.target.value.trim().toLowerCase();
                    filterRecipes();
                });
                
                // ç»‘å®šè¿‡æ»¤æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        // ç»™å½“å‰æŒ‰é’®æ·»åŠ activeç±»
                        this.classList.add('active');
                        // æ›´æ–°å½“å‰è¿‡æ»¤å™¨
                        currentFilter = this.dataset.filter;
                        filterRecipes();
                    });
                });
                
                console.log('é£Ÿè°±é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                showError('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        });

        // åŠ è½½é£Ÿè°±æ•°æ®
        async function loadRecipes() {
            console.log('å¼€å§‹åŠ è½½é£Ÿè°±æ•°æ®...');
            const container = document.getElementById('recipes-container');
            
            try {
                console.log('è°ƒç”¨API.recipes.getAll()...');
                const response = await API.recipes.getAll();
                console.log('APIå“åº”:', response);
                
                // APIç›´æ¥è¿”å›æ•°æ®å¯¹è±¡ï¼Œæ²¡æœ‰successå­—æ®µ
                if (response && response.recipes !== undefined) {
                    allRecipes = response.recipes || [];
                    console.log(`è·å–åˆ° ${allRecipes.length} ä¸ªé£Ÿè°±`);
                    renderRecipes(allRecipes);
                } else {
                    console.error('APIè¿”å›æ ¼å¼å¼‚å¸¸:', response);
                    showError('åŠ è½½é£Ÿè°±å¤±è´¥: APIè¿”å›æ ¼å¼å¼‚å¸¸');
                    
                    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">âŒ</div>
                            <p>åŠ è½½é£Ÿè°±å¤±è´¥</p>
                            <p class="text-muted">APIè¿”å›æ ¼å¼å¼‚å¸¸</p>
                            <button onclick="loadRecipes()" style="margin-top: 16px; padding: 8px 16px;">é‡è¯•</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½é£Ÿè°±å‡ºé”™:', error);
                showError('åŠ è½½é£Ÿè°±æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
                
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âš ï¸</div>
                        <p>ç½‘ç»œè¿æ¥é”™è¯¯</p>
                        <p class="text-muted">${error.message}</p>
                        <button onclick="loadRecipes()" style="margin-top: 16px; padding: 8px 16px;">é‡è¯•</button>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“é£Ÿè°±åˆ—è¡¨
        function renderRecipes(recipes) {
            const container = document.getElementById('recipes-container');
            
            if (recipes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“–</div>
                        <p>æš‚æ— é£Ÿè°±æ•°æ®</p>
                        <p class="text-muted">è¯·ç¨åå†è¯•æˆ–è”ç³»ç®¡ç†å‘˜</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="recipes-grid">';
            
            recipes.forEach(recipe => {
                const difficultyClass = getDifficultyClass(recipe.difficulty);
                const difficultyText = getDifficultyText(recipe.difficulty);
                const mealType = recipe.category || 'general';  // ä½¿ç”¨categoryä½œä¸ºmeal_type
                const calories = recipe.calories_per_serving || recipe.calories;
                
                html += `
                    <div class="recipe-card" data-id="${recipe.id}" data-meal-type="${mealType}">
                        <div class="recipe-image-placeholder">
                             <img src="${recipe.image_url || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDMwMCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjMwMCIgaGVpZ2h0PSIxODAiIGZpbGw9IiM0YTkwZTIiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPua0u+WkqeWbvueJhzwvdGV4dD48L3N2Zz4='}" 
                                  alt="${recipe.name}" 
                                  class="recipe-image"
                                  onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDMwMCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjMwMCIgaGVpZ2h0PSIxODAiIGZpbGw9IiNlMGUwZTAiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNjY2NjY2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+5Zu+54mH5Yqg5YWl5aSx6LSlPC90ZXh0Pjwvc3ZnPg=='">
                        </div>
                        <div class="recipe-content">
                            <h3 class="recipe-title">${recipe.name}</h3>
                            <p class="recipe-description">${recipe.description || 'æš‚æ— æè¿°'}</p>
                            <div class="recipe-meta">
                                <div class="recipe-calories">
                                    ${calories ? calories + ' å¤§å¡/ä»½' : 'çƒ­é‡æœªæ ‡æ³¨'}
                                </div>
                                <div class="recipe-difficulty ${difficultyClass}">
                                    ${difficultyText}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.recipe-card').forEach(card => {
                card.addEventListener('click', function() {
                    const recipeId = this.dataset.id;
                    showRecipeDetails(recipeId);
                });
            });
        }

        // è¿‡æ»¤é£Ÿè°±
        function filterRecipes() {
            let filtered = allRecipes;
            
            // åº”ç”¨æœç´¢è¿‡æ»¤
            if (currentSearch) {
                filtered = filtered.filter(recipe => 
                    recipe.name.toLowerCase().includes(currentSearch) ||
                    (recipe.description && recipe.description.toLowerCase().includes(currentSearch)) ||
                    (recipe.ingredients && recipe.ingredients.some(ing => 
                        ing.ingredient_name && ing.ingredient_name.toLowerCase().includes(currentSearch)
                    ))
                );
            }
            
            // åº”ç”¨ç±»å‹è¿‡æ»¤
            if (currentFilter !== 'all') {
                filtered = filtered.filter(recipe => 
                    (recipe.category || 'general') === currentFilter
                );
            }
            
            renderRecipes(filtered);
        }

        // æ˜¾ç¤ºé£Ÿè°±è¯¦æƒ…
        async function showRecipeDetails(recipeId) {
            try {
                const recipe = await API.recipes.getById(recipeId);
                if (recipe && recipe.id) {
                    renderRecipeModal(recipe);
                    openRecipeModal();
                } else {
                    showError('è·å–é£Ÿè°±è¯¦æƒ…å¤±è´¥: æ— æ•ˆçš„å“åº”æ•°æ®');
                }
            } catch (error) {
                console.error('è·å–é£Ÿè°±è¯¦æƒ…å‡ºé”™:', error);
                showError('è·å–é£Ÿè°±è¯¦æƒ…æ—¶å‘ç”Ÿé”™è¯¯');
            }
        }

        // æ¸²æŸ“é£Ÿè°±è¯¦æƒ…æ¨¡æ€æ¡†
        function renderRecipeModal(recipe) {
            const difficultyClass = getDifficultyClass(recipe.difficulty);
            const difficultyText = getDifficultyText(recipe.difficulty);
            const prepTime = recipe.prep_time || 'æœªæŒ‡å®š';
            const cookTime = recipe.cook_time || 'æœªæŒ‡å®š';
            const servings = recipe.servings || 'æœªæŒ‡å®š';
            
            // æ„å»ºé£Ÿæåˆ—è¡¨
            let ingredientsHtml = '';
            if (recipe.ingredients && recipe.ingredients.length > 0) {
                ingredientsHtml = '<ul class="ingredients-list">';
                 recipe.ingredients.forEach(ing => {
                    ingredientsHtml += `
                        <li>
                            <span class="ingredient-name">${ing.ingredient_name || 'æœªçŸ¥é£Ÿæ'}</span>
                            <span class="ingredient-amount">${ing.quantity || ''} ${ing.unit || ''}</span>
                        </li>
                    `;
                });
                ingredientsHtml += '</ul>';
            } else {
                ingredientsHtml = '<p class="text-muted">æš‚æ— é£Ÿæä¿¡æ¯</p>';
            }
            
            // æ„å»ºæ­¥éª¤åˆ—è¡¨
            let stepsHtml = '';
            if (recipe.steps && recipe.steps.length > 0) {
                stepsHtml = '<ol class="steps-list">';
                recipe.steps.forEach((step, index) => {
                    stepsHtml += `
                        <li>
                            <div class="step-number">${index + 1}</div>
                            <div class="step-content">
                                <p>${step.description || 'æš‚æ— æè¿°'}</p>
                                ${step.image_url ? `<img src="${step.image_url}" alt="æ­¥éª¤ ${index + 1}" class="step-image">` : ''}
                            </div>
                        </li>
                    `;
                });
                stepsHtml += '</ol>';
            } else {
                stepsHtml = '<p class="text-muted">æš‚æ— æ­¥éª¤ä¿¡æ¯</p>';
            }
            
            const modalContent = document.getElementById('modal-recipe-content');
            modalContent.innerHTML = `
                <div class="recipe-detail">
                    <div class="recipe-header">
                        <div class="recipe-image-large">
                             <img src="${recipe.image_url || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDYwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjYwMCIgaGVpZ2h0PSIzMDAiIGZpbGw9IiM0YTkwZTIiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE4IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPua0u+WkqeWbvueJhzwvdGV4dD48L3N2Zz4='}" 
                                  alt="${recipe.name}"
                                  onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDYwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjYwMCIgaGVpZ2h0PSIzMDAiIGZpbGw9IiNlMGUwZTAiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE4IiBmaWxsPSIjNjY2NjY2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+5Zu+54mH5Yqg5YWl5aSx6LSlPC90ZXh0Pjwvc3ZnPg=='">
                        </div>
                        <div class="recipe-info">
                            <h2>${recipe.name}</h2>
                            <p class="recipe-description-detail">${recipe.description || 'æš‚æ— æè¿°'}</p>
                            
                            <div class="recipe-meta-detail">
                                <div class="meta-item">
                                    <span class="meta-label">çƒ­é‡</span>
                                    <span class="meta-value">${recipe.calories || 'æœªæ ‡æ³¨'} å¤§å¡</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">éš¾åº¦</span>
                                    <span class="meta-value ${difficultyClass}">${difficultyText}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">å‡†å¤‡æ—¶é—´</span>
                                    <span class="meta-value">${prepTime} åˆ†é’Ÿ</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">çƒ¹é¥ªæ—¶é—´</span>
                                    <span class="meta-value">${cookTime} åˆ†é’Ÿ</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">ä»½é‡</span>
                                    <span class="meta-value">${servings} äººä»½</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">é¤å‹</span>
                                    <span class="meta-value">${getCategoryText(recipe.category)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="recipe-sections">
                        <div class="section">
                            <h3>ğŸ“ é£Ÿææ¸…å•</h3>
                            ${ingredientsHtml}
                        </div>
                        
                        <div class="section">
                            <h3>ğŸ‘¨â€ğŸ³ çƒ¹é¥ªæ­¥éª¤</h3>
                            ${stepsHtml}
                        </div>
                        
                        <div class="section">
                            <h3>ğŸ’¡ å°è´´å£«</h3>
                            <p>${recipe.tips || 'æš‚æ— å°è´´å£«'}</p>
                        </div>
                    </div>
                    
                    <div class="recipe-actions">
                        <button class="btn btn-primary" onclick="addToFavorites('${recipe.id}')">
                            <span>â¤ï¸</span> æ·»åŠ åˆ°æ”¶è—
                        </button>
                        <button class="btn btn-secondary" onclick="markAsCooked('${recipe.id}')">
                            <span>ğŸ‘¨â€ğŸ³</span> æ ‡è®°ä¸ºå·²çƒ¹é¥ª
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-recipe-title').textContent = recipe.name;
            
            // æ·»åŠ CSSæ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                .recipe-detail {
                    max-width: 800px;
                    margin: 0 auto;
                }
                
                .recipe-header {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 32px;
                    margin-bottom: 32px;
                }
                
                @media (max-width: 768px) {
                    .recipe-header {
                        grid-template-columns: 1fr;
                    }
                }
                
                .recipe-image-large img {
                    width: 100%;
                    height: 300px;
                    object-fit: cover;
                    border-radius: var(--border-radius);
                }
                
                .recipe-info h2 {
                    font-size: 1.5rem;
                    margin-bottom: 12px;
                }
                
                .recipe-description-detail {
                    color: var(--text-muted);
                    margin-bottom: 24px;
                    line-height: 1.6;
                }
                
                .recipe-meta-detail {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 16px;
                }
                
                @media (max-width: 480px) {
                    .recipe-meta-detail {
                        grid-template-columns: repeat(2, 1fr);
                    }
                }
                
                .meta-item {
                    background: var(--background-secondary);
                    padding: 12px;
                    border-radius: var(--border-radius);
                }
                
                .meta-label {
                    display: block;
                    font-size: 0.75rem;
                    color: var(--text-muted);
                    margin-bottom: 4px;
                }
                
                .meta-value {
                    display: block;
                    font-weight: 500;
                }
                
                .recipe-sections {
                    display: grid;
                    gap: 32px;
                    margin-bottom: 32px;
                }
                
                .section h3 {
                    font-size: 1.125rem;
                    margin-bottom: 16px;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }
                
                .ingredients-list {
                    list-style: none;
                    padding: 0;
                }
                
                .ingredients-list li {
                    display: flex;
                    justify-content: space-between;
                    padding: 8px 0;
                    border-bottom: 1px solid var(--border-light);
                }
                
                .ingredients-list li:last-child {
                    border-bottom: none;
                }
                
                .steps-list {
                    list-style: none;
                    padding: 0;
                    counter-reset: step-counter;
                }
                
                .steps-list li {
                    display: flex;
                    gap: 16px;
                    margin-bottom: 24px;
                    counter-increment: step-counter;
                }
                
                .step-number {
                    flex-shrink: 0;
                    width: 32px;
                    height: 32px;
                    background: var(--primary-color);
                    color: white;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: 600;
                }
                
                .step-content {
                    flex: 1;
                }
                
                .step-image {
                    max-width: 100%;
                    height: auto;
                    border-radius: var(--border-radius);
                    margin-top: 8px;
                }
                
                .recipe-actions {
                    display: flex;
                    gap: 12px;
                    justify-content: center;
                    padding-top: 24px;
                    border-top: 1px solid var(--border);
                }
            `;
            
            // ç§»é™¤æ—§çš„æ ·å¼ï¼ˆå¦‚æœæœ‰ï¼‰
            const oldStyle = document.getElementById('recipe-modal-style');
            if (oldStyle) oldStyle.remove();
            
            style.id = 'recipe-modal-style';
            document.head.appendChild(style);
        }

        // è¾…åŠ©å‡½æ•°
        function getDifficultyClass(difficulty) {
            switch(difficulty) {
                case 'easy': return 'easy';
                case 'medium': return 'medium';
                case 'hard': return 'hard';
                default: return '';
            }
        }

        function getDifficultyText(difficulty) {
            switch(difficulty) {
                case 'easy': return 'ç®€å•';
                case 'medium': return 'ä¸­ç­‰';
                case 'hard': return 'å›°éš¾';
                default: return 'æœªæŒ‡å®š';
            }
        }

        function getCategoryText(category) {
            switch(category) {
                case 'breakfast': return 'æ—©é¤';
                case 'lunch': return 'åˆé¤';
                case 'dinner': return 'æ™šé¤';
                case 'snack': return 'åŠ é¤';
                default: return 'é€šç”¨';
            }
        }

        // æ¨¡æ€æ¡†æ§åˆ¶
        function openRecipeModal() {
            document.getElementById('recipe-modal').style.display = 'block';
        }

        function closeRecipeModal() {
            document.getElementById('recipe-modal').style.display = 'none';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('recipe-modal');
            if (event.target === modal) {
                closeRecipeModal();
            }
        }

        // æ·»åŠ åˆ°æ”¶è—
        async function addToFavorites(recipeId) {
            try {
                const response = await API.recipes.addToFavorites(recipeId);
                if (response && response.message) {
                    showSuccess(response.message);
                } else {
                    showError('æ·»åŠ åˆ°æ”¶è—å¤±è´¥');
                }
            } catch (error) {
                console.error('æ·»åŠ åˆ°æ”¶è—å‡ºé”™:', error);
                showError('æ·»åŠ åˆ°æ”¶è—æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            }
        }

        // æ ‡è®°ä¸ºå·²çƒ¹é¥ª
        async function markAsCooked(recipeId) {
            try {
                const response = await API.recipes.markAsCooked(recipeId);
                if (response && response.message) {
                    showSuccess(response.message);
                } else {
                    showError('æ ‡è®°å¤±è´¥');
                }
            } catch (error) {
                console.error('æ ‡è®°ä¸ºå·²çƒ¹é¥ªå‡ºé”™:', error);
                showError('æ ‡è®°ä¸ºå·²çƒ¹é¥ªæ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            }
        }

        // ä¾§è¾¹æ æ§åˆ¶
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function initSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            overlay.addEventListener('click', function() {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            });
        }

        // ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            try {
                const user = Auth.getUser();
                if (user) {
                    const nameElements = document.querySelectorAll('.user-name');
                    nameElements.forEach(el => {
                        el.textContent = user.username || 'ç”¨æˆ·';
                    });
                    
                    const avatarElements = document.querySelectorAll('.user-avatar, .user-avatar-small');
                    avatarElements.forEach(el => {
                        el.textContent = (user.username || 'ç”¨').charAt(0);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å‡ºé”™:', error);
            }
        }

        // æ¶ˆæ¯æç¤º
        function showSuccess(message) {
            if (typeof Utils !== 'undefined' && Utils.toast) {
                Utils.toast(message, 'success');
            } else {
                console.log('æˆåŠŸ:', message);
                alert(message);
            }
        }

        function showError(message) {
            if (typeof Utils !== 'undefined' && Utils.toast) {
                Utils.toast(message, 'error');
            } else {
                console.error('é”™è¯¯:', message);
                alert('é”™è¯¯: ' + message);
            }
        }
    </script>
</body>
</html>