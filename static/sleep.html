<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <title>ç¡çœ è®°å½• - ä½“é‡ç®¡ç†åŠ©æ‰‹</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/layout.css">
    <style>
        .sleep-page { padding: 20px; max-width: 800px; margin: 0 auto; }
        .sleep-card { background: var(--surface); border-radius: var(--border-radius); padding: 24px; margin-bottom: 20px; box-shadow: var(--shadow-sm); }
        .sleep-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-item { text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: var(--border-radius); }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }
        .sleep-form { display: grid; gap: 16px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media (max-width: 480px) { .form-row { grid-template-columns: 1fr; } }
        .quality-selector { display: flex; gap: 8px; justify-content: center; margin-top: 8px; }
        .quality-btn { padding: 8px 16px; border: 2px solid var(--border); border-radius: 20px; background: var(--surface); cursor: pointer; transition: all 0.2s; }
        .quality-btn:hover { border-color: var(--primary-color); }
        .quality-btn.selected { border-color: var(--primary-color); background: rgba(52, 152, 219, 0.1); color: var(--primary-color); }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg-secondary); border-radius: var(--border-radius); margin-bottom: 12px; }
        .history-date { font-weight: 600; }
        .history-duration { color: var(--primary-color); font-weight: 600; }
        .history-quality { padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; }
        .quality-good { background: rgba(46, 204, 113, 0.1); color: #2ecc71; }
        .quality-medium { background: rgba(241, 196, 15, 0.1); color: #f39c12; }
        .quality-poor { background: rgba(231, 76, 60, 0.1); color: #e74c3c; }
        .empty-state { text-align: center; padding: 40px; color: var(--text-muted); }
        .time-input-group { display: flex; gap: 8px; align-items: center; }
        .time-input { flex: 2; padding: 12px; border: 2px solid var(--border); border-radius: var(--border-radius); font-size: 1rem; }
        .period-select { flex: 1; padding: 12px; border: 2px solid var(--border); border-radius: var(--border-radius); font-size: 1rem; background: var(--surface); cursor: pointer; }
        .period-select:focus, .time-input:focus { outline: none; border-color: var(--primary-color); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: var(--surface); border-radius: var(--border-radius); padding: 24px; max-width: 400px; width: 90%; box-shadow: var(--shadow-lg); }
        .modal-title { font-size: 1.25rem; font-weight: bold; margin-bottom: 16px; }
        .modal-content { margin-bottom: 24px; }
        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; }
        .modal-btn { padding: 10px 20px; border-radius: var(--border-radius); cursor: pointer; font-size: 1rem; }
        .modal-btn-cancel { background: var(--bg-secondary); border: none; }
        .modal-btn-confirm { background: var(--primary-color); color: white; border: none; }
        .duplicate-info { background: var(--bg-secondary); padding: 16px; border-radius: var(--border-radius); margin-top: 12px; }
    </style>
</head>
<body>
    <div class="page">
        <header class="page-header">
            <div class="header-brand">
                <a href="index.html" class="menu-toggle" style="margin-right: 12px; text-decoration: none; display: flex; align-items: center;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </a>
                <span class="header-brand-icon">ğŸ˜´</span>
                <span>ç¡çœ è®°å½•</span>
            </div>
            <div class="header-actions">
                <button class="menu-toggle" id="menu-toggle" title="æ‰“å¼€èœå•"><span></span></button>
            </div>
        </header>

        <div class="page-content">
            <div class="sidebar-overlay" id="sidebar-overlay"></div>
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="user-avatar">ç”¨</div>
                    <div class="user-info"><div class="user-name">åŠ è½½ä¸­...</div><div class="user-status">åœ¨çº¿</div></div>
                </div>
                <nav class="sidebar-nav">
                    <div class="nav-section"><div class="nav-section-title">ä¸»è¦åŠŸèƒ½</div>
                        <ul class="nav-list">
                            <li><a href="index.html" class="nav-item"><span class="nav-item-icon">ğŸ¤–</span><span class="nav-item-text">AIåŠ©æ‰‹</span></a></li>
                            <li><a href="weight.html" class="nav-item"><span class="nav-item-icon">âš–ï¸</span><span class="nav-item-text">ä½“é‡è®°å½•</span></a></li>
                            <li><a href="meal.html" class="nav-item"><span class="nav-item-icon">ğŸ½ï¸</span><span class="nav-item-text">é¥®é£Ÿè®°å½•</span></a></li>
                            <li><a href="exercise.html" class="nav-item"><span class="nav-item-icon">ğŸƒ</span><span class="nav-item-text">è¿åŠ¨è®°å½•</span></a></li>
                        </ul>
                    </div>
                    <div class="nav-section"><div class="nav-section-title">å¥åº·ç®¡ç†</div>
                        <ul class="nav-list">
                            <li><a href="water.html" class="nav-item"><span class="nav-item-icon">ğŸ’§</span><span class="nav-item-text">é¥®æ°´è®°å½•</span></a></li>
                            <li><a href="sleep.html" class="nav-item active"><span class="nav-item-icon">ğŸ˜´</span><span class="nav-item-text">ç¡çœ è®°å½•</span></a></li>
                            <li><a href="report.html" class="nav-item"><span class="nav-item-icon">ğŸ“Š</span><span class="nav-item-text">æ•°æ®æŠ¥å‘Š</span></a></li>
                            <li><a href="goals.html" class="nav-item"><span class="nav-item-icon">ğŸ¯</span><span class="nav-item-text">ç›®æ ‡ç®¡ç†</span></a></li>
                            <li><a href="calculator.html" class="nav-item"><span class="nav-item-icon">ğŸ”¥</span><span class="nav-item-text">çƒ­é‡è®¡ç®—</span></a></li>

                                                    <li><a href="recipes.html" class="nav-item"><span class="nav-item-icon">ğŸ“–</span><span class="nav-item-text">å¥åº·é£Ÿè°±</span></a></li>
                            <li><a href="reminders.html" class="nav-item"><span class="nav-item-icon">ğŸ””</span><span class="nav-item-text">æé†’è®¾ç½®</span></a></li>
                        </ul>
                    </div>
                </nav>
                <div class="sidebar-footer">
                    <a href="profile.html" class="nav-item"><span class="nav-item-icon">âš™ï¸</span><span class="nav-item-text">ä¸ªäººè®¾ç½®</span></a>
                    <button class="logout-btn" onclick="Auth.logout()"><span>ğŸšª</span><span>é€€å‡ºç™»å½•</span></button>
                </div>
            </aside>

            <main class="page-main">
                <div class="sleep-page">
                    <div class="sleep-card">
                        <h3 style="margin-bottom: 20px; color: var(--text-primary);">è®°å½•æ˜¨æ™šç¡çœ </h3>
                        <div class="sleep-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">å…¥ç¡æ—¶é—´</label>
                                    <div class="time-input-group">
                                        <input type="time" class="time-input" id="bedtime" value="23:00">
                                        <select class="period-select" id="bedPeriod">
                                            <option value="PM" selected>PM</option>
                                            <option value="AM">AM</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">èµ·åºŠæ—¶é—´</label>
                                    <div class="time-input-group">
                                        <input type="time" class="time-input" id="waketime" value="07:00">
                                        <select class="period-select" id="wakePeriod">
                                            <option value="AM" selected>AM</option>
                                            <option value="PM">PM</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ç¡çœ è´¨é‡</label>
                                <div class="quality-selector">
                                    <button class="quality-btn" data-quality="poor" onclick="selectQuality('poor')">ğŸ˜« å·®</button>
                                    <button class="quality-btn selected" data-quality="medium" onclick="selectQuality('medium')">ğŸ˜ ä¸€èˆ¬</button>
                                    <button class="quality-btn" data-quality="good" onclick="selectQuality('good')">ğŸ˜Š å¥½</button>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="saveSleep()" style="width: 100%;">
                                <span style="margin-right: 8px;">ğŸ’¾</span>ä¿å­˜è®°å½•
                            </button>
                        </div>
                    </div>

                    <div class="sleep-card">
                        <h3 style="margin-bottom: 16px; color: var(--text-primary);">ç¡çœ ç»Ÿè®¡</h3>
                        <div class="sleep-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="avg-duration">--</div>
                                <div class="stat-label">å¹³å‡æ—¶é•¿</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="avg-quality">--</div>
                                <div class="stat-label">å¹³å‡è´¨é‡</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="total-records">--</div>
                                <div class="stat-label">è®°å½•å¤©æ•°</div>
                            </div>
                        </div>
                    </div>

                    <div class="sleep-card">
                        <h3 style="margin-bottom: 16px; color: var(--text-primary);">æœ€è¿‘è®°å½•</h3>
                        <div id="history-list">
                            <div class="empty-state">æš‚æ— ç¡çœ è®°å½•</div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="duplicateModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-title">âš ï¸ é‡å¤è®°å½•æé†’</div>
            <div class="modal-content">
                <p>è¯¥æ—¥æœŸå·²æœ‰ç¡çœ è®°å½•ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ</p>
                <div class="duplicate-info" id="duplicateInfo">
                    <div><strong>åŸè®°å½•ï¼š</strong></div>
                    <div id="duplicateDetails"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeDuplicateModal()">å–æ¶ˆ</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmOverwrite()">è¦†ç›–</button>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/components.js"></script>
    <script>
        let selectedQuality = 'medium';
        let pendingSaveData = null;
        let duplicateRecordId = null;

        function selectQuality(quality) {
            selectedQuality = quality;
            document.querySelectorAll('.quality-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.quality === quality);
            });
        }

        async function init() {
            if (!Auth.check()) {
                window.location.href = 'login.html';
                return;
            }
            await loadUserInfo();
            await loadSleepHistory();
        }

        async function loadUserInfo() {
            try {
                const user = Auth.getUser();
                if (user) {
                    document.querySelector('.user-name').textContent = user.nickname || user.name || 'ç”¨æˆ·';
                    document.querySelector('.user-avatar').textContent = (user.nickname || user.name || 'U')[0].toUpperCase();
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        async function loadSleepHistory() {
            try {
                const response = await API.sleep.getHistory(7);
                if (response.success && response.data) {
                    updateStats(response.data);
                    renderHistory(response.data);
                }
            } catch (error) {
                console.error('åŠ è½½ç¡çœ è®°å½•å¤±è´¥:', error);
            }
        }

        function updateStats(records) {
            if (records.length === 0) {
                document.getElementById('avg-duration').textContent = '--';
                document.getElementById('avg-quality').textContent = '--';
                document.getElementById('total-records').textContent = '0';
                return;
            }

            const totalDuration = records.reduce((sum, r) => sum + (r.duration_hours || 0), 0);
            const avgDuration = (totalDuration / records.length).toFixed(1);
            document.getElementById('avg-duration').textContent = avgDuration + 'h';

            const totalQuality = records.reduce((sum, r) => sum + (r.quality || 3), 0);
            const avgQuality = (totalQuality / records.length).toFixed(1);
            document.getElementById('avg-quality').textContent = avgQuality;

            document.getElementById('total-records').textContent = records.length;
        }

        function renderHistory(records) {
            const listEl = document.getElementById('history-list');
            if (records.length === 0) {
                listEl.innerHTML = '<div class="empty-state">æš‚æ— ç¡çœ è®°å½•</div>';
                return;
            }

            listEl.innerHTML = records.map(r => {
                const qualityClass = r.quality >= 4 ? 'quality-good' : r.quality <= 2 ? 'quality-poor' : 'quality-medium';
                const qualityText = r.quality >= 4 ? 'å¥½' : r.quality <= 2 ? 'å·®' : 'ä¸€èˆ¬';
                const bedTimeStr = r.bed_time ? new Date(r.bed_time).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'}) : '--';
                const wakeTimeStr = r.wake_time ? new Date(r.wake_time).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'}) : '--';
                return `
                    <div class="history-item">
                        <div>
                            <div class="history-date">${r.date ? new Date(r.date).toLocaleDateString('zh-CN') : '--'}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                                ${bedTimeStr} - ${wakeTimeStr}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div class="history-duration">${r.duration_hours || '--'}å°æ—¶</div>
                            <span class="history-quality ${qualityClass}">${qualityText}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getFormData() {
            return {
                bedtime: document.getElementById('bedtime').value,
                bedPeriod: document.getElementById('bedPeriod').value,
                waketime: document.getElementById('waketime').value,
                wakePeriod: document.getElementById('wakePeriod').value,
                quality: selectedQuality
            };
        }

        function validateFormData(data) {
            if (!data.bedtime || !data.waketime) {
                return { valid: false, message: 'è¯·å¡«å†™å…¥ç¡å’Œèµ·åºŠæ—¶é—´' };
            }
            return { valid: true };
        }

        async function saveSleep() {
            const data = getFormData();
            const validation = validateFormData(data);
            if (!validation.valid) {
                alert(validation.message);
                return;
            }

            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);

            try {
                const response = await API.sleep.record({
                    date: yesterday.toISOString().split('T')[0],
                    bedtime: data.bedtime,
                    bedPeriod: data.bedPeriod,
                    waketime: data.waketime,
                    wakePeriod: data.wakePeriod,
                    quality: data.quality
                });

                if (response.success) {
                    alert('è®°å½•æˆåŠŸï¼');
                    await loadSleepHistory();
                } else if (response.duplicate) {
                    duplicateRecordId = response.data.existing_id;
                    pendingSaveData = data;
                    showDuplicateModal(response.data);
                } else {
                    alert('è®°å½•å¤±è´¥: ' + response.message);
                }
            } catch (error) {
                console.error('ä¿å­˜ç¡çœ è®°å½•å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        function showDuplicateModal(record) {
            const modal = document.getElementById('duplicateModal');
            const details = document.getElementById('duplicateDetails');
            details.innerHTML = `
                <div>å…¥ç¡: ${new Date(record.bed_time).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}</div>
                <div>èµ·åºŠ: ${new Date(record.wake_time).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}</div>
                <div>æ—¶é•¿: ${record.duration_hours}å°æ—¶</div>
                <div>è´¨é‡: ${record.quality || '--'}åˆ†</div>
            `;
            modal.style.display = 'flex';
        }

        function closeDuplicateModal() {
            document.getElementById('duplicateModal').style.display = 'none';
            pendingSaveData = null;
            duplicateRecordId = null;
        }

        async function confirmOverwrite() {
            if (!pendingSaveData || !duplicateRecordId) return;

            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);

            try {
                const response = await API.sleep.overwrite(duplicateRecordId, {
                    date: yesterday.toISOString().split('T')[0],
                    bedtime: pendingSaveData.bedtime,
                    bedPeriod: pendingSaveData.bedPeriod,
                    waketime: pendingSaveData.waketime,
                    wakePeriod: pendingSaveData.wakePeriod,
                    quality: pendingSaveData.quality
                });

                closeDuplicateModal();

                if (response.success) {
                    alert('è®°å½•å·²è¦†ç›–ï¼');
                    await loadSleepHistory();
                } else {
                    alert('è¦†ç›–å¤±è´¥: ' + response.message);
                }
            } catch (error) {
                console.error('è¦†ç›–ç¡çœ è®°å½•å¤±è´¥:', error);
                alert('è¦†ç›–å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        init();
    </script>
</body>
</html>
