<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººè®¾ç½® - ä½“é‡ç®¡ç†åŠ©æ‰‹</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/layout.css">
    <style>
        .profile-page {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .profile-section {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }
        
        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        
        /* é£æ ¼é€‰æ‹© */
        .style-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .style-option {
            display: flex;
            align-items: center;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .style-option:hover {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.05);
        }
        
        .style-option.active {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.1);
        }
        
        .style-icon {
            font-size: 2rem;
            margin-right: 16px;
        }
        
        .style-info {
            flex: 1;
        }
        
        .style-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .style-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .style-check {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        
        .style-option.active .style-check {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        /* ä¿å­˜æŒ‰é’® */
        .save-btn {
            width: 100%;
            margin-top: 20px;
        }
        
        /* å½“å‰é…ç½®å±•ç¤º */
        .current-config {
            background: var(--background);
            padding: 16px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .config-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .config-item:last-child {
            border-bottom: none;
        }
        
        .config-label {
            color: var(--text-secondary);
        }
        
        .config-value {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        /* ç¤ºä¾‹å¯¹è¯ */
        .example-chat {
            background: var(--background);
            padding: 16px;
            border-radius: var(--border-radius);
            margin-top: 16px;
        }
        
        .example-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        
        .example-message {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .example-avatar {
            font-size: 1.25rem;
        }
        
        .example-content {
            background: white;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            color: var(--text-primary);
            flex: 1;
        }
        
        /* æ¡£æ¡ˆè¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }
        
        .circular-progress {
            position: relative;
            width: 120px;
            height: 120px;
        }
        
        .circular-progress svg {
            transform: rotate(-90deg);
        }
        
        .progress-bg {
            stroke: var(--border);
        }
        
        .progress-bar {
            stroke: var(--primary-color);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .progress-percent {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }
        
        .progress-label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .progress-details {
            width: 100%;
            max-width: 400px;
        }
        
        .progress-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--background);
            border-radius: var(--border-radius);
            margin-bottom: 8px;
        }
        
        .progress-item.completed {
            border-left: 4px solid var(--success-color);
        }
        
        .progress-item.pending {
            border-left: 4px solid var(--warning-color);
        }
        
        .progress-item-name {
            flex: 1;
            color: var(--text-primary);
        }
        
        .progress-item-status {
            font-size: 0.875rem;
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .status-completed {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success-color);
        }
        
        .status-pending {
            background: rgba(241, 196, 15, 0.1);
            color: var(--warning-color);
        }
        
        .progress-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
        }
        
        /* è¡¨å•æ ·å¼ï¼ˆç”¨äºBMRè®¡ç®—å™¨ï¼‰ */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .form-col {
            flex: 1;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            color: var(--text-primary);
            background: white;
            transition: border-color var(--transition-fast);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .input-with-button {
            display: flex;
            gap: 8px;
        }
        
        .input-with-button .form-control {
            flex: 1;
        }
        
        .result-card {
            background: var(--background);
            border-radius: var(--border-radius);
            padding: 16px;
            border: 1px solid var(--border);
        }
        
        .result-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .result-content {
            font-size: 1rem;
            color: var(--text-primary);
        }
        
        .result-note {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 8px;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 20px;
            color: var(--text-secondary);
        }
        
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="page">
        <header class="page-header">
            <div class="header-brand">
                <button class="back-button" onclick="window.location.href='index.html'" style="margin-right: 12px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </button>
                <span class="header-brand-icon">âš™ï¸</span>
                <span>ä¸ªäººè®¾ç½®</span>
            </div>
            <div class="header-actions">
                <button class="menu-toggle" id="menu-toggle" title="æ‰“å¼€èœå•"><span></span></button>
            </div>
        </header>

        <div class="page-content">
            <div class="sidebar-overlay" id="sidebar-overlay"></div>
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="user-avatar">ç”¨</div>
                    <div class="user-info"><div class="user-name">åŠ è½½ä¸­...</div><div class="user-status">åœ¨çº¿</div></div>
                </div>
                <nav class="sidebar-nav">
                    <div class="nav-section"><div class="nav-section-title">ä¸»è¦åŠŸèƒ½</div>
                        <ul class="nav-list">
                            <li><a href="index.html" class="nav-item"><span class="nav-item-icon">ğŸ¤–</span><span class="nav-item-text">AIåŠ©æ‰‹</span></a></li>
                            <li><a href="weight.html" class="nav-item"><span class="nav-item-icon">âš–ï¸</span><span class="nav-item-text">ä½“é‡è®°å½•</span></a></li>
                            <li><a href="meal.html" class="nav-item"><span class="nav-item-icon">ğŸ½ï¸</span><span class="nav-item-text">é¥®é£Ÿè®°å½•</span></a></li>
                            <li><a href="exercise.html" class="nav-item"><span class="nav-item-icon">ğŸƒ</span><span class="nav-item-text">è¿åŠ¨è®°å½•</span></a></li>
                        </ul>
                    </div>
                                        <div class="nav-section"><div class="nav-section-title">å¥åº·ç®¡ç†</div>
                        <ul class="nav-list">
                            <li><a href="water.html" class="nav-item"><span class="nav-item-icon">ğŸ’§</span><span class="nav-item-text">é¥®æ°´è®°å½•</span></a></li>
                            <li><a href="sleep.html" class="nav-item"><span class="nav-item-icon">ğŸ˜´</span><span class="nav-item-text">ç¡çœ è®°å½•</span></a></li>
                            <li><a href="report.html" class="nav-item"><span class="nav-item-icon">ğŸ“Š</span><span class="nav-item-text">æ•°æ®æŠ¥å‘Š</span></a></li>
                            <li><a href="goals.html" class="nav-item"><span class="nav-item-icon">ğŸ¯</span><span class="nav-item-text">ç›®æ ‡ç®¡ç†</span></a></li>
                            <li><a href="calculator.html" class="nav-item"><span class="nav-item-icon">ğŸ”¥</span><span class="nav-item-text">çƒ­é‡è®¡ç®—</span></a></li>

                                                    <li><a href="recipes.html" class="nav-item"><span class="nav-item-icon">ğŸ“–</span><span class="nav-item-text">å¥åº·é£Ÿè°±</span></a></li>
                            <li><a href="reminders.html" class="nav-item"><span class="nav-item-icon">ğŸ””</span><span class="nav-item-text">æé†’è®¾ç½®</span></a></li>
                        </ul>
                    </div>
                </nav>
                <div class="sidebar-footer">
                    <a href="profile.html" class="nav-item active"><span class="nav-item-icon">âš™ï¸</span><span class="nav-item-text">ä¸ªäººè®¾ç½®</span></a>
                    <button class="logout-btn" onclick="Auth.logout()"><span>ğŸšª</span><span>é€€å‡ºç™»å½•</span></button>
                </div>
            </aside>

            <main class="page-main">
                <div class="profile-page">
                    <!-- åŠ©æ‰‹é£æ ¼é€‰æ‹© -->
                    <div class="profile-section">
                        <h2 class="section-title">ğŸ­ é€‰æ‹©ä½ çš„AIåŠ©æ‰‹é£æ ¼</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 0.875rem;">
                            ä¸åŒé£æ ¼çš„åŠ©æ‰‹ä¼šç”¨ä¸åŒçš„æ–¹å¼ä¸ä½ äº¤æµï¼Œé€‰æ‹©æœ€é€‚åˆä½ çš„é£æ ¼å§~
                        </p>
                        
                        <div class="style-options" id="style-options">
                            <!-- åŠ¨æ€åŠ è½½ -->
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <span>åŠ è½½ä¸­...</span>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary btn-lg save-btn" id="save-btn" onclick="saveStyle()" disabled>
                            ğŸ’¾ ä¿å­˜è®¾ç½®
                        </button>
                    </div>
                    
                    <!-- æ¡£æ¡ˆå®Œå–„åº¦ -->
                    <div class="profile-section">
                        <h2 class="section-title">ğŸ“Š æ¡£æ¡ˆå®Œå–„åº¦</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 0.875rem;">
                            å®Œå–„æ¡£æ¡ˆå¯ä»¥å¸®åŠ©AIåŠ©æ‰‹æ›´å¥½åœ°äº†è§£ä½ ï¼Œæä¾›ä¸ªæ€§åŒ–å»ºè®®ã€‚
                        </p>
                        
                        <div class="progress-container" id="profile-progress">
                            <div class="circular-progress">
                                <svg width="120" height="120" viewBox="0 0 120 120">
                                    <circle class="progress-bg" cx="60" cy="60" r="54" stroke-width="12" fill="none"/>
                                    <circle class="progress-bar" cx="60" cy="60" r="54" stroke-width="12" fill="none"
                                            stroke-dasharray="339.292" stroke-dashoffset="0"/>
                                </svg>
                                <div class="progress-text">
                                    <span class="progress-percent" id="progress-percent">0%</span>
                                    <span class="progress-label">å®Œæˆ</span>
                                </div>
                            </div>
                            
                            <div class="progress-details" id="progress-details">
                                <!-- åŠ¨æ€åŠ è½½ -->
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <span>åŠ è½½ä¸­...</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="progress-actions" style="margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="loadProfileProgress()">
                                ğŸ”„ åˆ·æ–°è¿›åº¦
                            </button>
                            <button class="btn btn-primary" onclick="goToProfiling()" style="margin-left: 12px;">
                                âœï¸ å®Œå–„æ¡£æ¡ˆ
                            </button>
                        </div>
                    </div>
                    
                    <!-- å½“å‰é…ç½® -->
                    <div class="profile-section">
                        <h2 class="section-title">ğŸ“‹ å½“å‰é…ç½®</h2>
                        <div class="current-config" id="current-config">
                            <div class="config-item">
                                <span class="config-label">åŠ©æ‰‹åç§°</span>
                                <span class="config-value" id="current-name">å°åŠ©</span>
                            </div>
                            <div class="config-item">
                                <span class="config-label">å½“å‰é£æ ¼</span>
                                <span class="config-value" id="current-style">æ¸©æš–å‹</span>
                            </div>
                            <div class="config-item">
                                <span class="config-label">åŸºç¡€ä»£è°¢ç‡ (BMR)</span>
                                <span class="config-value" id="current-bmr">--</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- åŸºç¡€ä»£è°¢ç‡è®¾ç½® -->
                    <div class="profile-section">
                        <h2 class="section-title">ğŸ”¥ åŸºç¡€ä»£è°¢ç‡è®¾ç½®</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 0.875rem;">
                            åŸºç¡€ä»£è°¢ç‡æ˜¯ä½ é™æ¯æ—¶æ¶ˆè€—çš„çƒ­é‡ã€‚ä½ å¯ä»¥æ‰‹åŠ¨è¾“å…¥ï¼Œæˆ–ä½¿ç”¨å…¬å¼è®¡ç®—ã€‚
                        </p>
                        
                        <div class="form-group">
                            <label for="bmr-input">æ‰‹åŠ¨è®¾ç½® BMR (åƒå¡/å¤©)</label>
                            <div class="input-with-button">
                                <input type="number" id="bmr-input" class="form-control" placeholder="ä¾‹å¦‚ï¼š1500" min="500" max="5000" step="10">
                                <button class="btn btn-secondary" onclick="saveBmr()">ä¿å­˜</button>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 24px;">
                            <label>ä½¿ç”¨å…¬å¼è®¡ç®— BMR</label>
                            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 12px;">
                                æ ¹æ®ä½ çš„å¹´é¾„ã€æ€§åˆ«ã€èº«é«˜ã€ä½“é‡å’Œæ´»åŠ¨æ°´å¹³è®¡ç®—ã€‚
                            </p>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <label for="calc-age">å¹´é¾„</label>
                                    <input type="number" id="calc-age" class="form-control" placeholder="30" min="15" max="100">
                                </div>
                                <div class="form-col">
                                    <label for="calc-gender">æ€§åˆ«</label>
                                    <select id="calc-gender" class="form-control">
                                        <option value="male">ç”·æ€§</option>
                                        <option value="female">å¥³æ€§</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <label for="calc-height">èº«é«˜ (cm)</label>
                                    <input type="number" id="calc-height" class="form-control" placeholder="170" min="100" max="250">
                                </div>
                                <div class="form-col">
                                    <label for="calc-weight">ä½“é‡ (kg)</label>
                                    <input type="number" id="calc-weight" class="form-control" placeholder="65" min="30" max="300" step="0.1">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="calc-activity">æ´»åŠ¨æ°´å¹³</label>
                                <select id="calc-activity" class="form-control">
                                    <option value="1.2">ä¹…å (åŠå…¬å®¤å·¥ä½œï¼Œå¾ˆå°‘è¿åŠ¨)</option>
                                    <option value="1.375">è½»åº¦æ´»åŠ¨ (æ¯å‘¨1-3å¤©è½»åº¦è¿åŠ¨)</option>
                                    <option value="1.55">ä¸­åº¦æ´»åŠ¨ (æ¯å‘¨3-5å¤©ä¸­åº¦è¿åŠ¨)</option>
                                    <option value="1.725">é«˜åº¦æ´»åŠ¨ (æ¯å‘¨6-7å¤©é«˜å¼ºåº¦è¿åŠ¨)</option>
                                    <option value="1.9">æé«˜åº¦æ´»åŠ¨ (ä½“åŠ›åŠ³åŠ¨æˆ–ä¸“ä¸šè¿åŠ¨å‘˜)</option>
                                </select>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <button class="btn btn-primary" onclick="calculateBmr()" style="width: 100%;">
                                        ğŸ”¢ è®¡ç®— BMR
                                    </button>
                                </div>
                                <div class="form-col">
                                    <button class="btn btn-secondary" onclick="applyCalculatedBmr()" id="apply-bmr-btn" disabled style="width: 100%;">
                                        ğŸ’¾ åº”ç”¨è®¡ç®—ç»“æœ
                                    </button>
                                </div>
                            </div>
                            
                            <div id="bmr-result" class="result-card" style="display: none; margin-top: 16px;">
                                <div class="result-title">è®¡ç®—ç»“æœ</div>
                                <div class="result-content">
                                    <div>åŸºç¡€ä»£è°¢ç‡ (BMR): <strong id="result-bmr">--</strong> åƒå¡/å¤©</div>
                                    <div>æ¯æ—¥æ€»æ¶ˆè€— (TDEE): <strong id="result-tdee">--</strong> åƒå¡/å¤©</div>
                                    <div class="result-note">åŸºäºå½“å‰æ´»åŠ¨æ°´å¹³è®¡ç®—</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/components.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let styles = [];
        let currentStyle = null;
        let selectedStyle = null;
        
        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', () => {
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!Auth.check()) {
            window.location.href = 'login.html';
            return;
        }
        
        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        const user = Auth.getUser();
        if (user) {
            const userNameEl = document.querySelector('.user-name');
            const userAvatarEl = document.querySelector('.user-avatar');
            if (userNameEl) userNameEl.textContent = user.nickname || user.name || 'ç”¨æˆ·';
            if (userAvatarEl) userAvatarEl.textContent = (user.nickname || user.name || 'U')[0].toUpperCase();
        }

            loadStyles();
            loadCurrentConfig();
        });
        
        // åŠ è½½æ‰€æœ‰é£æ ¼
        async function loadStyles() {
            try {
                const result = await API.user.getAgentStyles();
                
                if (result.success && result.styles) {
                    styles = result.styles;
                    renderStyles();
                }
            } catch (error) {
                console.error('åŠ è½½é£æ ¼å¤±è´¥:', error);
                document.getElementById('style-options').innerHTML = 
                    '<div class="alert alert-error">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
            }
        }
        
        // æ¸²æŸ“é£æ ¼é€‰é¡¹
        function renderStyles() {
            const container = document.getElementById('style-options');
            
            container.innerHTML = styles.map(style => `
                <div class="style-option ${selectedStyle === style.value ? 'active' : ''}" 
                     onclick="selectStyle('${style.value}')"
                     data-value="${style.value}">
                    <span class="style-icon">${style.icon}</span>
                    <div class="style-info">
                        <div class="style-name">${style.name}</div>
                        <div class="style-desc">${style.description}</div>
                    </div>
                    <div class="style-check">${selectedStyle === style.value ? 'âœ“' : ''}</div>
                </div>
            `).join('');
        }
        
        // é€‰æ‹©é£æ ¼
        function selectStyle(value) {
            selectedStyle = value;
            renderStyles();
            
            // å¯ç”¨ä¿å­˜æŒ‰é’®
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = value === currentStyle;
        }
        
        // åŠ è½½å½“å‰é…ç½®
        async function loadCurrentConfig() {
            try {
                // åŠ è½½Agenté…ç½®
                const configResult = await API.user.getAgentConfig();
                
                if (configResult.success && configResult.config) {
                    currentStyle = configResult.config.personality_type;
                    selectedStyle = currentStyle;
                    
                    document.getElementById('current-name').textContent = 
                        configResult.config.agent_name || 'å°åŠ©';
                    
                    const styleNames = {
                        'professional': 'ä¸“ä¸šå‹',
                        'warm': 'æ¸©æš–å‹',
                        'energetic': 'æ´»æ³¼å‹'
                    };
                    document.getElementById('current-style').textContent = 
                        styleNames[currentStyle] || 'æ¸©æš–å‹';
                    
                    renderStyles();
                }
                
                // åŠ è½½ç”¨æˆ·èµ„æ–™ï¼ˆè·å–BMRï¼‰
                const profileResult = await API.user.getProfile();
                
                if (profileResult.success && profileResult.profile) {
                    const bmr = profileResult.profile.bmr;
                    document.getElementById('current-bmr').textContent = 
                        bmr ? `${bmr} åƒå¡/å¤©` : 'æœªè®¾ç½®';
                    
                    // å¦‚æœå·²æœ‰BMRï¼Œå¡«å……åˆ°è¾“å…¥æ¡†å¹¶æ˜¾ç¤ºæ•°æ®æ¥æº
                    if (bmr) {
                        document.getElementById('bmr-input').value = bmr;
                        showBmrSource('profile');
                    }
                    
                    // å¦‚æœå·²æœ‰å¹´é¾„ã€æ€§åˆ«ã€èº«é«˜ï¼Œå¡«å……åˆ°è®¡ç®—å™¨
                    if (profileResult.profile.age) {
                        document.getElementById('calc-age').value = profileResult.profile.age;
                        document.getElementById('calc-age').style.borderColor = '#4CAF50';
                        document.getElementById('calc-age').title = 'ä»ç”¨æˆ·æ¡£æ¡ˆè·å–çš„æ•°æ®';
                    } else {
                        document.getElementById('calc-age').placeholder = 'è¯·å…ˆè®¾ç½®å¹´é¾„';
                        document.getElementById('calc-age').style.borderColor = '#ff9800';
                    }
                    if (profileResult.profile.gender) {
                        document.getElementById('calc-gender').value = 
                            profileResult.profile.gender.toLowerCase();
                        document.getElementById('calc-gender').style.borderColor = '#4CAF50';
                        document.getElementById('calc-gender').title = 'ä»ç”¨æˆ·æ¡£æ¡ˆè·å–çš„æ•°æ®';
                    }
                    if (profileResult.profile.height) {
                        document.getElementById('calc-height').value = profileResult.profile.height;
                        document.getElementById('calc-height').style.borderColor = '#4CAF50';
                        document.getElementById('calc-height').title = 'ä»ç”¨æˆ·æ¡£æ¡ˆè·å–çš„æ•°æ®';
                    } else {
                        document.getElementById('calc-height').placeholder = 'è¯·å…ˆè®¾ç½®èº«é«˜';
                        document.getElementById('calc-height').style.borderColor = '#ff9800';
                    }
                    
                    // æ˜¾ç¤ºæ¡£æ¡ˆå®Œæ•´æ€§æç¤º
                    showProfileCompleteness(profileResult.profile);
                }
                
                // åŠ è½½æœ€æ–°ä½“é‡è®°å½•
                try {
                    const weightResult = await API.weight.getStats();
                    if (weightResult.success && weightResult.data && weightResult.data.latest) {
                        const latestWeight = weightResult.data.latest.weight;
                        document.getElementById('calc-weight').value = latestWeight;
                        document.getElementById('calc-weight').style.borderColor = '#4CAF50';
                        document.getElementById('calc-weight').title = 'ä»æœ€æ–°ä½“é‡è®°å½•è·å–çš„æ•°æ®';
                    } else if (weightResult.success && !weightResult.data) {
                        // æ²¡æœ‰ä½“é‡è®°å½•ï¼Œæ˜¾ç¤ºæç¤º
                        document.getElementById('calc-weight').placeholder = 'è¯·å…ˆè®°å½•ä½“é‡';
                        document.getElementById('calc-weight').style.borderColor = '#ff9800';
                    }
                } catch (error) {
                    console.error('åŠ è½½ä½“é‡æ•°æ®å¤±è´¥:', error);
                    // ä¸æ˜¾ç¤ºé”™è¯¯ï¼Œä½“é‡å­—æ®µå¯ä»¥ç•™ç©ºè®©ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºBMRæ•°æ®æ¥æº
        function showBmrSource(source) {
            const bmrInput = document.getElementById('bmr-input');
            const sourceTexts = {
                'profile': 'ä»ç”¨æˆ·æ¡£æ¡ˆè·å–',
                'calculated': 'é€šè¿‡å…¬å¼è®¡ç®—',
                'manual': 'æ‰‹åŠ¨è¾“å…¥'
            };
            
            bmrInput.style.borderColor = '#4CAF50';
            bmrInput.title = sourceTexts[source] || 'BMRæ•°æ®';
        }
        
        // æ˜¾ç¤ºæ¡£æ¡ˆå®Œæ•´æ€§æç¤º
        function showProfileCompleteness(profile) {
            const missingFields = [];
            
            if (!profile.age) missingFields.push('å¹´é¾„');
            if (!profile.gender) missingFields.push('æ€§åˆ«');
            if (!profile.height) missingFields.push('èº«é«˜');
            if (!profile.bmr) missingFields.push('åŸºç¡€ä»£è°¢ç‡');
            
            if (missingFields.length > 0) {
                const tip = document.createElement('div');
                tip.className = 'profile-tip';
                tip.innerHTML = `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 8px 12px; margin: 12px 0; font-size: 0.875rem;">
                        <strong>ğŸ’¡ æ¡£æ¡ˆå®Œå–„å»ºè®®ï¼š</strong> å®Œå–„ ${missingFields.join('ã€')} ä¿¡æ¯ï¼Œå¯è·å¾—æ›´å‡†ç¡®çš„BMRè®¡ç®—
                    </div>
                `;
                
                const bmrSection = document.querySelector('.profile-section:nth-child(4)');
                if (bmrSection) {
                    bmrSection.insertBefore(tip, bmrSection.firstChild);
                }
            }
        }
        
        // ä¿å­˜é£æ ¼è®¾ç½®
        async function saveStyle() {
            if (!selectedStyle) return;
            
            const btn = document.getElementById('save-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner" style="width: 16px; height: 16px; border-color: rgba(255,255,255,0.3); border-top-color: white;"></span> ä¿å­˜ä¸­...';
            
            try {
                const result = await API.user.updateAgentConfig({
                    personality_type: selectedStyle
                });
                
                if (result.success) {
                    Utils.toast('è®¾ç½®ä¿å­˜æˆåŠŸï¼', 'success');
                    currentStyle = selectedStyle;
                    
                    // æ›´æ–°å½“å‰é…ç½®æ˜¾ç¤º
                    const styleNames = {
                        'professional': 'ä¸“ä¸šå‹',
                        'warm': 'æ¸©æš–å‹',
                        'energetic': 'æ´»æ³¼å‹'
                    };
                    document.getElementById('current-style').textContent = 
                        styleNames[currentStyle] || 'æ¸©æš–å‹';
                } else {
                    throw new Error(result.message || 'ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                Utils.toast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                btn.disabled = selectedStyle === currentStyle;
                btn.innerHTML = 'ğŸ’¾ ä¿å­˜è®¾ç½®';
            }
        }
        
        // BMRç›¸å…³å‡½æ•°
        let calculatedBmr = null;
        let calculatedTdee = null;
        
        // ä¿å­˜æ‰‹åŠ¨è¾“å…¥çš„BMR
        async function saveBmr() {
            const bmrInput = document.getElementById('bmr-input');
            const bmrValue = parseInt(bmrInput.value);
            
            if (!bmrValue || bmrValue < 500 || bmrValue > 5000) {
                Utils.toast('è¯·è¾“å…¥æœ‰æ•ˆçš„BMRå€¼ï¼ˆ500-5000åƒå¡ï¼‰', 'error');
                return;
            }
            
            const btn = document.getElementById('bmr-input').nextElementSibling;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner" style="width: 16px; height: 16px;"></span>';
            
            try {
                // ä½¿ç”¨ä¸“é—¨çš„BMRæ›´æ–°æ¥å£
                const result = await fetch(`${API.base}/api/user/profile/bmr`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${Auth.getToken()}`
                    },
                    body: JSON.stringify({ bmr: bmrValue })
                });
                
                const response = await result.json();
                
                if (response.success) {
                    Utils.toast('BMRä¿å­˜æˆåŠŸï¼', 'success');
                    document.getElementById('current-bmr').textContent = `${bmrValue} åƒå¡/å¤©`;
                    showBmrSource('manual');
                    
                    // å¦‚æœè¿™æ˜¯é€šè¿‡è®¡ç®—åº”ç”¨çš„ï¼Œæ›´æ–°è®¡ç®—å™¨ä¸­çš„BMRè¾“å…¥æ¡†
                    if (calculatedBmr && calculatedBmr === bmrValue) {
                        document.getElementById('bmr-input').value = bmrValue;
                    }
                } else {
                    throw new Error(response.message || 'ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜BMRå¤±è´¥:', error);
                Utils.toast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        // è®¡ç®—BMR
        async function calculateBmr() {
            const age = parseInt(document.getElementById('calc-age').value);
            const gender = document.getElementById('calc-gender').value;
            const height = parseFloat(document.getElementById('calc-height').value);
            const weight = parseFloat(document.getElementById('calc-weight').value);
            const activity = parseFloat(document.getElementById('calc-activity').value);
            
            if (!age || !height || !weight) {
                Utils.toast('è¯·å¡«å†™å¹´é¾„ã€èº«é«˜å’Œä½“é‡', 'error');
                return;
            }
            
            try {
                // è°ƒç”¨åç«¯è®¡ç®—æœåŠ¡ï¼ˆæ”¹è¿›ç‰ˆï¼ŒåŒ…å«æ•°æ®æ¥æºè·Ÿè¸ªï¼‰
                const response = await fetch(`${API.base}/api/calories/calculate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${Auth.getToken()}`
                    },
                    body: JSON.stringify({
                        age,
                        gender,
                        height,
                        weight,
                        activity_level: activity
                    })
                });
                
                if (!response.ok) {
                    // å¦‚æœåç«¯APIä¸å­˜åœ¨ï¼Œä½¿ç”¨å‰ç«¯è®¡ç®—
                    return calculateBmrFrontend(age, gender, height, weight, activity);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    calculatedBmr = result.bmr;
                    calculatedTdee = result.tdee;
                    
                    document.getElementById('result-bmr').textContent = calculatedBmr;
                    document.getElementById('result-tdee').textContent = calculatedTdee;
                    document.getElementById('bmr-result').style.display = 'block';
                    document.getElementById('apply-bmr-btn').disabled = false;
                    
                    // æ˜¾ç¤ºæ•°æ®æ¥æºä¿¡æ¯
                    showBmrSource('calculated');
                    
                    // æ˜¾ç¤ºæ•°æ®æ¥æºè¯¦æƒ…
                    let sources = [];
                    if (result.data_sources) {
                        const sourceTexts = {
                            'bmr_used': {
                                'user_provided': 'æ‰‹åŠ¨è¾“å…¥',
                                'profile': 'æ¡£æ¡ˆæ•°æ®',
                                'calculated': 'å…¬å¼è®¡ç®—'
                            },
                            'age_used': {
                                'user_provided': 'å½“å‰è¾“å…¥',
                                'profile': 'æ¡£æ¡ˆæ•°æ®',
                                'not_provided': 'æœªæä¾›'
                            },
                            'gender_used': {
                                'user_provided': 'å½“å‰é€‰æ‹©',
                                'profile': 'æ¡£æ¡ˆæ•°æ®',
                                'not_provided': 'æœªæä¾›'
                            },
                            'height_used': {
                                'user_provided': 'å½“å‰è¾“å…¥',
                                'profile': 'æ¡£æ¡ˆæ•°æ®',
                                'not_provided': 'æœªæä¾›'
                            },
                            'weight_used': {
                                'user_provided': 'å½“å‰è¾“å…¥',
                                'not_provided': 'æœªæä¾›'
                            }
                        };
                        
                        for (const [key, value] of Object.entries(result.data_sources)) {
                            const fieldName = {
                                'bmr_used': 'BMRæ¥æº',
                                'age_used': 'å¹´é¾„',
                                'gender_used': 'æ€§åˆ«',
                                'height_used': 'èº«é«˜',
                                'weight_used': 'ä½“é‡'
                            }[key];
                            
                            if (fieldName && value !== 'not_provided') {
                                sources.push(`${fieldName}: ${sourceTexts[key][value] || value}`);
                            }
                        }
                    }
                    
                    if (sources.length > 0) {
                        const sourceInfo = document.createElement('div');
                        sourceInfo.className = 'result-note';
                        sourceInfo.innerHTML = `<strong>æ•°æ®æ¥æº:</strong> ${sources.join(' | ')}`;
                        
                        const resultCard = document.getElementById('bmr-result');
                        const existingSource = resultCard.querySelector('.result-note.source-info');
                        if (existingSource) {
                            existingSource.remove();
                        }
                        
                        sourceInfo.classList.add('source-info');
                        resultCard.querySelector('.result-content').appendChild(sourceInfo);
                    }
                    
                } else {
                    throw new Error(result.message || 'è®¡ç®—å¤±è´¥');
                }
            } catch (error) {
                console.error('è°ƒç”¨è®¡ç®—APIå¤±è´¥ï¼Œä½¿ç”¨å‰ç«¯è®¡ç®—:', error);
                calculateBmrFrontend(age, gender, height, weight, activity);
            }
        }
        
        // å‰ç«¯BMRè®¡ç®—ï¼ˆHarris-Benedictå…¬å¼ï¼‰
        function calculateBmrFrontend(age, gender, height, weight, activity) {
            let bmr;
            
            if (gender === 'male') {
                // ç”·æ€§: BMR = 88.362 + (13.397 Ã— ä½“é‡kg) + (4.799 Ã— èº«é«˜cm) - (5.677 Ã— å¹´é¾„)
                bmr = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
            } else {
                // å¥³æ€§: BMR = 447.593 + (9.247 Ã— ä½“é‡kg) + (3.098 Ã— èº«é«˜cm) - (4.330 Ã— å¹´é¾„)
                bmr = 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
            }
            
            bmr = Math.round(bmr);
            const tdee = Math.round(bmr * activity);
            
            calculatedBmr = bmr;
            calculatedTdee = tdee;
            
            document.getElementById('result-bmr').textContent = bmr;
            document.getElementById('result-tdee').textContent = tdee;
            document.getElementById('bmr-result').style.display = 'block';
            document.getElementById('apply-bmr-btn').disabled = false;
            
            Utils.toast('BMRè®¡ç®—å®Œæˆï¼', 'success');
        }
        
        // åº”ç”¨è®¡ç®—å‡ºçš„BMR
        async function applyCalculatedBmr() {
            if (!calculatedBmr) {
                Utils.toast('è¯·å…ˆè®¡ç®—BMR', 'error');
                return;
            }
            
            const btn = document.getElementById('apply-bmr-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner" style="width: 16px; height: 16px;"></span>';
            
            try {
                const result = await API.user.updateProfile({
                    bmr: calculatedBmr
                });
                
                if (result.success) {
                    Utils.toast('BMRåº”ç”¨æˆåŠŸï¼', 'success');
                    document.getElementById('current-bmr').textContent = `${calculatedBmr} åƒå¡/å¤©`;
                    document.getElementById('bmr-input').value = calculatedBmr;
                } else {
                    throw new Error(result.message || 'åº”ç”¨å¤±è´¥');
                }
            } catch (error) {
                console.error('åº”ç”¨BMRå¤±è´¥:', error);
                Utils.toast('åº”ç”¨å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        // æ¡£æ¡ˆè¿›åº¦æ¡å‡½æ•°
        async function loadProfileProgress() {
            const container = document.getElementById('progress-details');
            const percentElement = document.getElementById('progress-percent');
            const progressBar = document.querySelector('.progress-bar');
            
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><span>åŠ è½½ä¸­...</span></div>';
            
            try {
                const response = await fetch(`${API.base}/api/profiling/progress`, {
                    headers: {
                        'Authorization': `Bearer ${Auth.getToken()}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const completion = result.profile_completion;
                    const overall = completion.overall || 0;
                    
                    // æ›´æ–°ç¯å½¢è¿›åº¦æ¡
                    percentElement.textContent = `${overall}%`;
                    const circumference = 2 * Math.PI * 54; // r=54
                    const offset = circumference - (overall / 100) * circumference;
                    progressBar.style.strokeDashoffset = offset;
                    
                    // æ›´æ–°è¯¦ç»†è¿›åº¦
                    const details = completion.details || {};
                    const scoreBreakdown = completion.score_breakdown || {};
                    
                    let detailsHtml = '<div class="progress-details-list">';
                    
                    // æ˜¾ç¤ºåŸºç¡€å­—æ®µ
                    const baseFields = scoreBreakdown.base_fields || [];
                    for (const field of baseFields) {
                        const isCompleted = details[field] || false;
                        const displayName = {
                            'age': 'å¹´é¾„',
                            'gender': 'æ€§åˆ«',
                            'height': 'èº«é«˜',
                            'weight': 'ä½“é‡è®°å½•',
                            'bmr': 'åŸºç¡€ä»£è°¢ç‡'
                        }[field] || field;
                        
                        detailsHtml += `
                            <div class="progress-item ${isCompleted ? 'completed' : 'pending'}">
                                <span class="progress-item-name">${displayName}</span>
                                <span class="progress-item-status ${isCompleted ? 'status-completed' : 'status-pending'}">
                                    ${isCompleted ? 'âœ“ å·²å®Œæˆ' : 'â—‹ å¾…å®Œå–„'}
                                </span>
                            </div>
                        `;
                    }
                    
                    // æ˜¾ç¤ºå…¶ä»–å­—æ®µ
                    const otherFields = scoreBreakdown.other_fields || [];
                    for (const field of otherFields) {
                        const isCompleted = details[field] || false;
                        const displayName = {
                            'diet_preferences': 'é¥®é£Ÿåå¥½',
                            'exercise_habits': 'è¿åŠ¨ä¹ æƒ¯'
                        }[field] || field;
                        
                        detailsHtml += `
                            <div class="progress-item ${isCompleted ? 'completed' : 'pending'}">
                                <span class="progress-item-name">${displayName}</span>
                                <span class="progress-item-status ${isCompleted ? 'status-completed' : 'status-pending'}">
                                    ${isCompleted ? 'âœ“ å·²å®Œæˆ' : 'â—‹ å¾…å®Œå–„'}
                                </span>
                            </div>
                        `;
                    }
                    
                    detailsHtml += '</div>';
                    container.innerHTML = detailsHtml;
                    
                } else {
                    throw new Error(result.message || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½è¿›åº¦å¤±è´¥:', error);
                container.innerHTML = '<div class="alert alert-error">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
            }
        }
        
        function goToProfiling() {
            // è·³è½¬åˆ°ç”¨æˆ·ç”»åƒæ”¶é›†é¡µé¢ï¼ˆå‡è®¾æœ‰ profiling.htmlï¼‰
            window.location.href = 'profiling.html';
        }
        
        // é¡µé¢åŠ è½½æ—¶ä¹ŸåŠ è½½BMRæ•°æ®å’Œè¿›åº¦
        document.addEventListener('DOMContentLoaded', () => {
            loadStyles();
            loadCurrentConfig();
            loadProfileProgress();
        });
    </script>
</body>
</html>
