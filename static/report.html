<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®æŠ¥å‘Š - ä½“é‡ç®¡ç†åŠ©æ‰‹</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/layout.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .report-page {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .report-section {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }
        
        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        /* å›¾è¡¨å®¹å™¨ */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 24px;
        }
        
        .chart-container.pie {
            height: 250px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* æ§åˆ¶é¢æ¿ */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .control-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .btn-group {
            display: flex;
            gap: 4px;
        }
        
        .btn-group .btn {
            padding: 6px 12px;
            font-size: 0.875rem;
        }
        
        /* æ•°æ®è¡¨æ ¼ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .data-table th {
            text-align: left;
            padding: 12px 16px;
            border-bottom: 2px solid var(--border);
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-primary);
        }
        
        .data-table tr:last-child td {
            border-bottom: none;
        }
        
        .data-table tr:hover {
            background: var(--background);
        }
        
        /* çŠ¶æ€æ ‡ç­¾ */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-deficit {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success-color);
        }
        
        .status-surplus {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }
        
        .status-maintenance {
            background: rgba(241, 196, 15, 0.1);
            color: var(--warning-color);
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(52, 152, 219, 0.3);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        /* é¢œè‰²è¯´æ˜ */
        .color-legend {
            display: flex;
            gap: 16px;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        
        .color-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="page">
        <header class="page-header">
            <div class="header-brand">
                <button class="back-button" onclick="history.back()" style="margin-right: 12px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </button>
                <span class="header-brand-icon">ğŸ“Š</span>
                <span>æ•°æ®æŠ¥å‘Š</span>
            </div>
            <div class="header-actions">
                <button class="menu-toggle" id="menu-toggle" title="æ‰“å¼€èœå•"><span></span></button>
            </div>
        </header>

        <div class="page-content">
            <div class="sidebar-overlay" id="sidebar-overlay"></div>
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="user-avatar">ç”¨</div>
                    <div class="user-info"><div class="user-name">åŠ è½½ä¸­...</div><div class="user-status">åœ¨çº¿</div></div>
                </div>
                <nav class="sidebar-nav">
                    <div class="nav-section"><div class="nav-section-title">ä¸»è¦åŠŸèƒ½</div>
                        <ul class="nav-list">
                            <li><a href="index.html" class="nav-item"><span class="nav-item-icon">ğŸ¤–</span><span class="nav-item-text">AIåŠ©æ‰‹</span></a></li>
                            <li><a href="weight.html" class="nav-item"><span class="nav-item-icon">âš–ï¸</span><span class="nav-item-text">ä½“é‡è®°å½•</span></a></li>
                            <li><a href="meal.html" class="nav-item"><span class="nav-item-icon">ğŸ½ï¸</span><span class="nav-item-text">é¥®é£Ÿè®°å½•</span></a></li>
                            <li><a href="exercise.html" class="nav-item"><span class="nav-item-icon">ğŸƒ</span><span class="nav-item-text">è¿åŠ¨è®°å½•</span></a></li>
                        </ul>
                    </div>
                                        <div class="nav-section"><div class="nav-section-title">å¥åº·ç®¡ç†</div>
                        <ul class="nav-list">
                            <li><a href="water.html" class="nav-item"><span class="nav-item-icon">ğŸ’§</span><span class="nav-item-text">é¥®æ°´è®°å½•</span></a></li>
                            <li><a href="sleep.html" class="nav-item"><span class="nav-item-icon">ğŸ˜´</span><span class="nav-item-text">ç¡çœ è®°å½•</span></a></li>
                            <li><a href="report.html" class="nav-item active"><span class="nav-item-icon">ğŸ“Š</span><span class="nav-item-text">æ•°æ®æŠ¥å‘Š</span></a></li>
                            <li><a href="goals.html" class="nav-item"><span class="nav-item-icon">ğŸ¯</span><span class="nav-item-text">ç›®æ ‡ç®¡ç†</span></a></li>
                            <li><a href="calculator.html" class="nav-item"><span class="nav-item-icon">ğŸ”¥</span><span class="nav-item-text">çƒ­é‡è®¡ç®—</span></a></li>
                            <li><a href="reminders.html" class="nav-item"><span class="nav-item-icon">ğŸ””</span><span class="nav-item-text">æé†’è®¾ç½®</span></a></li>
                        </ul>
                    </div>
                </nav>
                <div class="sidebar-footer">
                    <a href="profile.html" class="nav-item"><span class="nav-item-icon">âš™ï¸</span><span class="nav-item-text">ä¸ªäººè®¾ç½®</span></a>
                    <button class="logout-btn" onclick="Auth.logout()"><span>ğŸšª</span><span>é€€å‡ºç™»å½•</span></button>
                </div>
            </aside>

            <main class="page-main">
                <div class="report-page">
                    <!-- æ§åˆ¶é¢æ¿ -->
                    <div class="report-section">
                        <h2 class="section-title">ğŸ“ˆ çƒ­é‡å¹³è¡¡åˆ†æ</h2>
                        <div class="controls">
                            <div class="control-group">
                                <span class="control-label">æ—¶é—´èŒƒå›´ï¼š</span>
                                <div class="btn-group">
                                    <button class="btn btn-primary" onclick="setChartType('daily')">æœ€è¿‘7å¤©</button>
                                    <button class="btn btn-secondary" onclick="setChartType('weekly')">æœ€è¿‘4å‘¨</button>
                                    <button class="btn btn-secondary" onclick="setChartType('monthly')">æœ€è¿‘3æœˆ</button>
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <span class="control-label">å›¾è¡¨ç±»å‹ï¼š</span>
                                <div class="btn-group">
                                    <button class="btn btn-primary" onclick="loadBalanceChart()">çƒ­é‡å¹³è¡¡å›¾</button>
                                    <button class="btn btn-secondary" onclick="loadDistributionChart()">çƒ­é‡åˆ†å¸ƒå›¾</button>
                                </div>
                            </div>
                            
                            <div class="control-group">
                                <button class="btn btn-secondary" onclick="refreshAllData()">
                                    ğŸ”„ åˆ·æ–°æ•°æ®
                                </button>
                            </div>
                        </div>
                        
                        <div class="color-legend">
                            <div class="color-item">
                                <span class="color-dot" style="background-color: rgba(255, 99, 132, 0.8);"></span>
                                <span>çƒ­é‡æ‘„å…¥</span>
                            </div>
                            <div class="color-item">
                                <span class="color-dot" style="background-color: rgba(54, 162, 235, 0.8);"></span>
                                <span>çƒ­é‡æ¶ˆè€—</span>
                            </div>
                            <div class="color-item">
                                <span class="color-dot" style="background-color: rgba(75, 192, 192, 0.8);"></span>
                                <span>çƒ­é‡å¹³è¡¡</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç»Ÿè®¡å¡ç‰‡ -->
                    <div class="report-section">
                        <h2 class="section-title">ğŸ“Š ç»Ÿè®¡æ•°æ®</h2>
                        <div class="stats-grid" id="stats-grid">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <span>åŠ è½½ç»Ÿè®¡...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ä¸»å›¾è¡¨ -->
                    <div class="report-section">
                        <h2 class="section-title" id="chart-title">ğŸ“ˆ æ¯æ—¥çƒ­é‡å¹³è¡¡</h2>
                        <div class="chart-container">
                            <canvas id="main-chart"></canvas>
                        </div>
                        <div id="chart-summary" style="margin-top: 16px; font-size: 0.875rem; color: var(--text-secondary);">
                            <!-- åŠ¨æ€åŠ è½½å›¾è¡¨æ‘˜è¦ -->
                        </div>
                    </div>
                    
                    <!-- åˆ†å¸ƒå›¾è¡¨ -->
                    <div class="report-section">
                        <h2 class="section-title">ğŸ¥— çƒ­é‡åˆ†å¸ƒ</h2>
                        <div class="charts-grid">
                            <div>
                                <h3 style="font-size: 1rem; margin-bottom: 12px; color: var(--text-primary);">çƒ­é‡æ‘„å…¥åˆ†å¸ƒ</h3>
                                <div class="chart-container pie">
                                    <canvas id="intake-pie-chart"></canvas>
                                </div>
                                <div id="intake-summary" style="margin-top: 8px; font-size: 0.75rem; color: var(--text-secondary);">
                                    <!-- æ‘„å…¥åˆ†å¸ƒæ‘˜è¦ -->
                                </div>
                            </div>
                            
                            <div>
                                <h3 style="font-size: 1rem; margin-bottom: 12px; color: var(--text-primary);">çƒ­é‡æ¶ˆè€—åˆ†å¸ƒ</h3>
                                <div class="chart-container pie">
                                    <canvas id="exercise-pie-chart"></canvas>
                                </div>
                                <div id="exercise-summary" style="margin-top: 8px; font-size: 0.75rem; color: var(--text-secondary);">
                                    <!-- æ¶ˆè€—åˆ†å¸ƒæ‘˜è¦ -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è¯¦ç»†æ•°æ® -->
                    <div class="report-section">
                        <h2 class="section-title">ğŸ“ æ¯æ—¥è¯¦ç»†æ•°æ®</h2>
                        <div class="data-table-container">
                            <table class="data-table" id="daily-data-table">
                                <thead>
                                    <tr>
                                        <th>æ—¥æœŸ</th>
                                        <th>çƒ­é‡æ‘„å…¥</th>
                                        <th>åŸºç¡€æ¶ˆè€—</th>
                                        <th>è¿åŠ¨æ¶ˆè€—</th>
                                        <th>æ€»æ¶ˆè€—</th>
                                        <th>çƒ­é‡å¹³è¡¡</th>
                                        <th>çŠ¶æ€</th>
                                    </tr>
                                </thead>
                                <tbody id="daily-data-body">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 40px;">
                                            <div class="loading">
                                                <div class="loading-spinner"></div>
                                                <span>åŠ è½½æ•°æ®...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/components.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentChartType = 'daily';  // daily, weekly, monthly
        let currentView = 'balance';     // balance, distribution
        let mainChart = null;
        let intakePieChart = null;
        let exercisePieChart = null;
        
        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', () => {
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!Auth.check()) {
            window.location.href = 'login.html';
            return;
        }
        
        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        const user = Auth.getUser();
        if (user) {
            const userNameEl = document.querySelector('.user-name');
            const userAvatarEl = document.querySelector('.user-avatar');
            if (userNameEl) userNameEl.textContent = user.nickname || user.name || 'ç”¨æˆ·';
            if (userAvatarEl) userAvatarEl.textContent = (user.nickname || user.name || 'U')[0].toUpperCase();
        }

            loadAllData();
        });
        
        // è®¾ç½®å›¾è¡¨ç±»å‹
        function setChartType(type) {
            currentChartType = type;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            
            // æ¿€æ´»å½“å‰æŒ‰é’®
            const buttons = document.querySelectorAll('.btn-group .btn');
            if (type === 'daily') buttons[0].classList.add('btn-primary');
            else if (type === 'weekly') buttons[1].classList.add('btn-primary');
            else if (type === 'monthly') buttons[2].classList.add('btn-primary');
            
            // é‡æ–°åŠ è½½æ•°æ®
            if (currentView === 'balance') {
                loadBalanceChart();
            } else {
                loadDistributionChart();
            }
        }
        
        // åŠ è½½å¹³è¡¡å›¾è¡¨
        async function loadBalanceChart() {
            currentView = 'balance';
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.btn-group .btn')[3].classList.add('btn-primary');
            document.querySelectorAll('.btn-group .btn')[4].classList.remove('btn-primary');
            
            document.getElementById('chart-title').textContent = 
                `${getChartTypeName()}çƒ­é‡å¹³è¡¡`;
            
            try {
                const response = await fetch(
                    `${API.base}/api/calories/balance/chart?chart_type=${currentChartType}`, {
                    headers: {
                        'Authorization': `Bearer ${Auth.getToken()}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    renderMainChart(result);
                    updateChartSummary(result.summary);
                    loadDailyData();
                } else {
                    throw new Error(result.message || 'åŠ è½½å›¾è¡¨æ•°æ®å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½å¹³è¡¡å›¾è¡¨å¤±è´¥:', error);
                showChartError('åŠ è½½å›¾è¡¨æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // åŠ è½½åˆ†å¸ƒå›¾è¡¨
        async function loadDistributionChart() {
            currentView = 'distribution';
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.btn-group .btn')[3].classList.remove('btn-primary');
            document.querySelectorAll('.btn-group .btn')[4].classList.add('btn-primary');
            
            document.getElementById('chart-title').textContent = 
                `${getChartTypeName()}çƒ­é‡åˆ†å¸ƒ`;
            
            try {
                const response = await fetch(
                    `${API.base}/api/calories/balance/distribution?days=${getDaysFromChartType()}`, {
                    headers: {
                        'Authorization': `Bearer ${Auth.getToken()}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    renderDistributionCharts(result);
                    loadDailyData();
                } else {
                    throw new Error(result.message || 'åŠ è½½åˆ†å¸ƒæ•°æ®å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½åˆ†å¸ƒå›¾è¡¨å¤±è´¥:', error);
                showChartError('åŠ è½½åˆ†å¸ƒæ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // è·å–å›¾è¡¨ç±»å‹åç§°
        function getChartTypeName() {
            const names = {
                'daily': 'æ¯æ—¥',
                'weekly': 'æ¯å‘¨', 
                'monthly': 'æ¯æœˆ'
            };
            return names[currentChartType] || 'æ¯æ—¥';
        }
        
        // æ ¹æ®å›¾è¡¨ç±»å‹è·å–å¤©æ•°
        function getDaysFromChartType() {
            const daysMap = {
                'daily': 7,
                'weekly': 28,
                'monthly': 90
            };
            return daysMap[currentChartType] || 7;
        }
        
        // æ¸²æŸ“ä¸»å›¾è¡¨ï¼ˆå¹³è¡¡å›¾ï¼‰
        function renderMainChart(chartData) {
            const ctx = document.getElementById('main-chart').getContext('2d');
            
            // é”€æ¯ç°æœ‰å›¾è¡¨
            if (mainChart) {
                mainChart.destroy();
            }
            
            // åˆ›å»ºæ–°å›¾è¡¨
            mainChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: chartData.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'çƒ­é‡ (åƒå¡)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y + ' åƒå¡';
                                    return label;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }
        
        // æ¸²æŸ“åˆ†å¸ƒå›¾è¡¨
        function renderDistributionCharts(distributionData) {
            // é”€æ¯ç°æœ‰é¥¼å›¾
            if (intakePieChart) intakePieChart.destroy();
            if (exercisePieChart) exercisePieChart.destroy();
            
            // æ¸²æŸ“æ‘„å…¥åˆ†å¸ƒé¥¼å›¾
            const intakeCtx = document.getElementById('intake-pie-chart').getContext('2d');
            intakePieChart = new Chart(intakeCtx, {
                type: 'pie',
                data: distributionData.intake_distribution.chart_data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value}åƒå¡ (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // æ›´æ–°æ‘„å…¥æ‘˜è¦
            const intakeSummary = document.getElementById('intake-summary');
            const intakeTotal = distributionData.intake_distribution.total;
            const intakeItems = distributionData.intake_distribution.data.length;
            intakeSummary.innerHTML = `æ€»è®¡: ${intakeTotal}åƒå¡ | ${intakeItems}ç§é¤é£Ÿç±»å‹`;
            
            // æ¸²æŸ“æ¶ˆè€—åˆ†å¸ƒé¥¼å›¾
            const exerciseCtx = document.getElementById('exercise-pie-chart').getContext('2d');
            exercisePieChart = new Chart(exerciseCtx, {
                type: 'pie',
                data: distributionData.exercise_distribution.chart_data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value}åƒå¡ (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // æ›´æ–°æ¶ˆè€—æ‘˜è¦
            const exerciseSummary = document.getElementById('exercise-summary');
            const exerciseTotal = distributionData.exercise_distribution.total;
            const exerciseItems = distributionData.exercise_distribution.data.length;
            exerciseSummary.innerHTML = `æ€»è®¡: ${exerciseTotal}åƒå¡ | ${exerciseItems}ç§è¿åŠ¨ç±»å‹`;
            
            // å¦‚æœæ²¡æœ‰ä¸»å›¾è¡¨ï¼Œæ˜¾ç¤ºä¸€ä¸ªç®€å•çš„æŸ±çŠ¶å›¾
            if (!mainChart) {
                loadBalanceChart();
            }
        }
        
        // æ›´æ–°å›¾è¡¨æ‘˜è¦
        function updateChartSummary(summary) {
            const container = document.getElementById('chart-summary');
            
            let html = `
                <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                    <div>ğŸ“Š å¹³å‡æ‘„å…¥: <strong>${summary.avg_daily_intake}</strong> åƒå¡/å¤©</div>
                    <div>ğŸ”¥ å¹³å‡æ¶ˆè€—: <strong>${summary.avg_daily_burned}</strong> åƒå¡/å¤©</div>
                    <div>âš–ï¸ å‡€å¹³è¡¡: <strong>${summary.net_balance > 0 ? '+' : ''}${summary.net_balance}</strong> åƒå¡</div>
                </div>
                <div style="margin-top: 8px;">
                    è¶‹åŠ¿: <strong>${getTrendText(summary.weekly_trend)}</strong> | 
                    èµ¤å­—å¤©æ•°: <strong>${summary.deficit_days}</strong> | 
                    ç›ˆä½™å¤©æ•°: <strong>${summary.surplus_days}</strong>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // è·å–è¶‹åŠ¿æ–‡æœ¬
        function getTrendText(trend) {
            const texts = {
                'increasing': 'ä¸Šå‡',
                'decreasing': 'ä¸‹é™', 
                'stable': 'ç¨³å®š'
            };
            return texts[trend] || 'ç¨³å®š';
        }
        
        // åŠ è½½æ¯æ—¥æ•°æ®è¡¨æ ¼
        async function loadDailyData() {
            try {
                const response = await fetch(
                    `${API.base}/api/calories/balance/daily?days=${getDaysFromChartType()}`, {
                    headers: {
                        'Authorization': `Bearer ${Auth.getToken()}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    renderDailyDataTable(result.daily_data);
                    updateStatsGrid(result.summary, result.user_stats);
                }
            } catch (error) {
                console.error('åŠ è½½æ¯æ—¥æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // æ¸²æŸ“æ¯æ—¥æ•°æ®è¡¨æ ¼
        function renderDailyDataTable(dailyData) {
            const tbody = document.getElementById('daily-data-body');
            
            if (!dailyData || dailyData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            ğŸ“Š æš‚æ— æ•°æ®ï¼Œè¯·å…ˆè®°å½•é¥®é£Ÿå’Œè¿åŠ¨~
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = dailyData.map(day => {
                const statusClass = {
                    'deficit': 'status-deficit',
                    'surplus': 'status-surplus',
                    'maintenance': 'status-maintenance'
                }[day.status] || 'status-maintenance';
                
                const statusText = {
                    'deficit': 'èµ¤å­—',
                    'surplus': 'ç›ˆä½™',
                    'maintenance': 'å¹³è¡¡'
                }[day.status] || 'å¹³è¡¡';
                
                const balanceClass = day.balance > 0 ? 'text-success' : 
                                   day.balance < 0 ? 'text-danger' : '';
                
                return `
                    <tr>
                        <td>${day.date_display}${day.is_today ? ' (ä»Šæ—¥)' : ''}</td>
                        <td>${day.intake.toLocaleString()}</td>
                        <td>${day.base_burned.toLocaleString()}</td>
                        <td>${day.exercise_burned.toLocaleString()}</td>
                        <td>${day.total_burned.toLocaleString()}</td>
                        <td class="${balanceClass}">${day.balance > 0 ? '+' : ''}${day.balance.toLocaleString()}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            }).join('');
        }
        
        // æ›´æ–°ç»Ÿè®¡ç½‘æ ¼
        function updateStatsGrid(summary, userStats) {
            const container = document.getElementById('stats-grid');
            
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--primary-color);">
                        ${summary.avg_daily_intake.toLocaleString()}
                    </div>
                    <div class="stat-label">å¹³å‡æ¯æ—¥æ‘„å…¥</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--success-color);">
                        ${summary.avg_daily_burned.toLocaleString()}
                    </div>
                    <div class="stat-label">å¹³å‡æ¯æ—¥æ¶ˆè€—</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: ${summary.net_balance > 0 ? 'var(--success-color)' : 'var(--danger-color)'};">
                        ${summary.net_balance > 0 ? '+' : ''}${summary.net_balance.toLocaleString()}
                    </div>
                    <div class="stat-label">å‡€çƒ­é‡å¹³è¡¡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: ${userStats.has_bmr_data ? 'var(--success-color)' : 'var(--warning-color)'};">
                        ${userStats.estimated_tdee.toLocaleString()}
                    </div>
                    <div class="stat-label">ä¼°ç®—TDEE${userStats.has_bmr_data ? '' : ' (ä¼°ç®—)'}</div>
                </div>
            `;
        }
        
        // æ˜¾ç¤ºå›¾è¡¨é”™è¯¯
        function showChartError(message) {
            const container = document.getElementById('main-chart').parentElement;
            const canvas = document.getElementById('main-chart');
            
            canvas.style.display = 'none';
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'empty-state';
            errorDiv.innerHTML = `
                <div class="empty-state-icon">ğŸ“Š</div>
                <div>${message}</div>
            `;
            
            // ç§»é™¤ç°æœ‰é”™è¯¯ä¿¡æ¯
            const existingError = container.querySelector('.empty-state');
            if (existingError) {
                existingError.remove();
            }
            
            container.appendChild(errorDiv);
        }
        
        // åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadAllData() {
            loadBalanceChart();
            loadDistributionChart();
        }
        
        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        function refreshAllData() {
            Utils.toast('åˆ·æ–°æ•°æ®ä¸­...', 'info');
            loadAllData();
        }
    </script>
</body>
</html>